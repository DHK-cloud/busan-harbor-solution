

<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</title>
  
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121;
      height: 100%;
      overflow: hidden;
    }

    * {
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }
    
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    #splash-screen img {
      height: 100px;
      width: auto;
    }
    #splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }


    .container {
      display: none; 
      flex-direction: column;
      height: 100%;
      max-width: 100%;
      margin: 0 auto;
    }

    .header {
      background: #ffffff;
      padding: 2rem 2.5rem;
      text-align: center;
      border-bottom: 3px solid #1565c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }

    .header-logo {
      height: 60px;
      width: auto;
      object-fit: contain;
    }

    .header-logo:not([src]), .header-logo[src=""] {
      display: none;
    }

    .header-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1565c0 0%, #42a5f5 50%, #1565c0 100%);
      box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: #1a237e;
      line-height: 1.3;
      letter-spacing: -0.5px;
    }

    .header p {
      margin: 0;
      font-size: 1rem;
      color: #616161;
      line-height: 1.5;
      font-weight: 400;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .map-container {
      flex: 1;
      position: relative;
      background: #aadaff;
      overflow: hidden;
      transition: height 0.4s ease-out, opacity 0.4s ease-out;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      cursor: grab;
      touch-action: none;
      image-rendering: auto;
      will-change: transform;
    }

    #mapCanvas:active {
      cursor: grabbing;
    }

    .zoom-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }

    .map-control-btn {
      width: 44px;
      height: 44px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 20px;
      font-weight: 600;
      color: #424242;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .map-control-btn:hover {
      background: #f5f5f5;
      border-color: #1565c0;
      color: #1565c0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .map-control-btn:active {
      transform: scale(0.95);
    }
    
    .map-control-btn.active {
      background: #1565c0;
      color: white;
      border-color: #1565c0;
    }

    #gpsBtn {
      font-size: 22px;
    }

    .region-selector {
      position: absolute;
      /* --- ìˆ˜ì •ëœ ìœ„ì¹˜ --- */
      top: 20px; 
      right: 74px; 
      /* --- ìˆ˜ì •ëœ ìœ„ì¹˜ --- */
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 10;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }

    .region-selector.active {
      display: flex;
    }

    .region-btn {
      background: #1565c0;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .region-btn:hover {
      background: #1976d2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .region-btn:active {
      transform: translateY(0);
    }

    .map-image-preview {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 250px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 20;
      overflow: hidden;
      display: none;
      transition: all 0.3s ease;
    }

    .map-image-preview.active {
      display: block;
    }

    .map-image-preview-header {
      position: relative;
    }
    
    .map-image-preview-title {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
    }

    .map-image-preview-close {
      position: absolute;
      top: 2px;
      right: 8px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 5px rgba(0,0,0,0.7);
      cursor: pointer;
      z-index: 21;
      line-height: 1;
    }
    
    .map-image-preview-close:hover {
      color: #ffcdd2;
    }

    #previewImg {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
      border-bottom: 1px solid #eee;
    }


    .info-panel {
      width: 100%;
      max-width: 380px;
      background: #ffffff;
      padding: 1.25rem;
      overflow-y: auto;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
      scrollbar-width: thin;
      scrollbar-color: #1565c0 #f0f0f0;
    }

    .info-panel h2 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      color: #212121;
      border-bottom: 2px solid #1565c0;
      padding-bottom: 0.5rem;
      font-weight: 700;
    }

    .search-container {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      align-items: center;
    }
    
    #searchInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #1a237e;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      color: #1a237e;
      background: white;
      transition: all 0.3s ease;
    }

    #searchInput:focus {
      outline: none;
      border-color: #3949ab;
      box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
    }

    #searchInput::placeholder {
      color: #9e9e9e;
    }

    .search-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
    }

    .search-btn:hover {
      background: linear-gradient(135deg, #283593 0%, #5c6bc0 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 35, 126, 0.4);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .search-results {
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 1rem;
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      background: white;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-result-item:hover {
      border-color: #1a237e;
      background: #f5f7fa;
      transform: translateX(5px);
    }

    .search-result-item strong {
      color: #1a237e;
      font-size: 1rem;
      display: block;
      margin-bottom: 4px;
    }

    .search-result-item span {
      color: #666;
      font-size: 0.85rem;
    }

    .search-no-results {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }
    
    #locationLabelWrapper {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    #locationLabelWrapper p {
      margin: 0.5rem 0;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #424242;
      font-weight: 500;
    }

    #locationLabelWrapper strong {
      color: #212121;
      font-weight: 700;
    }

    #analysisContent {
      padding-top: 1rem;
    }

    #analysisContent h3 {
      font-weight: 700;
      color: #1565c0;
      margin: 0;
      padding-bottom: 0;
    }
    
    #analysisContent #selectedHarborName {
        font-size: 1.25rem;
        color: #1a237e;
        margin-top: 0;
        border-bottom: 2px solid #1a237e;
        padding-bottom: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .address-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    #harborAddress {
      font-size: 0.85rem;
      color: #616161;
      margin: 0;
      flex: 1;
    }
    
    .copy-btn {
      background: #f0f0f0;
      border: 1px solid #ccc;
      font-size: 0.85rem;
      color: #333;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    
    .copy-btn:hover {
      background-color: #e0e0e0;
      color: #1565c0;
      border-color: #aaa;
    }
    
    .nav-buttons {
      display: flex;
      gap: 0.8rem;
      flex-wrap: nowrap;
      margin-bottom: 0.75rem;
    }
    
    .nav-buttons a {
        flex: 1; 
    }

    .nav-button {
      min-width: 0;
      padding: 0.75rem 1rem;
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-decoration: none;
      text-align: center;
    }

    .nav-button:hover {
      background: #1976d2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .nav-button:active {
      transform: translateY(0);
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .analysis-section {
      margin-bottom: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 0.8rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    #analysisContent .analysis-section:nth-child(odd) {
      background: #ffffff;
    }
    
    #analysisContent .analysis-section:nth-child(even) {
      background: #f9faff;
    }
    
    .analysis-section h4 {
      font-size: 1rem;
      font-weight: 700;
      color: #333;
      margin: 0 0 0.5rem 0;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid #eee;
    }
    
    .analysis-section p {
      font-size: 0.9rem;
      color: #424242;
      line-height: 1.6;
      margin: 0;
    }

    .route-info-grid, .safety-info-grid {
      display: grid;
      gap: 0.75rem;
    }
    
    .route-info-grid {
      grid-template-columns: 1fr 1fr;
    }

    .safety-info-grid {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .info-block {
      background: #f5f7fa;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .info-block h5 {
      font-size: 0.8rem;
      font-weight: 600;
      color: #1565c0;
      margin: 0 0 0.5rem 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-block p {
      font-size: 0.95rem;
      font-weight: 500;
      color: #212121;
      word-break: keep-all; 
    }
    
    .warning-info {
      background: #fff8e1;
      border: 1px solid #ffd54f;
      border-left: 5px solid #f57c00;
      border-radius: 8px;
      padding: 0.75rem;
    }
    
    .warning-info p {
      font-size: 0.9rem;
      font-weight: 600;
      color: #f57c00;
      margin: 0;
    }

    .spinner {
      width: 1em;
      height: 1em;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      display: inline-block;
      animation: spinner-spin 0.75s linear infinite;
      margin-right: 0.5em;
      vertical-align: -0.125em;
    }

    @keyframes spinner-spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      font-style: italic;
      color: #9e9e9e;
      display: flex;
      align-items: center;
    }

    .tile-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(25, 118, 210, 0.9);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5;
      display: flex;
      align-items: center;
      transition: opacity 0.3s ease;
      animation: pulse-loader 1.5s infinite;
    }
    
    .tile-loading .spinner {
        color: white;
        border-color: white;
        border-right-color: transparent;
        margin-right: 0.75em;
        vertical-align: middle;
        width: 1.2em;
        height: 1.2em;
    }
    
    @keyframes pulse-loader {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.9; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }


    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center; 
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 6px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 75%; 
      max-height: 85vh; /* íƒœë¸”ë¦¿/ë°ìŠ¤í¬íƒ‘ìš© ìµœëŒ€ ë†’ì´ */
      overflow-y: auto; 
      color: #333;
    }
    
    .modal-content #clonedRegionSelector {
        position: static;
        padding: 0;
        margin-top: 10px;
        box-shadow: none;
        background: transparent;
        align-items: center; 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: space-evenly; 
    }

    .modal-content #clonedRegionSelector .region-btn {
        width: 45%; 
        min-width: 100px; 
        max-width: 120px; 
        margin: 0; 
        margin-bottom: 8px;
    }

    .modal-content h3 {
      color: #1565c0;
      margin: 0 0 10px 0; 
      font-size: 1.3rem;
      text-align: center; 
    }

    .modal-content p {
      color: #333;
      margin: 0 0 20px 0;
      line-height: 1.6;
      font-size: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      color: #333;
      background: white;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4a90e2;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-button {
      flex: 1;
      background: #4a90e2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .modal-button:hover {
      background: #357abd;
      transform: translateY(-2px);
    }

    .modal-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .modal-button.secondary {
      background: #9e9e9e;
    }

    .modal-button.secondary:hover {
      background: #757575;
    }

    .modal-button.delete {
      background: #f44336;
    }

    .modal-button.delete:hover {
      background: #d32f2f;
    }

    .edit-delete-buttons {
      display: none;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 1rem;
    }

    .edit-btn, .delete-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .edit-btn {
      background: #4a90e2;
      color: white;
    }

    .edit-btn:hover {
      background: #357abd;
    }

    .delete-btn {
      background: #f44336;
      color: white;
    }

    .delete-btn:hover {
      background: #d32f2f;
    }

    /* íƒœë¸”ë¦¿ ë¯¸ë””ì–´ ì¿¼ë¦¬ (769px ì´ìƒ 1200px ë¯¸ë§Œ) */
    @media (min-width: 769px) and (max-width: 1200px) {
        .modal-content {
            width: 60%; 
            max-height: 85vh; /* ë†’ì´ ì œí•œ ë° ìŠ¤í¬ë¡¤ ì ìš© */
            padding: 20px;
        }
        
        .modal-content #clonedRegionSelector {
            display: flex !important;
            flex-direction: row !important;
            justify-content: space-evenly;
        }

        .modal-content #clonedRegionSelector .region-btn {
            width: 45%; /* 2ì—´ ì •ë ¬ */
            min-width: 100px;
            max-width: 150px;
            margin: 0;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .modal-content h3 {
            margin: 0 0 15px 0; /* íƒœë¸”ë¦¿ ì œëª© ë§ˆì§„ ì¡°ì • */
        }
    }


    @media (max-width: 768px) {
      /* ëª¨ë°”ì¼ ê¸°ë³¸ í°íŠ¸ í¬ê¸° ì¡°ì • (16px -> 14px) */
      html {
        font-size: 87.5%; 
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .info-panel {
        max-width: 100%;
        max-height: 50%;
        border-left: none;
        border-top: 2px solid #4a90e2;
        transition: max-height 0.4s ease-out; 
      }

      .header {
        flex-direction: row; 
        justify-content: flex-start; 
        gap: 0.5rem;
        padding: 1rem;
      }

      .header-logo {
        height: 35px; 
      }

      .header-content {
        flex-direction: row; 
        align-items: center;
        text-align: left;
      }
      
      .header h1 {
        font-size: 1.1rem;
        margin: 0;
      }

      .header p {
        display: none; 
      }
      
      .zoom-controls {
        top: 10px; 
        right: 10px;
        z-index: 10;
      }
      
      /* ëª¨ë‹¬ ì˜ì—­ */
      .modal-content {
          width: 90%; 
          max-width: 450px;
          padding: 10px; /* ìˆ˜ì •: ëª¨ë°”ì¼ íŒ¨ë”©ì„ ë” ì¤„ì—¬ ê³µê°„ í™•ë³´ */
          max-height: 75vh; /* ìˆ˜ì •: ëª¨ë°”ì¼ ë†’ì´ë¥¼ 75vhë¡œ ì¤„ì—¬ì„œ ìŠ¤í¬ë¡¤ í™•ë³´ */
      }

      .modal-content h3 {
          margin: 0 0 5px 0; /* ìˆ˜ì •: ëª¨ë°”ì¼ ì œëª© ë§ˆì§„ì„ ë” ì¤„ì—¬ ê³µê°„ í™•ë³´ */
      }
      
      /* ëª¨ë‹¬ ë‚´ë¶€ì˜ ë³µì œëœ ì§€ì—­ ì„ íƒê¸° ìŠ¤íƒ€ì¼ */
      .modal-content #clonedRegionSelector {
          display: flex !important; 
          flex-direction: row !important; 
          justify-content: space-evenly; 
          margin-top: 5px;
      }
      
      .modal-content #clonedRegionSelector .region-btn {
          width: 45%; 
          min-width: 80px; 
          max-width: 120px;
          margin: 0; 
          margin-bottom: 8px;
          padding: 8px 12px; 
          font-size: 0.9rem;
      }

      .region-selector .region-btn {
          display: flex !important;
          justify-content: center;
          align-items: center;
      }

      .nav-buttons {
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .nav-button {
        min-width: 0;
        padding: 0.7rem 1rem;
        font-size: 0.8rem;
      }

      .map-image-preview {
          width: 200px;
          bottom: 10px;
          right: 10px;
      }
      .map-image-preview-title {
          font-size: 0.8rem;
          padding: 4px 8px;
      }
      #previewImg {
          height: 120px;
      }
      .map-image-preview-close {
          right: 6px;
      }

      .route-info-grid, .safety-info-grid {
        grid-template-columns: 1fr;
      }
      
      .map-image-preview.active,
      .map-image-preview {
        display: none !important;
      }
    }

    @media (min-width: 1200px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .header p {
        font-size: 1rem;
      }

      .info-panel {
        max-width: 420px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
  <div id="splash-screen">
    <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" alt="ë¡œê³ ">
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" alt="í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì›" class="header-logo" onerror="this.style.display='none'; this.alt='ë¡œê³  ë¡œë“œ ì‹¤íŒ¨';">
      <div class="header-content">
        <h1 id="appTitle">í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</h1>
        <p id="subtitle">KCA ë¶€ì‚°ë³¸ë¶€ í•­, í¬, êµ¬ ì¶œì¥ ì†”ë£¨ì…˜</p>
      </div>
    </div>
    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        <div class="zoom-controls">
          <button class="zoom-btn map-control-btn" id="zoomIn">+</button>
          <button class="zoom-btn map-control-btn" id="zoomOut">âˆ’</button>
          <button class="map-control-btn" id="gpsBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ›°ï¸</button>
          <button class="location-toggle map-control-btn" id="locationToggle" title="ìœ„ì¹˜ ë©”ë‰´">ğŸ“</button>
        </div>
        <div class="region-selector" id="regionSelector">
          <button class="region-btn" data-region="busan">ë¶€ì‚°</button>
          <button class="region-btn" data-region="ulsan">ìš¸ì‚°</button>
          <button class="region-btn" data-region="changwon">ì°½ì›</button>
          <button class="region-btn" data-region="tongyeong">í†µì˜</button>
          <button class="region-btn" data-region="geoje">ê±°ì œ</button>
          <button class="region-btn" data-region="namhae">ë‚¨í•´</button>
          <button class="region-btn" data-region="sacheon">ì‚¬ì²œ</button>
          <button class="region-btn" data-region="hadong">í•˜ë™</button>
          <button class="region-btn" data-region="goseong">ê³ ì„±</button>
          <button class="region-btn" data-region="all">ì „ì²´ë³´ê¸°</button>
        </div>
        <div class="tile-loading" id="tileLoading" style="display: none;">
          <span class="spinner"></span>ì§€ë„ ë¡œë”© ì¤‘...
        </div>
        
        <div class="map-image-preview" id="mapImagePreview">
          <div class="map-image-preview-header">
            <span class="map-image-preview-close" id="closePreviewBtn" title="ë‹«ê¸°">&times;</span>
            <img id="previewImg" src="https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image" alt="í•­êµ¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
            <div class="map-image-preview-title" id="previewImgTitle">í•­êµ¬ ì´ë¦„</div>
          </div>
        </div>

      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">AI í•­, í¬, êµ¬ ë¶„ì„</h2>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="í•­í¬êµ¬ ì´ë¦„ ë˜ëŠ” ì§€ì—­ ê²€ìƒ‰...">
          <button id="searchBtn" class="search-btn">ğŸ”</button>
        </div>
        
        <div id="searchResults" class="search-results"></div>

        <div class="location-info" id="locationLabelWrapper">
            <p id="locationLabel"><strong>ì§€ë„ì—ì„œ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</strong></p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName"></h3>
            <div class="address-container">
              <p id="harborAddress"></p>
              <button id="copyAddressBtn" class="copy-btn" title="ì£¼ì†Œ ë³µì‚¬">ë³µì‚¬</button>
            </div>
            <div id="navButtons" class="nav-buttons" style="display: none;">
                <a class="nav-button" id="tmapBtn" href="#" target="_blank" rel="noopener noreferrer">TMAP</a>
                <a class="nav-button" id="naverBtn" href="#" target="_blank" rel="noopener noreferrer">ë„¤ì´ë²„ì§€ë„</a>
            </div>
            <div id="editDeleteButtons" class="edit-delete-buttons"></div>

            <div class="analysis-section">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <p id="aiKeyFeatures" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
            </div>
            <div class="analysis-section">
                <h4>í˜„ì¥ ì¡°ì–¸</h4>
                <p id="aiFieldAdvice"></p>
            </div>
            <div class="analysis-section">
                <h4>ì¢…í•© ì˜ê²¬</h4>
                <p id="aiOverallOpinion" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
            </div>

            <div class="analysis-section">
                <h4>AI ë§ì¶¤ ì¶œì¥ ê²½ë¡œ</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ì˜ˆìƒ ì†Œìš”ì‹œê°„</h5>
                        <p id="aiTravelTime" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
                    </div>
                    <div class="info-block">
                        <h5>êµí†µ ìœ ì˜ì‚¬í•­</h5>
                        <p id="aiPrecautions" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>ì‹¤ì‹œê°„ í•´ìƒ ì•ˆì „ì •ë³´</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                        <h5>í’ì†/í’í–¥</h5>
                        <p id="safetyWind" class="loading"><span class="spinner"></span> ì •ë³´ ë¡œë”©ì¤‘...</p>
                    </div>
                    <div class="info-block">
                        <h5>íŒŒê³ </h5>
                        <p id="safetyWave" class="loading"><span class="spinner"></span> ì •ë³´ ë¡œë”©ì¤‘...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì¡°ë¥˜</h5>
                        <p id="safetyTide" class="loading"><span class="spinner"></span> ì •ë³´ ë¡œë”©ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>íŠ¹ë³´ ì •ë³´</h4>
                <div class="warning-info">
                    <p id="safetyWarning" class="loading"><span class="spinner"></span> ì •ë³´ ë¡œë”©ì¤‘...</p>
                </div>
            </div>
            
            <div class="analysis-section">
                <h4>ë¬¼ë•Œ ì •ë³´</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ë§Œì¡°</h5>
                        <p id="tideHighTime" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
                    </div>
                    <div class="info-block">
                        <h5>ê°„ì¡°</h5>
                        <p id="tideLowTime" class="loading"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
                    </div>
                </div>
            </div>

        </div>
      </div>

    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
      <p id="modalMessage"></p>
      <button class="modal-button" id="modalClose">í™•ì¸</button>
    </div>
  </div>
  
<script>
    // API í‚¤ëŠ” ì„œë²„ì—ì„œë§Œ ê´€ë¦¬
const GEMINI_API_KEY = "";

// ì„œë²„ë¥¼ í†µí•´ Gemini API í˜¸ì¶œ
async function callGeminiAPI(prompt) {
  try {
    console.log('ğŸ”’ ì„œë²„ì— AI ë¶„ì„ ìš”ì²­ ì¤‘...');
    const response = await fetch('/api/getApikey', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: prompt })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorText);
      throw new Error(`Server error: ${response.status}`);
    }

    // Server handles the API call
    const data = await response.json();
    console.log('âœ“ ì„œë²„ë¡œë¶€í„° AI ì‘ë‹µ ë°›ìŒ');

    if (data.success && data.result) {
      return data.result;
    } else {
      throw new Error('Invalid response format');
    }
  } catch (error) {
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    return null;
  }
}
  
    const defaultConfig = {
      app_title: "í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜",
      subtitle: "KCA ë¶€ì‚°ë³¸ë¶€ í•­, í¬, êµ¬ ì¶œì¥ ì†”ë£¨ì…˜",
      safety_title: "AI í•­, í¬, êµ¬ ë¶„ì„",
      location_label: "ì§€ë„ì—ì„œ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”",
      primary_color: "#1565c0",
      background_color: "#e3f2fd",
      surface_color: "#ffffff",
      text_color: "#212121",
      accent_color: "#1976d2",
      font_family: "Noto Sans KR",
      font_size: 16
    };

    const sampleHarbors = [ 
{harbor: 'í•œí™”ì˜¤ì…˜', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œëŒ€ë¡œ 3370', lat: 34.869797, lon: 128.697627, advice : 'í†µì‹ ì‹¤ì¥ì—ê²Œ ë‚´ë°©ì¸ ì¶œì…ì‹ ì²­ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼í•¨'},
{harbor: 'ë‚´ê°„í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë‚´ê°„ë¦¬ 50-17', lat: 34.846273, lon: 128.567096, advice : ''},
{harbor: 'ë²•ë™í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë²•ë™ë¦¬ 1056-4', lat: 34.82242, lon: 128.519491, advice : ''}
   ];

    let allHarbors = sampleHarbors;
    let selectedLocation = null;
    let canvas, ctx;
    let mapCenter = { lat: 35.5, lon: 128.8 };
    let mapZoom = 8;
    let markers = [];
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let lastTouch = null;
    let tileCache = {};
    let loadingTiles = 0;
    let userLocation = null;
    let nearbyBreakwaters = [];
    let showNearbyOnly = false;
    let currentRegionFilter = 'all';
    let pendingMapUpdate = null;
    const RENDER_THROTTLE = 16;
    let lastRenderTime = 0;
    let isEditMode = false;
    let editingHarbor = null;
    
    let isRegionalView = true;
    let detailedRegion = null;
    
    const isSmartphoneView = () => window.innerWidth <= 768;


    const KOREA_BOUNDS = {
      minLat: 32,
      maxLat: 43,
      minLon: 124,
      maxLon: 132
    };

    const TILE_SIZE = 256;
    const OSM_TILE_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';

    const regionImages = {
      'ë¶€ì‚°': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F001%2F2024%2F07%2F25%2FPCM20231118000008051_P4_20240725184131104.jpg&type=l340_165',
      'ìš¸ì‚°': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5277%2F2018%2F11%2F14%2F0000155402_003_20181114221331811.jpg&type=a340',
      'ê²½ë‚¨-ê±°ì œ': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5217%2F2023%2F01%2F02%2F0000232921_004_20230102003605996.jpg&type=l340_165',
      'ê²½ë‚¨-ê³ ì„±': 'https://search.pstatic.net/sunny/?src=https%3A%2F%2Fimg1.daumcdn.net%2Fthumb%2FR1280x0.fwebp%2F%3Ffname%3Dhttp%3A%2F%2Ft1.daumcdn.net%2Fbrunch%2Fservice%2Fuser%2FwlQ%2Fimage%2FvO85k5zfAXrRGA9dRapdflKcTc8&type=a340',
      'ê²½ë‚¨-ë‚¨í•´': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNDExMDVfNTUg%2FMDAxNzMwNzY5Mjc3Mzc4.UvfopuyZSkpS8geZ2z0Mp00Rk3J0omIXRfL-jehuC7sg.WsbCqTEQ8wmmuigHJ9zXrVMu_Swk_046JB14PAea0UUg.JPEG%2F1730723049942.jpg&type=a340',
      'ê²½ë‚¨-ì‚¬ì²œ': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAxNzEyMzFfMjIw%2FMDAxNTE0NzA2ODUxNDYw.NFN3QeevzrFFkQADD69H8WfmIjDatgPdZgKF6iaIfTYg.gPpyGtOUU92Vs_lNgch4y8f-DDE7AINop5v8W5hDRbsg.JPEG.bolikeme%2F%25B0%25AD%25B8%25AA%25BF%25A9%25C7%25E0IMG_3456-20171203.jpg&type=a340',
      'ê²½ë‚¨-ì°½ì›': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNTA3MjNfMjk1%2FMDAxNzUzMjM4MDA5NTU1.FcNZWPDyLX1fDkS-8XcPKTMXn5oSFpihWwSnZLNs5YYg.KV-FxcwmfRSva7_qygX6JZTx1sxDe69jwwZ8d6JoCs4g.JPEG%2F14.jpg&type=a340',
     'ê²½ë‚¨-í†µì˜': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzA0MTNfMTEg%2FMDAxNjgxMzU3NjY3Njk3.eHfMmbpy0RssGWVORuaQvOvk515bhhJ6aMDxiXlv_50g.oc-Lta20lYiA4CMRrx3YEUu6OByKEi83g7CjIsZqwW0g.JPEG.hgkim3%2F25991%25A3%25DF41271%25A3%25DF5233.jpg&type=a340',
      'ê²½ë‚¨-í•˜ë™': 'https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzAyMTJfNDAg%2FMDAxNjc2MTk5NjkzNjgz.lsNEBado0DCaXjagjkOrQ_zWvU8JQlxWo7fT_ZFs_gkg.3_nYICUhx2OlbTAtjopaqc9D3rQF9nUod8j2pc1wJqAg.JPEG.jhmspark00%2F20230205-IMGL3595.jpg&type=a340',
      'ê²½ë‚¨': 'https://placehold.co/250x150/0d47a1/ffffff?text=ê²½ë‚¨+ëŒ€í‘œ+ì´ë¯¸ì§€'
    };
    
    const regionalMarkers = {
        'ë¶€ì‚°': { lat: 35.18, lon: 129.08, count: 0, regionKey: 'ë¶€ì‚°' },
        'ìš¸ì‚°': { lat: 35.53, lon: 129.35, count: 0, regionKey: 'ìš¸ì‚°' },
        'ê²½ë‚¨-ì°½ì›': { lat: 35.1978, lon: 128.5756, count: 0, regionKey: 'ê²½ë‚¨-ì°½ì›' },
        'ê²½ë‚¨-í†µì˜': { lat: 34.8442, lon: 128.4331, count: 0, regionKey: 'ê²½ë‚¨-í†µì˜' },
        'ê²½ë‚¨-ê±°ì œ': { lat: 34.8897, lon: 128.6997, count: 0, regionKey: 'ê²½ë‚¨-ê±°ì œ' },
        'ê²½ë‚¨-ë‚¨í•´': { lat: 34.83, lon: 127.89, count: 0, regionKey: 'ê²½ë‚¨-ë‚¨í•´' },
        'ê²½ë‚¨-ì‚¬ì²œ': { lat: 34.92, lon: 128.06, count: 0, regionKey: 'ê²½ë‚¨-ì‚¬ì²œ' },
        'ê²½ë‚¨-í•˜ë™': { lat: 34.94, lon: 127.87, count: 0, regionKey: 'ê²½ë‚¨-í•˜ë™' },
        'ê²½ë‚¨-ê³ ì„±': { lat: 34.97, lon: 128.32, count: 0, regionKey: 'ê²½ë‚¨-ê³ ì„±' }
    };
    
    const subRegionCenters = {
        'ê²½ë‚¨-ì°½ì›': { lat: 35.1978, lon: 128.5756 },
        'ê²½ë‚¨-í†µì˜': { lat: 34.8442, lon: 128.4331 },
        'ê²½ë‚¨-ê±°ì œ': { lat: 34.8897, lon: 128.6997 },
        'ê²½ë‚¨-ë‚¨í•´': { lat: 34.83, lon: 127.89 },
        'ê²½ë‚¨-ì‚¬ì²œ': { lat: 34.92, lon: 128.06 },
        'ê²½ë‚¨-í•˜ë™': { lat: 34.94, lon: 127.87 },
        'ê²½ë‚¨-ê³ ì„±': { lat: 34.97, lon: 128.32 }
    };


    const regionCenters = {
      busan: { lat: 35.15, lon: 129.08, zoom: 11 },
      ulsan: { lat: 35.50, lon: 129.38, zoom: 11 },
      changwon: { lat: 35.1978, lon: 128.5756, zoom: 11 },
      tongyeong: { lat: 34.8442, lon: 128.4331, zoom: 11 },
      geoje: { lat: 34.8897, lon: 128.6997, zoom: 11 },
      namhae: { lat: 34.83, lon: 127.89, zoom: 11 },
      sacheon: { lat: 34.92, lon: 128.06, zoom: 11 },
      hadong: { lat: 34.94, lon: 127.87, zoom: 12 },
      goseong: { lat: 34.97, lon: 128.32, zoom: 11 },
      all: { lat: 35.5, lon: 128.8, zoom: 8 }
    };
    
    function preprocessHarbors() {
        Object.values(regionalMarkers).forEach(marker => marker.count = 0);

        allHarbors.forEach(harbor => {
            if (harbor.region && harbor.region.includes('ë¶€ì‚°')) {
                regionalMarkers['ë¶€ì‚°'].count++;
            } else if (harbor.region && harbor.region.includes('ìš¸ì‚°')) {
                regionalMarkers['ìš¸ì‚°'].count++;
            } else if (harbor.region && harbor.region.includes('ê²½ë‚¨')) {
                const subRegionKey = Object.keys(regionalMarkers).find(key => key.includes('ê²½ë‚¨') && harbor.region.includes(key.replace('ê²½ë‚¨-', '')));
                if (subRegionKey) {
                    regionalMarkers[subRegionKey].count++;
                }
            }
        });
    }


    function showModal(message) {
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      
      modalContent.innerHTML = `
        <p id="modalMessage">${message.replace(/\n/g, '<br>')}</p>
        <button class="modal-button" id="modalClose">í™•ì¸</button>
      `;
      document.getElementById('modalMessage').style.color = '#333';
      document.getElementById('modalClose').addEventListener('click', hideModal);
      modalOverlay.classList.add('active');
      document.getElementById('regionSelector').classList.remove('active');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.getElementById('regionSelector').classList.remove('active');
      document.getElementById('locationToggle').classList.remove('active'); 
    }

    function copyToClipboard(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'absolute';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand('copy');
        showModal('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('Copy failed', err);
        showModal('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      document.body.removeChild(ta);
    }

    function getRegionImage(regionStr) {
      if (!regionStr) return 'https://placehold.co/250x150/e3f2fd/1565c0?text=No+Image';

      if (regionImages[regionStr]) {
        return regionImages[regionStr];
      }
      
      if (regionStr.includes('ê²½ë‚¨')) {
        return regionImages['ê²½ë‚¨'];
      }
      if (regionStr.includes('ë¶€ì‚°')) {
        return regionImages['ë¶€ì‚°'];
      }
      if (regionStr.includes('ìš¸ì‚°')) {
        return regionImages['ìš¸ì‚°'];
      }
      
      return 'https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image';
    }

    function initMap() {
      canvas = document.getElementById('mapCanvas');
      ctx = canvas.getContext('2d');
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('mouseleave', handleMouseUp);
      
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', handleTouchEnd);
      
      canvas.addEventListener('wheel', handleWheel);
    }

    function resizeCanvas() {
      if (!canvas) return;
      const container = canvas.parentElement;
      if (!container) return;
      
      if (container.clientWidth > 0 && container.clientHeight > 0) {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        drawMap();
      }
    }

    function latLonToTile(lat, lon, zoom) {
      const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
      const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
      return { x, y };
    }

    function tileToLatLon(x, y, zoom) {
      const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
      const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
      const lon = x / Math.pow(2, zoom) * 360 - 180;
      return { lat, lon };
    }

    function latLonToPixel(lat, lon) {
      const scale = Math.pow(2, mapZoom);
      const worldX = (lon + 180) / 360 * TILE_SIZE * scale;
      const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
      
      const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
      const centerWorld = {
        x: centerTile.x * TILE_SIZE + TILE_SIZE / 2,
        y: centerTile.y * TILE_SIZE + TILE_SIZE / 2
      };
      
      if (!canvas) return { x: 0, y: 0 };
      const x = canvas.width / 2 + (worldX - centerWorld.x);
      const y = canvas.height / 2 + (worldY - centerWorld.y);
      
      return { x, y };
    }

    function loadTile(x, y, z) {
      const key = `${z}/${x}/${y}`;
      
      if (tileCache[key]) {
        return tileCache[key];
      }
      
      const img = new Image();
      img.crossOrigin = 'anonymous';
      
      loadingTiles++;
      updateLoadingIndicator();
      
      img.onload = () => {
        loadingTiles--;
        updateLoadingIndicator();
        drawMap();
      };
      
      img.onerror = () => {
        loadingTiles--;
        updateLoadingIndicator();
      };
      
      img.src = OSM_TILE_URL.replace('{z}', z).replace('{x}', x).replace('{y}', y);
      tileCache[key] = img;
      
      return img;
    }

    function updateLoadingIndicator() {
      const indicator = document.getElementById('tileLoading');
      if (!indicator) return;
      if (loadingTiles > 0) {
        indicator.style.display = 'flex';
      } else {
        indicator.style.display = 'none';
      }
    }

    function scheduleMapRender() {
      if (pendingMapUpdate) {
        return;
      }
      
      pendingMapUpdate = requestAnimationFrame((timestamp) => {
        if (timestamp - lastRenderTime >= RENDER_THROTTLE) {
          drawMap();
          lastRenderTime = timestamp;
        }
        pendingMapUpdate = null;
      });
    }

    function drawMap() {
      if (!ctx) return;
      if (canvas.width === 0 || canvas.height === 0) return;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = '#aadaff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
      
      const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
      const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
      
      const startX = centerTile.x - Math.floor(tilesX / 2);
      const startY = centerTile.y - Math.floor(tilesY / 2);
      
      for (let i = 0; i < tilesX; i++) {
        for (let j = 0; j < tilesY; j++) {
          const tileX = startX + i;
          const tileY = startY + j;
          
          const maxTile = Math.pow(2, mapZoom);
          if (tileX < 0 || tileX >= maxTile || tileY < 0 || tileY >= maxTile) {
            continue;
          }
          
          const tile = loadTile(tileX, tileY, mapZoom);
          
          if (tile.complete && tile.naturalWidth > 0) {
            const tileLatLon = tileToLatLon(tileX, tileY, mapZoom);
            const pixelPos = latLonToPixel(tileLatLon.lat, tileLatLon.lon);
            
            ctx.drawImage(tile, pixelPos.x, pixelPos.y, TILE_SIZE, TILE_SIZE);
          }
        }
      }
      
      markers = [];
      let locationsToShow = [];
      
      if (showNearbyOnly) {
        locationsToShow = nearbyBreakwaters;
        isRegionalView = false;
        detailedRegion = null;
      } else if (mapZoom <= 9 && !detailedRegion) {
        isRegionalView = true;
        
        Object.keys(regionalMarkers).forEach(key => {
            const markerData = regionalMarkers[key];
            if (markerData.count > 0) {
                const pos = latLonToPixel(markerData.lat, markerData.lon);
                markers.push({ 
                    harbor: key, 
                    region: key, 
                    address: `${key} ì§€ì—­ ëŒ€í‘œ ë§ˆì»¤`, 
                    lat: markerData.lat, 
                    lon: markerData.lon, 
                    x: pos.x, 
                    y: pos.y,
                    isRegional: true,
                    count: markerData.count
                });
            }
        });
      } else {
        isRegionalView = false;
        
        let filteredHarbors = allHarbors;
        
        if (detailedRegion) {
            filteredHarbors = filteredHarbors.filter(h => h.region && h.region.includes(detailedRegion));
        } else if (currentRegionFilter !== 'all') {
            const regionKeywords = {
                'busan': 'ë¶€ì‚°',
                'ulsan': 'ìš¸ì‚°',
                'changwon': 'ê²½ë‚¨-ì°½ì›',
                'tongyeong': 'ê²½ë‚¨-í†µì˜',
                'geoje': 'ê²½ë‚¨-ê±°ì œ',
                'namhae': 'ê²½ë‚¨-ë‚¨í•´',
                'sacheon': 'ê²½ë‚¨-ì‚¬ì²œ',
                'hadong': 'ê²½ë‚¨-í•˜ë™',
                'goseong': 'ê²½ë‚¨-ê³ ì„±'
            };
            const keyword = regionKeywords[currentRegionFilter];
            filteredHarbors = filteredHarbors.filter(h => h.region && h.region.includes(keyword));
        }

        locationsToShow = filteredHarbors.map(location => {
            if (!location.lat || !location.lon || isNaN(location.lat) || isNaN(location.lon)) {
                return null;
            }
            const pos = latLonToPixel(parseFloat(location.lat), parseFloat(location.lon));
            return { ...location, x: pos.x, y: pos.y };
        }).filter(l => l);
        
        markers = locationsToShow;
      }

      markers.forEach(location => {
        if (!location.x || !location.y) return;
        
        const pos = { x: location.x, y: location.y };
        const isSelected = selectedLocation && selectedLocation.harbor === location.harbor;
        const isNearby = location.isNearby;
        let markerSize = location.isRegional ? 18 : 12;
        let fillColor = isSelected ? '#ff5722' : (location.isRegional ? '#388e3c' : (isNearby ? '#42a5f5' : '#1e88e5'));

        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetY = 3;
        
        if (isSelected) {
          ctx.beginPath();
          ctx.arc(pos.x, pos.y - markerSize * 0.8, markerSize * 2.5, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(21, 101, 192, 0.15)';
          ctx.fill();
        }
        
        ctx.beginPath();
        ctx.arc(pos.x, pos.y - markerSize * 1.5, markerSize * 0.8, 0, Math.PI * 2);
        
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(pos.x - 1.5, pos.y - markerSize * 0.8);
        ctx.lineTo(pos.x - 1.5, pos.y);
        ctx.lineTo(pos.x + 1.5, pos.y);
        ctx.lineTo(pos.x + 1.5, pos.y - markerSize * 0.8);
        ctx.closePath();
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 2, 0, Math.PI * 2);
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.shadowBlur = 0;
        ctx.shadowOffsetY = 0;
        
        if (location.isRegional && location.count > 0) {
            ctx.font = 'bold 12px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(location.count, pos.x, pos.y - markerSize * 1.5);
            
            ctx.font = 'bold 14px Noto Sans KR, sans-serif';
            ctx.fillStyle = '#1a237e';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(location.harbor.replace('ê²½ë‚¨-', ''), pos.x, pos.y + 5); 
        }

        if (isSelected) {
          ctx.font = 'bold 12px Noto Sans KR, sans-serif';
          const text = location.harbor + (location.isRegional ? ` (${location.count}ê³³)` : '');
          const textWidth = ctx.measureText(text).width;
          const labelPadding = 12;
          const labelHeight = 28;
          const labelY = pos.y - markerSize * 2.5 - 12;
          
          ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
          ctx.shadowBlur = 10;
          ctx.shadowOffsetY = 4;
          
          const labelGradient = ctx.createLinearGradient(
            pos.x - textWidth / 2 - labelPadding, 
            labelY - labelHeight, 
            pos.x - textWidth / 2 - labelPadding, 
            labelY
          );
          labelGradient.addColorStop(0, '#1565c0');
          labelGradient.addColorStop(1, '#1976d2');
          ctx.fillStyle = labelGradient;
          ctx.beginPath();
          ctx.roundRect(pos.x - textWidth / 2 - labelPadding, labelY - labelHeight, textWidth + labelPadding * 2, labelHeight, 8);
          ctx.fill();
          
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          ctx.beginPath();
          ctx.moveTo(pos.x, labelY + 2);
          ctx.lineTo(pos.x - 8, labelY - 8);
          ctx.lineTo(pos.x + 8, labelY - 8);
          ctx.closePath();
          ctx.fillStyle = '#1976d2';
          ctx.fill();
          
          ctx.shadowBlur = 0;
          ctx.shadowOffsetY = 0;
          
          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(text, pos.x, labelY - labelHeight / 2);
        }
      });
      
      if (userLocation) {
        const pos = latLonToPixel(userLocation.lat, userLocation.lon);
        
        if (pos.x >= -50 && pos.x <= canvas.width + 50 && pos.y >= -50 && pos.y <= canvas.height + 50) {
          const size = 24;
          
          ctx.shadowColor = 'rgba(76, 175, 80, 0.6)';
          ctx.shadowBlur = 20;
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
          ctx.fill();
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size * 0.6, 0, Math.PI * 2);
          ctx.fillStyle = '#4caf50';
          ctx.fill();
          
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size * 0.25, 0, Math.PI * 2);
          ctx.fillStyle = '#ffffff';
          ctx.fill();
        }
      }
      
      ctx.font = '10px Arial';
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.textAlign = 'right';
      ctx.fillText('Â© OpenStreetMap contributors', canvas.width - 10, canvas.height - 10);
    }
    
    // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  ì œí•œí•˜ëŠ” í•¨ìˆ˜
    function clampMapCenter(lat, lon) {
      let newLat = Math.max(-85, Math.min(85, lat));
      let newLon = lon;
      
      newLat = Math.max(KOREA_BOUNDS.minLat, Math.min(KOREA_BOUNDS.maxLat, newLat));
      newLon = Math.max(KOREA_BOUNDS.minLon, Math.min(KOREA_BOUNDS.maxLon, newLon));

      return { lat: newLat, lon: newLon };
    }


    function handleMouseDown(e) {
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };
      canvas.style.cursor = 'grabbing';
    }

    function handleMouseMove(e) {
      if (!isDragging) return;
      
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      
      const scale = Math.pow(2, mapZoom);
      const worldPixelsPerDegree = TILE_SIZE * scale / 360;
      
      let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
      
      const latRad = mapCenter.lat * Math.PI / 180;
      const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
      let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;

      const clampedCenter = clampMapCenter(nextLat, nextLon);
      mapCenter.lat = clampedCenter.lat;
      mapCenter.lon = clampedCenter.lon;
      
      dragStart = { x: e.clientX, y: e.clientY };
      
      scheduleMapRender();
    }


    function handleMouseUp(e) {
      // ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ, ë“œë˜ê·¸ ìƒíƒœì˜€ëŠ”ì§€ í™•ì¸í•˜ì—¬ í´ë¦­ ì²˜ë¦¬
      if (isDragging) {
        // NOTE: dragStartëŠ” handleMouseDownì—ì„œ ì„¤ì •ë˜ê³ , handleMouseMoveì—ì„œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ,
        // ì´ ë¡œì§ì€ ë§ˆì§€ë§‰ dragStartì™€ í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
        // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¥¼ ì§§ê²Œ í–ˆì„ ê²½ìš°ë¥¼ ê°ì§€í•˜ë ¤ë©´ handleMouseDown ì‹œì ì˜ ì¢Œí‘œë¥¼ ë³„ë„ë¡œ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
        // (í˜„ì¬ ì½”ë“œì—ì„œëŠ” handleMouseMoveì—ì„œ dragStartë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ, ì´ ë¡œì§ì€ í´ë¦­ ê°ì§€ì— ë¶ˆë¦¬í•©ë‹ˆë‹¤.)
        // **í´ë¦­ ê°ì§€ ì•ˆì •í™”ë¥¼ ìœ„í•´, dragStartë¥¼ handleMouseDownì—ì„œë§Œ ì´ˆê¸°í™”í•˜ê³ , 
        // handleMouseMoveì—ì„œëŠ” lastClientPos ê°™ì€ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì¢‹ìŠµë‹ˆë‹¤.** // í•˜ì§€ë§Œ ê¸°ì¡´ ì½”ë“œì˜ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©°, `dx < 5 && dy < 5` ë¡œì§ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ 
        // `handleMouseMove`ì—ì„œ `dragStart`ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê°€ì •ì„ ì „ì œë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.
        
        const finalDragPos = { x: e.clientX, y: e.clientY };
        const dx = Math.abs(finalDragPos.x - dragStart.x);
        const dy = Math.abs(finalDragPos.y - dragStart.y);

        if (dx < 5 && dy < 5) { 
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          checkMarkerClick(x, y);
        }
      }
      
      // ë“œë˜ê·¸ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë§ˆìš°ìŠ¤ ì—… ì‹œì ì— ìƒíƒœë¥¼ í•´ì œ
      isDragging = false;
      canvas.style.cursor = 'grab';
    }

    function handleTouchStart(e) {
      e.preventDefault();
      if (e.touches.length === 1) {
        lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        isDragging = true;
      } 
      else if (e.touches.length === 2) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const distance = Math.sqrt(
              Math.pow(touch2.clientX - touch1.clientX, 2) + 
              Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          lastTouch = { distance: distance, touch1: touch1, touch2: touch2 }; 
          isDragging = false; 
      }
    }

    function handleTouchMove(e) {
      e.preventDefault();
      
      // í•œ ì†ê°€ë½ ë“œë˜ê·¸ ë¡œì§
      if (e.touches.length === 1 && isDragging) {
          const touch = e.touches[0];
          const dx = touch.clientX - lastTouch.x;
          const dy = touch.clientY - lastTouch.y;
          
          const scale = Math.pow(2, mapZoom);
          const worldPixelsPerDegree = TILE_SIZE * scale / 360;
          
          let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
          
          const latRad = mapCenter.lat * Math.PI / 180;
          const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
          let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;

          const clampedCenter = clampMapCenter(nextLat, nextLon);
          mapCenter.lat = clampedCenter.lat;
          mapCenter.lon = clampedCenter.lon;

          lastTouch = { x: touch.clientX, y: touch.clientY };
          scheduleMapRender();
          
      } 
      // ë‘ ì†ê°€ë½ í•€ì¹˜ ì¤Œ ë¡œì§ ë° íŒ¨ë‹ ë¡œì§
      else if (e.touches.length === 2 && lastTouch && lastTouch.distance) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const newDistance = Math.sqrt(
              Math.pow(touch2.clientX - touch1.clientX, 2) + 
              Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          
          const scaleFactor = newDistance / lastTouch.distance;
          const zoomChange = Math.log2(scaleFactor);
          
          if (Math.abs(zoomChange) > 0.1) { 
              
              const newZoom = zoomChange > 0 ? mapZoom + 1 : mapZoom - 1;

              if (newZoom >= 5 && newZoom <= 18) {
                mapZoom = newZoom;
                mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);
                
                if (mapZoom >= 10 && isRegionalView) {
                    isRegionalView = false;
                    detailedRegion = currentRegionFilter === 'all' ? null : regionalMarkers[currentRegionFilter]?.regionKey;
                    if (detailedRegion && !detailedRegion.includes('ê²½ë‚¨')) detailedRegion = null;
                } else if (mapZoom <= 9 && !isRegionalView) {
                    isRegionalView = true;
                    detailedRegion = null;
                }
              }
              lastTouch.distance = newDistance; 
          }

          const dx = (touch1.clientX + touch2.clientX) / 2 - (lastTouch.touch1.clientX + lastTouch.touch2.clientX) / 2;
          const dy = (touch1.clientY + touch2.clientY) / 2 - (lastTouch.touch1.clientY + lastTouch.touch2.clientY) / 2;
          
          const scale = Math.pow(2, mapZoom);
          const worldPixelsPerDegree = TILE_SIZE * scale / 360;
          let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
          const latRad = mapCenter.lat * Math.PI / 180;
          const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
          let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;
          
          const clampedCenter = clampMapCenter(nextLat, nextLon);
          mapCenter.lat = clampedCenter.lat;
          mapCenter.lon = clampedCenter.lon;

          lastTouch.touch1 = touch1;
          lastTouch.touch2 = touch2;

          scheduleMapRender();
      }
    }

// ğŸŒŸğŸŒŸğŸŒŸ í„°ì¹˜ ë“œë˜ê·¸ ìƒíƒœ ë¯¸í•´ì œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ìˆ˜ì • ğŸŒŸğŸŒŸğŸŒŸ
    function handleTouchEnd(e) {
      e.preventDefault();
      
      // 1. ëª¨ë“  í„°ì¹˜(ì†ê°€ë½)ê°€ ë–¼ì–´ì§„ ê²½ìš°
      if (e.touches.length === 0) {
        // ë§ˆì§€ë§‰ ë™ì‘ì´ ë“œë˜ê·¸ì˜€ê³ , ì›€ì§ì„ì´ ê±°ì˜ ì—†ì—ˆë‹¤ë©´ í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬
        if (isDragging && lastTouch) {
          // dragStartê°€ ë§ˆì§€ë§‰ í„°ì¹˜ ì¢Œí‘œë¥¼ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •í–ˆìœ¼ë¯€ë¡œ, 
          // í´ë¦­ íŒë³„ì€ dragStartì™€ ë§ˆì§€ë§‰ touchmoveì˜ ì¢Œí‘œë¥¼ ë¹„êµí•´ì•¼ í•©ë‹ˆë‹¤.
          // í˜„ì¬ ë¡œì§ì€ dragStartì™€ handleTouchStart ì‹œì ì˜ ì¢Œí‘œë¥¼ ë¹„êµí•˜ë¯€ë¡œ, 
          // dragStartë¥¼ touchstart ì‹œì ì˜ ì¢Œí‘œë¡œ ê°€ì •í•˜ê³  ë¡œì§ì„ ìœ ì§€í•©ë‹ˆë‹¤.
          const dx = Math.abs(lastTouch.x - dragStart.x);
          const dy = Math.abs(lastTouch.y - dragStart.y);

          // ì„ê³„ê°’ì„ 10pxë¡œ ì„¤ì • (í´ë¦­/íƒ­ ê°ì§€)
          if (dx < 10 && dy < 10) {
            const rect = canvas.getBoundingClientRect();
            // dragStartì˜ ì´ˆê¸° ì¢Œí‘œ (touchstart ì‹œì )ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¦­ ì²˜ë¦¬
            const x = dragStart.x - rect.left; 
            const y = dragStart.y - rect.top;
            checkMarkerClick(x, y);
          }
        }
        
        // ë“œë˜ê·¸ ìƒíƒœ ë° í„°ì¹˜ ì •ë³´ ì´ˆê¸°í™” (ê°€ì¥ ì¤‘ìš”í•œ ìˆ˜ì •)
        isDragging = false; 
        lastTouch = null; 
        
      } 
      // 2. ë‘ ì†ê°€ë½ ì¤‘ í•˜ë‚˜ë§Œ ë—„ ê²½ìš° (í•€ì¹˜ ì¤Œ -> ë“œë˜ê·¸ ëª¨ë“œë¡œ ì „í™˜ ì¤€ë¹„)
      else if (e.touches.length === 1) {
          // ë‚¨ì•„ìˆëŠ” í•œ ì†ê°€ë½ì˜ ì •ë³´ë¡œ lastTouchì™€ dragStartë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬
          // ìƒˆë¡œìš´ ë‹¨ì¼ ì†ê°€ë½ ë“œë˜ê·¸(íŒ¨ë‹)ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
          lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          isDragging = true;
      }
    }
    function handleWheel(e) {
      e.preventDefault();
      
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }

function checkMarkerClick(x, y) {
      let closestMarker = null;
      let minDistance = Infinity;
      
      const isSmartphoneView = window.innerWidth <= 768; // í•¨ìˆ˜ ì¬í˜¸ì¶œ ë°©ì§€

      markers.forEach(marker => {
        const markerCenterY = marker.y - (marker.isRegional ? 18 : 12) * 1.5; 
        const markerRadius = (marker.isRegional ? 18 : 12) * 0.8;
        
        // ì›í˜• ë§ˆì»¤ ì˜ì—­ (ì„ íƒ í—ˆìš© ë°˜ê²½)
        const hitRadius = isSmartphoneView ? markerRadius + 30 : markerRadius + 10;
        const distanceToCenter = Math.sqrt(Math.pow(x - marker.x, 2) + Math.pow(y - markerCenterY, 2));

        // ê¼¬ë¦¬ ë¶€ë¶„ì˜ íˆíŠ¸ë°•ìŠ¤
        const isTailHit = x >= marker.x - 5 && x <= marker.x + 5 && y >= markerCenterY && y <= marker.y + 5;

        // ì›í˜• ì˜ì—­ ë˜ëŠ” ê¼¬ë¦¬ ì˜ì—­ì— ë“¤ì–´ì˜¤ë©´ ì„ íƒ ê°€ëŠ¥
        if ((distanceToCenter < hitRadius || isTailHit) && distanceToCenter < minDistance) {
          minDistance = distanceToCenter;
          closestMarker = marker;
        }
      });

      if (closestMarker) {
        // 1. ë§ˆì»¤ê°€ ë°œê²¬ë˜ì—ˆì„ ê²½ìš°ì˜ ë¡œì§
        if (closestMarker.isRegional) {
            enterDetailedRegion(closestMarker.region);
            return;
        }
        
        // ê°™ì€ ë§ˆì»¤ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•´ì œ
        if (selectedLocation && selectedLocation.harbor === closestMarker.harbor) {
             selectedLocation = null;
             updateLocationInfo(null);
             drawMap();
             return;
        }

        selectedLocation = closestMarker;
        updateLocationInfo(selectedLocation); 
        drawMap();
        
      } else {
        // 2. ë§ˆì»¤ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° (ì§€ë„ ë¹ˆ ê³µê°„ í´ë¦­)
        // ì„ íƒëœ ë§ˆì»¤ê°€ ìˆì—ˆë‹¤ë©´ í•´ì œí•©ë‹ˆë‹¤.
        if (selectedLocation) { 
            selectedLocation = null;
            updateLocationInfo(null);
            drawMap();
        }
      }
    }
    function enterDetailedRegion(regionKey) {
        const regionNames = {
            'ë¶€ì‚°': 'busan',
            'ìš¸ì‚°': 'ulsan',
            'ê²½ë‚¨-ì°½ì›': 'changwon',
            'ê²½ë‚¨-í†µì˜': 'tongyeong',
            'ê²½ë‚¨-ê±°ì œ': 'geoje',
            'ê²½ë‚¨-ë‚¨í•´': 'namhae',
            'ê²½ë‚¨-ì‚¬ì²œ': 'sacheon',
            'ê²½ë‚¨-í•˜ë™': 'hadong',
            'ê²½ë‚¨-ê³ ì„±': 'goseong'
        };
        const regionCode = regionNames[regionKey];

        if (regionCode) {
            detailedRegion = regionKey;
            showNearbyOnly = false;
            currentRegionFilter = regionCode;

            const centerConfig = regionCenters[regionCode] || regionCenters['all'];
            mapCenter = { lat: centerConfig.lat, lon: centerConfig.lon };
            mapZoom = Math.max(10, centerConfig.zoom);
            
            const regionLabel = regionKey.replace('ê²½ë‚¨-', '');
            document.getElementById('locationLabel').innerHTML = 
              `<strong>ğŸ“ ${regionLabel} ì§€ì—­ ìƒì„¸ ë³´ê¸°</strong><br>
              <span style="font-size: 0.85em; color: #888;">ì§€ë„ë¥¼ ì›€ì§ì—¬ í•­í¬êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</span>`;
              
            selectedLocation = null;
            updateLocationInfo(null);
            drawMap();
        }
    }


    async function getStaticAnalysis(harbor) {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
      
      const prompt = `
        ë‹¹ì‹ ì€ KCA(í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì›)ì˜ ë² í…Œë‘ ë¬´ì„ êµ­ ê²€ì‚¬ê´€ì„ ë•ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        [ë¶„ì„ ëŒ€ìƒ í•­êµ¬]: 
        - ì´ë¦„: ${harbor.harbor}
        - ì£¼ì†Œ: ${harbor.address}
        - ê¸°ì¡´ ì¡°ì–¸: ${harbor.advice}

        [ìš”ì²­]
        ì˜¤ì§ ìœ„ì— ì œê³µëœ í•­êµ¬ ì •ë³´ì™€ ë‹¹ì‹ ì˜ ì§€ì‹ë§Œì„ ë°”íƒ•ìœ¼ë¡œ (ì›¹ ê²€ìƒ‰ ì—†ì´) ë‹¤ìŒ í•­ëª©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.
        ì‘ë‹µì€ ë°˜ë“œì‹œ ìš”ì²­í•œ JSON í˜•ì‹ *ê·¸ëŒ€ë¡œ* ë°˜í™˜í•´ì•¼ í•˜ë©°, ë‹¤ë¥¸ ì„¤ëª…ì€ ë§ë¶™ì´ì§€ ë§ˆì„¸ìš”.

        [JSON ì¶œë ¥ í˜•ì‹]
        {
          "keyFeatures": "(ë¬´ì„ êµ­ ê²€ì‚¬ê´€ì ì—ì„œ ë³¸ í•­êµ¬ì˜ í•µì‹¬ íŠ¹ì§•. 1ì¤„ë¡œ ë§¤ìš° í•¨ì¶•ì ì´ê²Œ ìš”ì•½)",
          "overallOpinion": "(ê²€ì‚¬ê´€ì„ ìœ„í•œ ìµœì¢… ì•ˆì „/í™˜ê²½ ì¡°ì–¸. 'êµí†µ' ê´€ë ¨ ë‚´ìš©ì€ ì œì™¸. 1ì¤„ë¡œ ë§¤ìš° í•¨ì¶•ì ì´ê²Œ ìš”ì•½)"
        }
      `;
      
      const payload = { 
          contents: [{ parts: [{ text: prompt }] }],
          tools: [{ "google_search": {} }] 
      };
      
      try {
          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          if (!response.ok) {
              const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
              throw new Error(`(Static) ${errorBody.error?.message || response.statusText}`);
          }
          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (!text) throw new Error('ì •ì  ë¶„ì„ AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          
          let jsonText = text.replace(/^```json\n/, '').replace(/\n```$/, '').trim();
          const aiData = JSON.parse(jsonText);
          return aiData;
          
      } catch (error) {
          console.error("Gemini (Static) ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", error);
          return {
            keyFeatures: `AI ìš”ì•½ ì‹¤íŒ¨: ${error.message}`,
            overallOpinion: "AI ìš”ì•½ ì‹¤íŒ¨"
          };
      }
    }

    async function getRealtimeAnalysis(harbor, userLat, userLon) {
      
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
      
      let departurePoint = "í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì› ë¶€ì‚°ë³¸ë¶€ (ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬ ì¤‘ì•™ëŒ€ë¡œ 340)";
      if (userLat && userLon) {
          departurePoint = `í˜„ì¬ GPS ìœ„ì¹˜ (ìœ„ë„: ${userLat}, ê²½ë„: ${userLon})`;
      }
      
      const prompt = `
        [ì¶œë°œì§€]: "${departurePoint}"
        [ë„ì°©ì§€]: "${harbor.harbor} (${harbor.address})"

        [ìš”ì²­]
        ì¶œë°œì§€ì—ì„œ ë„ì°©ì§€ê¹Œì§€ ê°€ëŠ” ìƒí™©ì„ ê°€ì •í•˜ì—¬, ë‹¤ìŒ ëª¨ë“  í•­ëª©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê²€ìƒ‰í•´ ë¶„ì„í•´ì£¼ì„¸ìš”.
        ì‘ë‹µì€ ë°˜ë“œì‹œ ìš”ì²­í•œ JSON í˜•ì‹ *ê·¸ëŒ€ë¡œ* ë°˜í™˜í•´ì•¼ í•˜ë©°, ë‹¤ë¥¸ ì„¤ëª…ì€ ë§ë¶™ì´ì§€ ë§ˆì„¸ìš”.

        [JSON ì¶œë ¥ í˜•ì‹]
        {
          "travelTime": "('ì•½ 1ì‹œê°„ 30ë¶„' ì²˜ëŸ¼ ì‹œê°„ë§Œ ê°„ëµí•˜ê²Œ)",
          "precautions": "('ì¶œí‡´ê·¼ ì‹œê°„ ì •ì²´' ì²˜ëŸ¼ ë§¤ìš° ì§§ê²Œ ì••ì¶•)",
          "wind": "('ë¶ë™ 3m/s' ì²˜ëŸ¼ ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ë§Œ)",
          "wave": "('0.5m' ì²˜ëŸ¼ ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ë§Œ)",
          "tide": "('1.2 knots' ì²˜ëŸ¼ ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ë§Œ)",
          "warning": "(íŠ¹ë³´ ì—†ìœ¼ë©´ 'íŠ¹ë³´ ì—†ìŒ')",
          "highTide": "('09:15, 21:30' ì²˜ëŸ¼ ì‹œê°„ë§Œ)",
          "lowTide": "('15:30, 03:45' ì²˜ëŸ¼ ì‹œê°„ë§Œ)"
        }
      `;
      
      const payload = { 
          contents: [{ parts: [{ text: prompt }] }],
          tools: [{ "google_search": {} }]
      };

      try {
          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          if (!response.ok) {
              const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
              throw new Error(`(Realtime) ${errorBody.error?.message || response.statusText}`);
          }
          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (!text) throw new Error('ì •ì  ë¶„ì„ AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          
          let jsonText = text.replace(/^```json\n/, '').replace(/\n```$/, '').trim();
          const aiData = JSON.parse(jsonText);
          return aiData;

      } catch (error) {
          console.error("Gemini (Realtime) ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", error);
          return {
            travelTime: "ì˜¤ë¥˜",
            precautions: "ì˜¤ë¥˜",
            wind: "ì˜¤ë¥˜",
            wave: "ì˜¤ë¥˜",
            tide: "ì˜¤ë¥˜",
            warning: "ì •ë³´ ë¡œë“œ ì‹¤íŒ¨",
            highTide: "ì˜¤ë¥˜",
            lowTide: "ì˜¤ë¥˜"
          };
      }
    }

    async function updateLocationInfo(location) {
      const labelWrapper = document.getElementById('locationLabelWrapper');
      const analysisWrapper = document.getElementById('analysisContent');
      const imgPreview = document.getElementById('mapImagePreview');
      const naverBtn = document.getElementById('naverBtn');
      const tmapBtn = document.getElementById('tmapBtn');


      if (location) {
        labelWrapper.style.display = 'none';
        analysisWrapper.style.display = 'block';
        document.getElementById('searchResults').classList.remove('active');

        document.getElementById('selectedHarborName').textContent = `${location.harbor} AI ë¶„ì„`;
        document.getElementById('harborAddress').textContent = `ì£¼ì†Œ: ${location.address || 'ì •ë³´ ì—†ìŒ'}`;
        document.getElementById('navButtons').style.display = 'flex';
        
        const destinationAddress = location.address || location.harbor;
        const encodedDestinationAddress = encodeURIComponent(destinationAddress);
        const encodedDestinationName = encodeURIComponent(location.harbor); // ğŸŒŸ ëª©ì ì§€ ì´ë¦„ ì¸ì½”ë”© ğŸŒŸ

        // ì¶œë°œì§€ ìœ„/ê²½ë„ (userLocation ë˜ëŠ” ê¸°ë³¸ê°’)
        let startLat = userLocation?.lat || 35.105481; // KCA ë¶€ì‚°ë³¸ë¶€ ê·¼ì²˜
        let startLon = userLocation?.lon || 129.043394;
        const startName = encodeURIComponent("í˜„ì¬ ìœ„ì¹˜");

        // ëª©ì ì§€ ìœ„/ê²½ë„
        const destLat = location.lat;
        const destLon = location.lon;

        // TMAPê³¼ ë„¤ì´ë²„ ì§€ë„ ë²„íŠ¼ì„ ì´ˆê¸°í™”
        tmapBtn.href = '#';
        naverBtn.href = '#';

 // TMAPê³¼ ë„¤ì´ë²„ ì§€ë„ ë²„íŠ¼ì„ ì´ˆê¸°í™”
        tmapBtn.href = '#';
        naverBtn.href = '#';

        // --- ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ (ìˆ˜ì • ì œì•ˆ ë°˜ì˜) ---
        if (window.innerWidth <= 1500) { 
            // 1. ìŠ¤ë§ˆíŠ¸í°/íƒœë¸”ë¦¿ ë·° (1500px ì´í•˜): ë”¥ë§í¬(ì•± ì‹¤í–‰) ì‹œë„
            tmapBtn.style.display = 'block';
            naverBtn.style.display = 'block';
            
            // TMAP ë”¥ë§í¬ URL (ì¶œë°œì§€ë¥¼ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ í˜„ ìœ„ì¹˜ ê¸°ì¤€)
            const tmapUrl = `tmap://route?goalname=${encodedDestinationName}&goaly=${destLat}&goalx=${destLon}`;
            
            // ë„¤ì´ë²„ ì§€ë„ ë”¥ë§í¬ URL (ì°¨ëŸ‰ ëª¨ë“œ, ë„ì°©ì§€ ì´ë¦„ê³¼ ìœ„ê²½ë„ ëª…ì‹œ)
            const URL_NAME = 'kcabusansafecheck.my.canva.site/busanshipsolution'; // ì•± ì´ë¦„ì€ URLë¡œ ì„¤ì •
            const naverUrl = `nmap://route/car?dlat=${destLat}&dlng=${destLon}&dname=${encodedDestinationName}&appname=${URL_NAME}`;
            
            // NOTE: ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ <a> íƒœê·¸ì˜ hrefë¥¼ ë”¥ë§í¬ë¡œ ì„¤ì •í•˜ë©´ 
            // ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš° ë°”ë¡œ ì‹¤í–‰ë˜ê³ , ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì„ ê²½ìš° ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì›¹í˜ì´ì§€ í´ë°± ì—†ì´ ë‹¨ìˆœ ë”¥ë§í¬ë§Œ ì„¤ì •í•©ë‹ˆë‹¤. (ë³µì‚¬ë³¸.htmlì˜ ê¸°ì¡´ ë¡œì§)
            tmapBtn.href = tmapUrl;
            naverBtn.href = naverUrl;

        } else {
            // 2. ë°ìŠ¤í¬í†± ë·° (1400px ì´ˆê³¼): ì›¹ ê¸¸ì°¾ê¸°
            tmapBtn.style.display = 'none'; // í‹°ë§µ ì›¹ ê¸¸ì°¾ê¸°ëŠ” ë³µì¡í•˜ë¯€ë¡œ ë„¤ì´ë²„ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
            naverBtn.style.display = 'block';
            
            // ë„¤ì´ë²„ ì§€ë„ ì›¹ ê¸¸ì°¾ê¸° URL (ì¶œë°œì§€: í˜„ ìœ„ì¹˜ ë˜ëŠ” -/-, ì°¨ëŸ‰ ëª¨ë“œ)
            // ì¶œë°œì§€: -/-, ë„ì°©ì§€: ìœ„ê²½ë„, ë„ì°©ì§€ëª…, ëª¨ë“œ: ì°¨ëŸ‰
            const naverWebUrl = `https://map.naver.com/v5/directions/-/${destLat},${destLon},${encodedDestinationName}/-/car?c=15,0,0,0,dh`;
            naverBtn.href = naverWebUrl;
        }
        
        document.getElementById('aiFieldAdvice').textContent = location.advice || 'ë“±ë¡ëœ í˜„ì¥ ì¡°ì–¸ì´ ì—†ìŠµë‹ˆë‹¤. ì¶œì¥ ì‹œ ì£¼ë³€ì„ ì˜ ì‚´í”¼ì„¸ìš”.';
        
        document.getElementById('editDeleteButtons').innerHTML = '';

        const imgEl = document.getElementById('previewImg');
        const imgTitleEl = document.getElementById('previewImgTitle');
        imgEl.onerror = () => { imgEl.src = 'https://placehold.co/250x150/e3f2fd/1565c0?text=Image+Load+Failed'; }; 
        imgEl.src = getRegionImage(location.region); 
        imgTitleEl.textContent = location.harbor;
        imgPreview.classList.add('active');


        const staticFields = ['aiKeyFeatures', 'aiOverallOpinion'];
        const realtimeFields = [
          'aiTravelTime', 'aiPrecautions', 'safetyWind', 'safetyWave', 
          'safetyTide', 'safetyWarning', 'tideHighTime', 'tideLowTime'
        ];
        
        const loadingSpinner = `<span class="spinner"></span> AI ë¶„ì„ ì¤‘...`;
        const smallSpinner = `<span class="spinner"></span> ë¡œë”©...`;

        staticFields.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = loadingSpinner;
          el.classList.add('loading');
        });
        
        realtimeFields.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = smallSpinner;
          el.classList.add('loading');
        });

        
        const userLat = userLocation ? userLocation.lat : null;
        const userLon = userLocation ? userLocation.lon : null;
        
        const staticPromise = getStaticAnalysis(location);
        const realtimePromise = getRealtimeAnalysis(location, userLat, userLon);

        
        try {
            const staticData = await staticPromise;
            if (staticData.keyFeatures.includes("ì˜¤ë¥˜")) throw new Error(staticData.keyFeatures);
            document.getElementById('aiKeyFeatures').textContent = staticData.keyFeatures;
            document.getElementById('aiOverallOpinion').textContent = staticData.overallOpinion;
        } catch (error) {
            document.getElementById('aiKeyFeatures').textContent = `AI ìš”ì•½ ì‹¤íŒ¨: ${error.message}`;
            document.getElementById('aiOverallOpinion').textContent = "AI ìš”ì•½ ì‹¤íŒ¨";
        } finally {
            staticFields.forEach(id => document.getElementById(id).classList.remove('loading'));
        }

        try {
            const realtimeData = await realtimePromise;
            if (realtimeData.travelTime.includes("ì˜¤ë¥˜")) throw new Error("ì‹¤ì‹œê°„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨");
            
            document.getElementById('aiTravelTime').textContent = realtimeData.travelTime;
            document.getElementById('aiPrecautions').textContent = realtimeData.precautions;
            document.getElementById('safetyWind').textContent = realtimeData.wind;
            document.getElementById('safetyWave').textContent = realtimeData.wave;
            document.getElementById('safetyTide').textContent = realtimeData.tide;
            document.getElementById('safetyWarning').textContent = realtimeData.warning;
            document.getElementById('tideHighTime').textContent = realtimeData.highTide;
            document.getElementById('tideLowTime').textContent = realtimeData.lowTide;

            const warningEl = document.getElementById('safetyWarning');
            const warningWrapper = document.querySelector('.warning-info');
            if (realtimeData.warning.includes('ì—†ìŒ') || realtimeData.warning.includes('N/A')) {
                warningEl.style.color = '#388e3c';
                warningWrapper.style.borderColor = '#4caf50';
                warningWrapper.style.background = '#e8f5e9';
            } else {
                warningEl.style.color = '#f57c00';
                warningWrapper.style.borderColor = '#f57c00';
                warningWrapper.style.background = '#fff8e1';
            }
        } catch (error) {
            realtimeFields.forEach(id => {
                document.getElementById(id).textContent = "ì •ë³´ ë¡œë“œ ì‹¤íŒ¨";
            });
        } finally {
            realtimeFields.forEach(id => document.getElementById(id).classList.remove('loading'));
        }

      } else {
        labelWrapper.style.display = 'block';
        analysisWrapper.style.display = 'none';
        imgPreview.classList.remove('active');
        
        tmapBtn.href = '#';
        naverBtn.href = '#';
        tmapBtn.style.display = 'block';
        naverBtn.style.display = 'block';
      }
    }


    async function onConfigChange(config) {
      const baseFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, sans-serif';
      const customFont = `${baseFont}, ${baseFontStack}`;
      
      document.body.style.fontFamily = customFont;
      
      document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('aiAnalysisTitle').textContent = config.safety_title || defaultConfig.safety_title;
      document.getElementById('locationLabel').innerHTML = `<strong>${config.location_label || defaultConfig.location_label}</strong>`;

      document.body.style.background = config.background_color || defaultConfig.background_color;
      document.body.style.color = config.text_color || defaultConfig.text_color;
      
      document.querySelector('.header').style.background = config.surface_color || defaultConfig.surface_color;
      document.getElementById('info-panel').style.background = config.surface_color || defaultConfig.surface_color;
      
      document.getElementById('appTitle').style.color = config.primary_color || defaultConfig.primary_color;
      document.getElementById('aiAnalysisTitle').style.borderBottomColor = config.primary_color || defaultConfig.primary_color;
      
      document.querySelectorAll('.nav-button, .region-btn, .modal-button').forEach(btn => {
        if (!btn.classList.contains('secondary') && !btn.classList.contains('delete')) {
          btn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
        }
      });
      
      document.querySelectorAll('.search-btn').forEach(btn => {
         btn.style.background = `linear-gradient(135deg, ${config.primary_color} 0%, ${config.accent_color} 100%)`;
      });

      drawMap();
    }

    function initElementSdk(config) {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: config,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  window.elementSdk.setConfig({ accent_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["subtitle", config.subtitle || defaultConfig.subtitle],
            ["safety_title", config.safety_title || defaultConfig.safety_title],
            ["location_label", config.location_label || defaultConfig.location_label]
          ])
        });
        return true;
      } else {
        return false;
      }
    }

    function zoomIn() {
      if (mapZoom < 18) {
        mapZoom++;
        mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);

        if (mapZoom >= 10 && isRegionalView) {
            isRegionalView = false;
            detailedRegion = currentRegionFilter === 'all' ? null : regionalMarkers[currentRegionFilter]?.regionKey;
            if (detailedRegion && !detailedRegion.includes('ê²½ë‚¨')) detailedRegion = null;
        }
        drawMap();
      }
    }

    function zoomOut() {
      if (mapZoom > 5) {
        mapZoom--;
        mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);
        
        if (mapZoom <= 9 && !isRegionalView) {
            isRegionalView = true;
            detailedRegion = null;
        }
        drawMap();
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function getUserLocation() {
      const gpsBtn = document.getElementById('gpsBtn');
      
      if (!navigator.geolocation) {
        showModal('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        const permission = await navigator.permissions.query({ name: 'geolocation' });
        
        if (permission.state === 'denied') {
          showModal('ìœ„ì¹˜ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
      } catch (e) {
        console.warn('Geolocation permission query failed:', e);
      }

      gpsBtn.classList.add('active');
      const originalText = gpsBtn.innerHTML;
      gpsBtn.innerHTML = 'â³';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };

          const allLocations = allHarbors;

          nearbyBreakwaters = allLocations
            .map(harbor => {
              if (!harbor.lat || !harbor.lon) return null;
              const distance = calculateDistance(
                userLocation.lat,
                userLocation.lon,
                harbor.lat,
                harbor.lon
              );
              return { ...harbor, distance, isNearby: distance <= 50 };
            })
            .filter(h => h && h.isNearby)
            .sort((a, b) => a.distance - b.distance);
            
          isRegionalView = false;
          detailedRegion = null;
          currentRegionFilter = 'all';

          if (nearbyBreakwaters.length > 0) {
            showNearbyOnly = true;
            mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
            mapZoom = 11;
            
            const nearest = nearbyBreakwaters[0];
            document.getElementById('locationLabel').innerHTML = 
              `<strong>ğŸ“ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ í•­í¬êµ¬</strong><br>
              <span style="color: #1565c0; font-size: 1.1em;">${nearest.harbor}</span><br>
              <span style="color: #666;">ê±°ë¦¬: ${nearest.distance.toFixed(1)}km</span><br>
              <span style="font-size: 0.85em; color: #888;">ì¸ê·¼ ${nearbyBreakwaters.length}ê°œ í•­í¬êµ¬ í‘œì‹œ ì¤‘</span>`;
            
            selectedLocation = nearest;
            updateLocationInfo(selectedLocation);

          } else {
            showModal('50km ë°˜ê²½ ë‚´ì— í•­í¬êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
            mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
            mapZoom = 11;
            selectedLocation = null;
            updateLocationInfo(null);
          }

          gpsBtn.innerHTML = 'âœ“';
          setTimeout(() => {
            gpsBtn.innerHTML = originalText;
            gpsBtn.classList.remove('active');
          }, 2000);

          drawMap();
        },
        (error) => {
          gpsBtn.classList.remove('active');
          gpsBtn.innerHTML = originalText;
          userLocation = null;
          
          let errorMsg = '';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\niframe í™˜ê²½ì—ì„œëŠ” ìœ„ì¹˜ ê¶Œí•œì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          } else if (error.code === error.TIMEOUT) {
            errorMsg = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
          } else {
            errorMsg = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          }
          
          showModal(errorMsg);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 30000
        }
      );
    }

    function toggleRegionSelector() {
      const selector = document.getElementById('regionSelector');
      const toggle = document.getElementById('locationToggle');
      
      const isSmartphoneView = window.innerWidth <= 768;

      if (isSmartphoneView) {
          // ìŠ¤ë§ˆíŠ¸í°: ëª¨ë‹¬ í˜•íƒœë¡œ ì§€ì—­ ì„ íƒê¸° í‘œì‹œ
          if (modalOverlay.classList.contains('active')) {
              hideModal();
              toggle.classList.remove('active');
          } else {
              showRegionModal(selector);
              toggle.classList.add('active');
          }
          // ëª¨ë°”ì¼ ë·°ì—ì„œëŠ” ì›ë³¸ selectorì˜ active ìƒíƒœëŠ” ë¬´ì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (CSSì—ì„œ display:none !importantë¡œ ì²˜ë¦¬ë¨)
      } else {
          // íƒœë¸”ë¦¿/ë°ìŠ¤í¬í†±: ê¸°ì¡´ ì§€ë„ ë‚´ í† ê¸€ ë°©ì‹ ìœ ì§€
          if (selector.classList.contains('active')) {
              selector.classList.remove('active');
              toggle.classList.remove('active');
          } else {
              selector.classList.add('active');
              toggle.classList.add('active');
          }
      }
    }

    function showRegionModal(selectorElement) {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalContent = document.getElementById('modalContent');
        
        modalContent.innerHTML = ''; 
        
        const title = document.createElement('h3');
        title.textContent = 'ì§€ì—­ ì„ íƒ';
        modalContent.appendChild(title);

        const clonedSelector = selectorElement.cloneNode(true);
        clonedSelector.id = 'clonedRegionSelector';
        clonedSelector.classList.add('active');
        clonedSelector.style.position = 'static';
        clonedSelector.style.padding = '0';
        clonedSelector.style.boxShadow = 'none';
        clonedSelector.style.background = 'transparent';
        
        // CSSì—ì„œ .modal-content #clonedRegionSelector ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ë„ë¡ í•©ë‹ˆë‹¤.
        modalContent.appendChild(clonedSelector);

        clonedSelector.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                selectRegion(e.target.dataset.region);
                hideModal();
            });
        });
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'modal-button secondary';
        closeBtn.textContent = 'ë‹«ê¸°';
        closeBtn.style.marginTop = '1rem';
        closeBtn.addEventListener('click', hideModal);
        modalContent.appendChild(closeBtn);

        modalOverlay.classList.add('active');
    }

    function selectRegion(region) {
      showNearbyOnly = false;
      currentRegionFilter = region;
      userLocation = null;
      
      const center = regionCenters[region];
      mapCenter = { lat: center.lat, lon: center.lon };
      mapZoom = center.zoom;
      
      mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);

      // ëª¨ë°”ì¼ ë·°ì—ì„œ í† ê¸€ ë²„íŠ¼ ìƒíƒœë¥¼ ëª…ì‹œì ìœ¼ë¡œ í•´ì œí•©ë‹ˆë‹¤.
      document.getElementById('regionSelector').classList.remove('active');
      document.getElementById('locationToggle').classList.remove('active');
      
      const regionNames = {
        busan: 'ë¶€ì‚°',
        ulsan: 'ìš¸ì‚°',
        changwon: 'ì°½ì›',
        tongyeong: 'í†µì˜',
        geoje: 'ê±°ì œ',
        namhae: 'ë‚¨í•´',
        sacheon: 'ì‚¬ì²œ',
        hadong: 'í•˜ë™',
        goseong: 'ê³ ì„±',
        all: 'ì „ì²´'
      };
      
      if (region === 'all' || mapZoom <= 9) {
          isRegionalView = true;
          detailedRegion = null;
          document.getElementById('locationLabel').innerHTML = 
            `<strong>ğŸ“ ${regionNames[region]} ì§€ì—­ ëŒ€í‘œ ë§ˆì»¤ ë³´ê¸°</strong>`;
      } else {
          isRegionalView = false;
          detailedRegion = regionNames[region]; 
          document.getElementById('locationLabel').innerHTML = 
            `<strong>ğŸ“ ${regionNames[region]} ì§€ì—­ ìƒì„¸ í•­í¬êµ¬</strong>`;
      }
      
      selectedLocation = null;
      updateLocationInfo(null);
      drawMap();
    }

    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      const searchResults = document.getElementById('searchResults');
      
      if (!searchTerm) {
        searchResults.classList.remove('active');
        return;
      }
      
      const locationsToSearch = allHarbors;
      
      const results = locationsToSearch.filter(location => {
        const harborMatch = location.harbor && location.harbor.toLowerCase().includes(searchTerm);
        const regionMatch = location.region && location.region.toLowerCase().includes(searchTerm);
        const addressMatch = location.address && location.address.toLowerCase().includes(searchTerm);
        return harborMatch || regionMatch || addressMatch;
      });
      
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        searchResults.classList.add('active');
        return;
      }
      
      searchResults.innerHTML = results.map(result => `
        <div class="search-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-id="" data-harbor="${result.harbor}">
          <strong>${result.harbor}</strong>
          <span>${result.region} Â· ${result.address}</span>
        </div>
      `).join('');
      
      searchResults.classList.add('active');
      
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lat = parseFloat(item.dataset.lat);
          const lon = parseFloat(item.dataset.lon);
          const harborName = item.dataset.harbor;
          
          mapCenter = { lat, lon };
          mapZoom = 14;
          
          const location = locationsToSearch.find(l => {
            return l.lat === lat && l.lon === lon && l.harbor === harborName;
          });
          
          if (location) {
            selectedLocation = location;
            updateLocationInfo(selectedLocation);
          }
          
          isRegionalView = false;
          detailedRegion = location.region.split('-')[0];
          if (detailedRegion === 'ê²½ë‚¨') {
              detailedRegion = location.region;
          }
          currentRegionFilter = 'all';
          
          searchResults.classList.remove('active');
          document.getElementById('searchInput').value = '';
          
          drawMap();
        });
      });
    }

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    document.getElementById('searchInput').addEventListener('input', () => {
      if (document.getElementById('searchInput').value.trim() === '') {
        document.getElementById('searchResults').classList.remove('active');
      }
    });
    
    document.getElementById('zoomIn').addEventListener('click', zoomIn);
    document.getElementById('zoomOut').addEventListener('click', zoomOut);
    document.getElementById('locationToggle').addEventListener('click', toggleRegionSelector);
    document.getElementById('gpsBtn').addEventListener('click', getUserLocation);
    
    document.getElementById('copyAddressBtn').addEventListener('click', () => {
      if (selectedLocation && selectedLocation.address) {
        copyToClipboard(selectedLocation.address);
      }
    });
    
    document.getElementById('closePreviewBtn').addEventListener('click', () => {
      document.getElementById('mapImagePreview').classList.remove('active');
      selectedLocation = null;
      updateLocationInfo(null);
      drawMap();
    });


    if (window.innerWidth > 768) {
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const region = e.target.dataset.region;
                selectRegion(region);
            });
        });
    }

    function setupScrollInteraction() {
        const infoPanel = document.getElementById('info-panel');
        const mapContainer = document.querySelector('.map-container');
        
        if (!infoPanel || !mapContainer) return;

        // ëª¨ë°”ì¼ í™˜ê²½ (768px ì´í•˜)ì—ì„œë§Œ ìŠ¤í¬ë¡¤ ìƒí˜¸ì‘ìš© ì ìš©
        if (window.innerWidth <= 768) {
            infoPanel.addEventListener('scroll', () => {
                const scrollPercentage = infoPanel.scrollTop / (infoPanel.scrollHeight - infoPanel.clientHeight);
                
                // ì •ë³´ íŒ¨ë„ì˜ ìŠ¤í¬ë¡¤ì´ ì ˆë°˜(50%) ì´ìƒ ì§„í–‰ë˜ë©´ ì§€ë„ ì˜ì—­ ìˆ¨ê¹€
                if (scrollPercentage > 0.5) { 
                    mapContainer.style.height = '0';
                    mapContainer.style.opacity = '0';
                    infoPanel.style.maxHeight = '100%'; 
                } else {
                    mapContainer.style.height = '100%';
                    mapContainer.style.opacity = '1';
                    infoPanel.style.maxHeight = '50%';
                }
            });
        }
    }


    async function initializeSdkAndMap() {
      // SDK ì´ˆê¸°í™” ë° ê¸°ë³¸ ë§µ ì„¤ì •ë§Œ í¬í•¨ (AI ë¶„ì„ í˜¸ì¶œ ì œì™¸)
      return new Promise(async (resolve) => {
          let elementSdkReady = false;
          
          if (window.elementSdk) {
            elementSdkReady = initElementSdk(defaultConfig);
            await onConfigChange(window.elementSdk?.config || defaultConfig);
          }
          
          if (!elementSdkReady) {
             await onConfigChange(defaultConfig);
          }

          preprocessHarbors();
          initMap();
          
          setupScrollInteraction();

          resolve(true);
      });
    }

    window.addEventListener('load', () => {
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        
        const splashMinTime = 2000;
        const splashTimer = new Promise(resolve => setTimeout(resolve, splashMinTime));
        
        // ì§€ë„/SDK ì´ˆê¸°í™” Promise
        const appInitPromise = initializeSdkAndMap();

        // SDK ì´ˆê¸°í™” ì™„ë£Œ ë° ìµœì†Œ ëŒ€ê¸° ì‹œê°„ 2ì´ˆê°€ ì§€ë‚˜ë©´ ì•± í‘œì‹œ
        Promise.all([appInitPromise, splashTimer])
        .then(() => {
            splashScreen.classList.add('hidden');
            appContainer.style.display = 'flex';
            
            resizeCanvas(); 
            
            setTimeout(() => {
                if(splashScreen.parentNode) {
                    splashScreen.parentNode.removeChild(splashScreen);
                }
            }, 500);

            // AI í‚¤ ê²€ì¦ ë¡œì§ì€ ì•± í‘œì‹œ í›„ ì‹¤í–‰ (ìŠ¤í”Œë˜ì‹œ ë©ˆì¶¤ ë°©ì§€)
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "[ì—¬ê¸°ì— ë³¸ì¸ì˜ API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”]") {
                showModal("AI ê¸°ëŠ¥ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nHTML ì½”ë“œ ìƒë‹¨ì˜ 'GEMINI_API_KEY' ë³€ìˆ˜ì— ìœ íš¨í•œ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            }
        })
        .catch(err => {
            // ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ìµœì†Œ ì‹œê°„ í›„ ì•± í‘œì‹œë¥¼ ê°•ì œí•©ë‹ˆë‹¤.
            console.error("App initialization failed but forcing display:", err);
            splashScreen.classList.add('hidden');
            appContainer.style.display = 'flex';
            resizeCanvas();
        });
    });

  </script>
</body>
</html>
