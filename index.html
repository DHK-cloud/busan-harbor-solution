<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>부산 항·포·구 안전 정보</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet, 스타일 등 기존 CSS는 그대로 두면 됨 -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
    }

    #app {
      display: flex;
      height: 100vh;
    }

    #map {
      flex: 2;
    }

    #ai-panel {
      flex: 1;
      border-left: 1px solid #ddd;
      padding: 12px;
      box-sizing: border-box;
      overflow-y: auto;
      background: #fafafa;
    }

    #ai-panel h3 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    .ai-box {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 12px;
      background: #fff;
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 지도 영역 -->
    <div id="map"></div>

    <!-- 오른쪽 AI 패널 -->
    <div id="ai-panel">
      <h3>AI 항·포·구 분석</h3>

      <h4>정적 분석</h4>
      <div id="ai-static" class="ai-box">항만을 클릭하면 정적 분석이 표시됩니다.</div>

      <h4>실시간 분석</h4>
      <div id="ai-realtime" class="ai-box">
        항만을 클릭하면 실시간/위험 분석이 표시됩니다.
      </div>
    </div>
  </div>

  <!-- Leaflet JS (지도용) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /*************************************************
     * 0. 지도 초기화 (기존 코드와 연결해서 사용)
     *************************************************/
    const map = L.map('map').setView([35.1, 129.04], 11); // 부산 근처

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // 예시 마커 (실제 데이터에 맞게 교체)
    const exampleMarker = L.marker([35.1, 129.04]).addTo(map);
    exampleMarker.bindPopup('부산항(예시)');

    /*************************************************
     * 1. 공통 Gemini 호출 함수 (서버 경유)
     *************************************************/
    async function callGeminiAPI(prompt) {
      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const data = await response.json();

        if (!data.success) {
          console.error('Gemini API 오류:', data);
          throw new Error(data.error || data.message || 'Gemini API failed');
        }

        return data.result;
      } catch (error) {
        console.error('API 호출 실패:', error);
        throw error;
      }
    }

    /*************************************************
     * 2. Static / Realtime 분석 함수
     *************************************************/
    async function getStaticAnalysis(staticPrompt) {
      try {
        const prompt = `[Static 분석]\n${staticPrompt}`;
        const resultText = await callGeminiAPI(prompt);
        return resultText;
      } catch (error) {
        console.error('Gemini (Static) 분석 중 오류:', error);
        throw error;
      }
    }

    async function getRealtimeAnalysis(realtimePrompt) {
      try {
        const prompt = `[Realtime 분석]\n${realtimePrompt}`;
        const resultText = await callGeminiAPI(prompt);
        return resultText;
      } catch (error) {
        console.error('Gemini (Realtime) 분석 중 오류:', error);
        throw error;
      }
    }

    /*************************************************
     * 3. 클릭 시 오른쪽 패널 갱신
     *************************************************/
    async function updateLocationInfo(harborName, staticPrompt, realtimePrompt) {
      const staticEl = document.querySelector('#ai-static');
      const realtimeEl = document.querySelector('#ai-realtime');

      if (staticEl) staticEl.innerText = '정적 분석 중...';
      if (realtimeEl) realtimeEl.innerText = '실시간 분석 중...';

      try {
        const [staticText, realtimeText] = await Promise.all([
          getStaticAnalysis(staticPrompt),
          getRealtimeAnalysis(realtimePrompt)
        ]);

        if (staticEl) staticEl.innerText = staticText;
        if (realtimeEl) realtimeEl.innerText = realtimeText;
      } catch (error) {
        if (staticEl) staticEl.innerText = '정적 분석 실패';
        if (realtimeEl) realtimeEl.innerText = '실시간 분석 실패';
      }
    }

    /*************************************************
     * 4. 마커 클릭 이벤트 예시
     *    (실제 항만 리스트 루프에서 같은 패턴으로 호출)
     *************************************************/
    exampleMarker.on('click', () => {
      const harborName = '부산항';

      const staticPrompt =
        `${harborName}의 위치, 항로 구조, 접안 시설, ` +
        `평균 기상·해양 특성, 교통량, 계절별 특징을 ` +
        `선박 안전 관점에서 요약해줘.`;

      const realtimePrompt =
        `${harborName}에 입출항하는 선박이 즉시 주의해야 할 ` +
        `위험 요소들(기상 특보, 해무, 강풍, 조류, 혼잡 해역 등)을 ` +
        `항해사에게 브리핑하듯이 설명해줘.`;

      updateLocationInfo(harborName, staticPrompt, realtimePrompt);
    });
  </script>
</body>
</html>
