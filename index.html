<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ìï¥Ïñë Ïä§ÎßàÌä∏ Ï∂úÏû• ÏÜîÎ£®ÏÖò</title>
  
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121;
      height: 100%;
      overflow: hidden;
    }

    * {
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }
    
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    #splash-screen img {
      height: 100px;
      width: auto;
    }
    #splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }


    .container {
      display: none; 
      flex-direction: column;
      height: 100%;
      max-width: 100%;
      margin: 0 auto;
    }

    .header {
      background: #ffffff;
      padding: 2rem 2.5rem;
      text-align: center;
      border-bottom: 3px solid #1565c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }

    .header-logo {
      height: 60px;
      width: auto;
      object-fit: contain;
    }

    .header-logo:not([src]), .header-logo[src=""] {
      display: none;
    }

    .header-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1565c0 0%, #42a5f5 50%, #1565c0 100%);
      box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: #1a237e;
      line-height: 1.3;
      letter-spacing: -0.5px;
    }

    .header p {
      margin: 0;
      font-size: 1rem;
      color: #616161;
      line-height: 1.5;
      font-weight: 400;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .map-container {
      flex: 1;
      position: relative;
      background: #aadaff;
      overflow: hidden;
      transition: height 0.4s ease-out, opacity 0.4s ease-out;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      cursor: grab;
      touch-action: none;
      image-rendering: auto;
      will-change: transform;
    }

    #mapCanvas:active {
      cursor: grabbing;
    }

    .zoom-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }

    .map-control-btn {
      width: 44px;
      height: 44px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 20px;
      font-weight: 600;
      color: #424242;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .map-control-btn:hover {
      background: #f5f5f5;
      border-color: #1565c0;
      color: #1565c0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .map-control-btn:active {
      transform: scale(0.95);
    }
    
    .map-control-btn.active {
      background: #1565c0;
      color: white;
      border-color: #1565c0;
    }

    #gpsBtn {
      font-size: 22px;
    }

    .region-selector {
      position: absolute;
      top: 20px; 
      right: 74px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 10;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }

    .region-selector.active {
      display: flex;
    }

    .region-btn {
      background: #1565c0;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .region-btn:hover {
      background: #1976d2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .region-btn:active {
      transform: translateY(0);
    }

    .map-image-preview {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 250px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 20;
      overflow: hidden;
      display: none;
      transition: all 0.3s ease;
    }

    .map-image-preview.active {
      display: block;
    }

    .map-image-preview-header {
      position: relative;
    }
    
    .map-image-preview-title {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
    }

    .map-image-preview-close {
      position: absolute;
      top: 2px;
      right: 8px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 5px rgba(0,0,0,0.7);
      cursor: pointer;
      z-index: 21;
      line-height: 1;
    }
    
    .map-image-preview-close:hover {
      color: #ffcdd2;
    }

    #previewImg {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
      border-bottom: 1px solid #eee;
    }


    .info-panel {
      width: 100%;
      max-width: 380px;
      background: #ffffff;
      padding: 1.25rem;
      overflow-y: auto;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
      scrollbar-width: thin;
      scrollbar-color: #1565c0 #f0f0f0;
    }

    .info-panel h2 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      color: #212121;
      border-bottom: 2px solid #1565c0;
      padding-bottom: 0.5rem;
      font-weight: 700;
    }

    .search-container {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      align-items: center;
    }
    
    #searchInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #1a237e;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      color: #1a237e;
      background: white;
      transition: all 0.3s ease;
    }

    #searchInput:focus {
      outline: none;
      border-color: #3949ab;
      box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
    }

    #searchInput::placeholder {
      color: #9e9e9e;
    }

    .search-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
    }

    .search-btn:hover {
      background: linear-gradient(135deg, #283593 0%, #5c6bc0 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 35, 126, 0.4);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .search-results {
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 1rem;
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      background: white;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-result-item:hover {
      border-color: #1a237e;
      background: #f5f7fa;
      transform: translateX(5px);
    }

    .search-result-item strong {
      color: #1a237e;
      font-size: 1rem;
      display: block;
      margin-bottom: 4px;
    }

    .search-result-item span {
      color: #666;
      font-size: 0.85rem;
    }

    .search-no-results {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }
    
    #locationLabelWrapper {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    #locationLabelWrapper p {
      margin: 0.5rem 0;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #424242;
      font-weight: 500;
    }

    #locationLabelWrapper strong {
      color: #212121;
      font-weight: 700;
    }

    #analysisContent {
      padding-top: 1rem;
    }

    #analysisContent h3 {
      font-weight: 700;
      color: #1565c0;
      margin: 0;
      padding-bottom: 0;
    }
    
    #analysisContent #selectedHarborName {
        font-size: 1.25rem;
        color: #1a237e;
        margin-top: 0;
        border-bottom: 2px solid #1a237e;
        padding-bottom: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .address-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    #harborAddress {
      font-size: 0.85rem;
      color: #616161;
      margin: 0;
      flex: 1;
    }
    
    .copy-btn {
      background: #f0f0f0;
      border: 1px solid #ccc;
      font-size: 0.85rem;
      color: #333;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    
    .copy-btn:hover {
      background-color: #e0e0e0;
      color: #1565c0;
      border-color: #aaa;
    }
    
    .nav-buttons {
      display: flex;
      gap: 0.8rem;
      flex-wrap: nowrap;
      margin-bottom: 0.75rem;
    }
    
    .nav-buttons a {
        flex: 1;
    }

    .nav-button {
      min-width: 0;
      padding: 0.75rem 1rem;
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-decoration: none;
      text-align: center;
    }

    .nav-button:hover {
      background: #1976d2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .nav-button:active {
      transform: translateY(0);
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .analysis-section {
      margin-bottom: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 0.8rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    #analysisContent .analysis-section:nth-child(odd) {
      background: #ffffff;
    }
    
    #analysisContent .analysis-section:nth-child(even) {
      background: #f9faff;
    }
    
    .analysis-section h4 {
      font-size: 1rem;
      font-weight: 700;
      color: #333;
      margin: 0 0 0.5rem 0;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid #eee;
    }
    
    .analysis-section p {
      font-size: 0.9rem;
      color: #424242;
      line-height: 1.6;
      margin: 0;
    }

    .route-info-grid, .safety-info-grid {
      display: grid;
      gap: 0.75rem;
    }
    
    .route-info-grid {
      grid-template-columns: 1fr 1fr;
    }

    .safety-info-grid {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .info-block {
      background: #f5f7fa;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .info-block h5 {
      font-size: 0.8rem;
      font-weight: 600;
      color: #1565c0;
      margin: 0 0 0.5rem 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-block p {
      font-size: 0.95rem;
      font-weight: 500;
      color: #212121;
      word-break: keep-all; 
    }
    
    .warning-info {
      background: #fff8e1;
      border: 1px solid #ffd54f;
      border-left: 5px solid #f57c00;
      border-radius: 8px;
      padding: 0.75rem;
    }
    
    .warning-info p {
      font-size: 0.9rem;
      font-weight: 600;
      color: #f57c00;
      margin: 0;
    }

    .spinner {
      width: 1em;
      height: 1em;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      display: inline-block;
      animation: spinner-spin 0.75s linear infinite;
      margin-right: 0.5em;
      vertical-align: -0.125em;
    }

    @keyframes spinner-spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      font-style: italic;
      color: #9e9e9e;
      display: flex;
      align-items: center;
    }

    .tile-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(25, 118, 210, 0.9);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5;
      display: flex;
      align-items: center;
      transition: opacity 0.3s ease;
      animation: pulse-loader 1.5s infinite;
    }
    
    .tile-loading .spinner {
        color: white;
        border-color: white;
        border-right-color: transparent;
        margin-right: 0.75em;
        vertical-align: middle;
        width: 1.2em;
        height: 1.2em;
    }
    
    @keyframes pulse-loader {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.9; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }


    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center; 
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 6px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 75%; 
      max-height: 85vh;
      overflow-y: auto; 
      color: #333;
    }
    
    .modal-content #clonedRegionSelector {
        position: static;
        padding: 0;
        margin-top: 10px;
        box-shadow: none;
        background: transparent;
        align-items: center; 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: space-evenly;
    }

    .modal-content #clonedRegionSelector .region-btn {
        width: 45%; 
        min-width: 100px;
        max-width: 120px; 
        margin: 0; 
        margin-bottom: 8px;
    }

    .modal-content h3 {
      color: #1565c0;
      margin: 0 0 10px 0; 
      font-size: 1.3rem;
      text-align: center; 
    }

    .modal-content p {
      color: #333;
      margin: 0 0 20px 0;
      line-height: 1.6;
      font-size: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      color: #333;
      background: white;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4a90e2;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-button {
      flex: 1;
      background: #4a90e2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .modal-button:hover {
      background: #357abd;
      transform: translateY(-2px);
    }

    .modal-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .modal-button.secondary {
      background: #9e9e9e;
    }

    .modal-button.secondary:hover {
      background: #757575;
    }

    .modal-button.delete {
      background: #f44336;
    }

    .modal-button.delete:hover {
      background: #d32f2f;
    }

    .edit-delete-buttons {
      display: none;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 1rem;
    }

    .edit-btn, .delete-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .edit-btn {
      background: #4a90e2;
      color: white;
    }

    .edit-btn:hover {
      background: #357abd;
    }

    .delete-btn {
      background: #f44336;
      color: white;
    }

    .delete-btn:hover {
      background: #d32f2f;
    }

    /* ÌÉúÎ∏îÎ¶ø ÎØ∏ÎîîÏñ¥ ÏøºÎ¶¨ (769px Ïù¥ÏÉÅ 1200px ÎØ∏Îßå) */
    @media (min-width: 769px) and (max-width: 1200px) {
        .modal-content {
            width: 60%;
            max-height: 85vh; 
            padding: 20px;
        }
        
        .modal-content #clonedRegionSelector {
            display: flex !important;
            flex-direction: row !important;
            justify-content: space-evenly;
        }

        .modal-content #clonedRegionSelector .region-btn {
            width: 45%;
            min-width: 100px;
            max-width: 150px;
            margin: 0;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .modal-content h3 {
            margin: 0 0 15px 0;
        }
    }


    @media (max-width: 768px) {
      html {
        font-size: 87.5%;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .info-panel {
        max-width: 100%;
        max-height: 50%;
        border-left: none;
        border-top: 2px solid #4a90e2;
        transition: max-height 0.4s ease-out;
      }

      .header {
        flex-direction: row; 
        justify-content: flex-start;
        gap: 0.5rem;
        padding: 1rem;
      }

      .header-logo {
        height: 35px;
      }

      .header-content {
        flex-direction: row; 
        align-items: center;
        text-align: left;
      }
      
      .header h1 {
        font-size: 1.1rem;
        margin: 0;
      }

      .header p {
        display: none;
      }
      
      .zoom-controls {
        top: 10px;
        right: 10px;
        z-index: 10;
      }
      
      .modal-content {
          width: 90%;
          max-width: 450px;
          padding: 10px; 
          max-height: 75vh;
      }

      .modal-content h3 {
          margin: 0 0 5px 0;
      }
      
      .modal-content #clonedRegionSelector {
          display: flex !important;
          flex-direction: row !important; 
          justify-content: space-evenly; 
          margin-top: 5px;
      }
      
      .modal-content #clonedRegionSelector .region-btn {
          width: 45%;
          min-width: 80px; 
          max-width: 120px;
          margin: 0; 
          margin-bottom: 8px;
          padding: 8px 12px; 
          font-size: 0.9rem;
      }

      .region-selector .region-btn {
          display: flex !important;
          justify-content: center;
          align-items: center;
      }

      .nav-buttons {
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .nav-button {
        min-width: 0;
        padding: 0.7rem 1rem;
        font-size: 0.8rem;
      }

      .map-image-preview {
          width: 200px;
          bottom: 10px;
          right: 10px;
      }
      .map-image-preview-title {
          font-size: 0.8rem;
          padding: 4px 8px;
      }
      #previewImg {
          height: 120px;
      }
      .map-image-preview-close {
          right: 6px;
      }

      .route-info-grid, .safety-info-grid {
        grid-template-columns: 1fr;
      }
      
      .map-image-preview.active,
      .map-image-preview {
        display: none !important;
      }
    }

    @media (min-width: 1200px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .header p {
        font-size: 1rem;
      }

      .info-panel {
        max-width: 420px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
  <div id="splash-screen">
    <img src="[https://www.kca.kr/home/www/images/main_2020/ft_logo.png](https://www.kca.kr/home/www/images/main_2020/ft_logo.png)" alt="Î°úÍ≥†">
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="[https://www.kca.kr/home/www/images/main_2020/ft_logo.png](https://www.kca.kr/home/www/images/main_2020/ft_logo.png)" alt="ÌïúÍµ≠Î∞©ÏÜ°ÌÜµÏã†Ï†ÑÌååÏßÑÌù•Ïõê" class="header-logo" onerror="this.style.display='none'; this.alt='Î°úÍ≥† Î°úÎìú Ïã§Ìå®';">
      <div class="header-content">
        <h1 id="appTitle">Ìï¥Ïñë Ïä§ÎßàÌä∏ Ï∂úÏû• ÏÜîÎ£®ÏÖò</h1>
        <p id="subtitle">KCA Î∂ÄÏÇ∞Î≥∏Î∂Ä Ìï≠, Ìè¨, Íµ¨ Ï∂úÏû• ÏÜîÎ£®ÏÖò</p>
      </div>
    </div>
    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        <div class="zoom-controls">
          <button class="zoom-btn map-control-btn" id="zoomIn">+</button>
          <button class="zoom-btn map-control-btn" id="zoomOut">‚àí</button>
   
          <button class="map-control-btn" id="gpsBtn" title="ÎÇ¥ ÏúÑÏπòÎ°ú Ïù¥Îèô">üõ∞Ô∏è</button>
          <button class="location-toggle map-control-btn" id="locationToggle" title="ÏúÑÏπò Î©îÎâ¥">üìç</button>
        </div>
        <div class="region-selector" id="regionSelector">
          <button class="region-btn" data-region="busan">Î∂ÄÏÇ∞</button>
          <button class="region-btn" data-region="ulsan">Ïö∏ÏÇ∞</button>
          <button class="region-btn" data-region="changwon">Ï∞ΩÏõê</button>
          <button class="region-btn" data-region="tongyeong">ÌÜµÏòÅ</button>
       
          <button class="region-btn" data-region="geoje">Í±∞Ï†ú</button>
          <button class="region-btn" data-region="namhae">ÎÇ®Ìï¥</button>
          <button class="region-btn" data-region="sacheon">ÏÇ¨Ï≤ú</button>
          <button class="region-btn" data-region="hadong">ÌïòÎèô</button>
          <button class="region-btn" data-region="goseong">Í≥†ÏÑ±</button>
          <button class="region-btn" data-region="all">Ï†ÑÏ≤¥Î≥¥Í∏∞</button>
        </div>
        <div class="tile-loading" id="tileLoading" style="display: none;">
            <span class="spinner"></span><span>ÏßÄÎèÑ Î°úÎî© Ï§ë...</span>
        </div>
        
        <div class="map-image-preview" id="mapImagePreview">
          <div class="map-image-preview-header">
            <span class="map-image-preview-close" id="closePreviewBtn" title="Îã´Í∏∞">&times;</span>
            <img id="previewImg" src="[https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image](https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image)" alt="Ìï≠Íµ¨ Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞">
            <div class="map-image-preview-title" id="previewImgTitle">Ìï≠Íµ¨ Ïù¥Î¶Ñ</div>
          </div>
        </div>

      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">AI Ìï≠, Ìè¨, Íµ¨ Î∂ÑÏÑù</h2>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Ìï≠Ìè¨Íµ¨ Ïù¥Î¶Ñ ÎòêÎäî ÏßÄÏó≠ Í≤ÄÏÉâ...">
          <button id="searchBtn" class="search-btn">üîç</button>
        </div>
        
        
        <div id="searchResults" class="search-results"></div>

        <div class="location-info" id="locationLabelWrapper">
            <p id="locationLabel"><strong>ÏßÄÎèÑÏóêÏÑú Î™©Ï†ÅÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</strong></p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName"></h3>
            <div class="address-container">
              <p id="harborAddress"></p>
              <button id="copyAddressBtn" class="copy-btn" title="Ï£ºÏÜå Î≥µÏÇ¨">Î≥µÏÇ¨</button>
            </div>
            <div id="navButtons" class="nav-buttons" style="display: none;">
                <a class="nav-button" id="tmapBtn" href="#" target="_blank" rel="noopener noreferrer">TMAP</a>
                <a class="nav-button" id="naverBtn" href="#" target="_blank" rel="noopener noreferrer">ÎÑ§Ïù¥Î≤ÑÏßÄÎèÑ</a>
            </div>
            <div id="editDeleteButtons" class="edit-delete-buttons"></div>

            <div class="analysis-section">
                <h4>ÌïµÏã¨ ÌäπÏßï</h4>
                
                <p id="aiKeyFeatures" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
            </div>
            <div class="analysis-section">
                <h4>ÌòÑÏû• Ï°∞Ïñ∏</h4>
                <p id="aiFieldAdvice"></p>
            </div>
            <div class="analysis-section">
          
                <h4>Ï¢ÖÌï© ÏùòÍ≤¨</h4>
                <p id="aiOverallOpinion" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
            </div>

            <div class="analysis-section">
                <h4>AI ÎßûÏ∂§ Ï∂úÏû• Í≤ΩÎ°ú</h4>
                <div class="route-info-grid">
          
                    <div class="info-block">
                        <h5>ÏòàÏÉÅ ÏÜåÏöîÏãúÍ∞Ñ</h5>
                        <p id="aiTravelTime" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
                    </div>
              
                    <div class="info-block">
                        <h5>ÍµêÌÜµ Ïú†ÏùòÏÇ¨Ìï≠</h5>
                        <p id="aiPrecautions" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
                    </div>
                </div>
  
            </div>

            <div class="analysis-section">
                <h4>Ïã§ÏãúÍ∞Ñ Ìï¥ÏÉÅ ÏïàÏ†ÑÏ†ïÎ≥¥</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                     
                        <h5>ÌíçÏÜç/ÌíçÌñ•</h5>
                        <p id="safetyWind" class="loading"><span class="spinner"></span> Ï†ïÎ≥¥ Î°úÎî©Ï§ë...</p>
                    </div>
                    <div class="info-block">
                        <h5>ÌååÍ≥†</h5>
   
                        <p id="safetyWave" class="loading"><span class="spinner"></span> Ï†ïÎ≥¥ Î°úÎî©Ï§ë...</p>
                    </div>
                    <div class="info-block">
                        <h5>Ï°∞Î•ò</h5>
         
                        <p id="safetyTide" class="loading"><span class="spinner"></span> Ï†ïÎ≥¥ Î°úÎî©Ï§ë...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>ÌäπÎ≥¥ Ï†ïÎ≥¥</h4>
  
                <div class="warning-info">
                    <p id="safetyWarning" class="loading"><span class="spinner"></span> Ï†ïÎ≥¥ Î°úÎî©Ï§ë...</p>
                </div>
            </div>
            
            <div class="analysis-section">
       
                <h4>Î¨ºÎïå Ï†ïÎ≥¥</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ÎßåÏ°∞</h5>
                        <p id="tideHighTime" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
                    </div>
                    <div class="info-block">
                        <h5>Í∞ÑÏ°∞</h5>
                        <p id="tideLowTime" class="loading"><span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...</p>
   
                    </div>
                </div>
            </div>

        </div>
      </div>

    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
      <p id="modalMessage"></p>
      <button class="modal-button" id="modalClose">ÌôïÏù∏</button>
    </div>
  </div>
  
<script>

// ÏÑúÎ≤Ñ Ìò∏Ï∂ú Ìï®Ïàò
async function callGeminiAPI(prompt) {
  try {
    const response = await fetch('api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();

    if (!data.success) {
      console.error('Gemini API Ïò§Î•ò', data);
      throw new Error(data.error || data.message || 'Gemini API failed');
    }

    return data.result;
  } catch (error) {
    console.error('API Ìò∏Ï∂ú Ïã§Ìå®', error);
    throw error;
  }
}

// AI ÏùëÎãµ ÌÖçÏä§Ìä∏ÏóêÏÑú ÏàúÏàò JSON Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂úÌïòÎäî Ìï®Ïàò (Ï∂îÍ∞ÄÎê®)
function extractJSON(text) {
  try {
    const startIndex = text.indexOf('{');
    const endIndex = text.lastIndexOf('}');

    if (startIndex !== -1 && endIndex !== -1) {
      const jsonString = text.substring(startIndex, endIndex + 1);
      return JSON.parse(jsonString);
    } else {
      // JSON ÌòïÏãùÏù¥ Î™ÖÌôïÌïòÏßÄ ÏïäÏúºÎ©¥ Ï†ÑÏ≤¥Î•º ÌååÏã± ÏãúÎèÑ
      return JSON.parse(text);
    }
  } catch (e) {
    console.error("JSON ÌååÏã± Ïã§Ìå®:", e);
    // Ïã§Ìå® Ïãú ÏóêÎü¨ Í∞ùÏ≤¥ Î∞òÌôòÏù¥ ÏïÑÎãå throwÎ°ú Ìò∏Ï∂úÏûêÏóêÍ≤å ÏïåÎ¶º
    throw new Error("JSON ÌòïÏãù Î≥ÄÌôò Ïã§Ìå®");
  }
}
  
    const defaultConfig = {
      app_title: "Ìï¥Ïñë Ïä§ÎßàÌä∏ Ï∂úÏû• ÏÜîÎ£®ÏÖò",
      subtitle: "KCA Î∂ÄÏÇ∞Î≥∏Î∂Ä Ìï≠, Ìè¨, Íµ¨ Ï∂úÏû• ÏÜîÎ£®ÏÖò",
      safety_title: "AI Ìï≠, Ìè¨, Íµ¨ Î∂ÑÏÑù",
      location_label: "ÏßÄÎèÑÏóêÏÑú Î™©Ï†ÅÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî",
      primary_color: "#1565c0",
      background_color: "#e3f2fd",
      surface_color: "#ffffff",
      text_color: "#212121",
      accent_color: "#1976d2",
      font_family: "Noto Sans KR",
      font_size: 16
    };

    const sampleHarbors = [ 
        {harbor: 'ÌïúÌôîÏò§ÏÖò', region: 'Í≤ΩÎÇ®-Í±∞Ï†ú', address: 'Í≤ΩÏÉÅÎÇ®ÎèÑ Í±∞Ï†ú Í±∞Ï†úÎåÄÎ°ú 3370', lat: 34.869797, lon: 128.697627, advice:  'ÌÜµÏã†Ïã§Ïû•ÏóêÍ≤å ÎÇ¥Î∞©Ïù∏ Ï∂úÏûÖÏã†Ï≤≠ ÌïÑÏöî'},
        {harbor: 'ÎÇ¥Í∞ÑÌï≠', region: 'Í≤ΩÎÇ®-Í±∞Ï†ú', address: 'Í≤ΩÏÉÅÎÇ®ÎèÑ Í±∞Ï†ú Í±∞Ï†úÎ©¥ ÎÇ¥Í∞ÑÎ¶¨ 50-17', lat: 34.846273, lon: 128.567096, advice:  ''},
        {harbor: 'Î≤ïÎèôÌï≠', region: 'Í≤ΩÎÇ®-Í±∞Ï†ú', address: 'Í≤ΩÏÉÅÎÇ®ÎèÑ Í±∞Ï†ú Í±∞Ï†úÎ©¥ Î≤ïÎèôÎ¶¨ 1056-4', lat: 34.82242, lon: 128.519491, advice:  ''}
   ];
    let allHarbors = sampleHarbors;
    let selectedLocation = null;
    let canvas, ctx;
    let mapCenter = { lat: 35.5, lon: 128.8 };
    let mapZoom = 8;
    let markers = [];
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let lastTouch = null;
    let tileCache = {};
    let loadingTiles = 0;
    let userLocation = null;
    let nearbyBreakwaters = [];
    let showNearbyOnly = false;
    let currentRegionFilter = 'all';
    let pendingMapUpdate = null;
    const RENDER_THROTTLE = 16;
    let lastRenderTime = 0;
    let isEditMode = false;
    let editingHarbor = null;
    let isRegionalView = true;
    let detailedRegion = null;
    
    const isSmartphoneView = () => window.innerWidth <= 768;
    const KOREA_BOUNDS = {
      minLat: 32,
      maxLat: 43,
      minLon: 124,
      maxLon: 132
    };
    const TILE_SIZE = 256;
    const OSM_TILE_URL = '[https://tile.openstreetmap.org/](https://tile.openstreetmap.org/){z}/{x}/{y}.png';

    const regionImages = {
      'Î∂ÄÏÇ∞': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F001%2F2024%2F07%2F25%2FPCM20231118000008051_P4_20240725184131104.jpg&type=l340_165](https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F001%2F2024%2F07%2F25%2FPCM20231118000008051_P4_20240725184131104.jpg&type=l340_165)',
      'Ïö∏ÏÇ∞': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5277%2F2018%2F11%2F14%2F0000155402_003_20181114221331811.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5277%2F2018%2F11%2F14%2F0000155402_003_20181114221331811.jpg&type=a340)',
      'Í≤ΩÎÇ®-Í±∞Ï†ú': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5217%2F2023%2F01%2F02%2F0000232921_004_20230102003605996.jpg&type=l340_165](https://search.pstatic.net/common/?src=http%3A%2F%2Fimgnews.naver.net%2Fimage%2F5217%2F2023%2F01%2F02%2F0000232921_004_20230102003605996.jpg&type=l340_165)',
      'Í≤ΩÎÇ®-Í≥†ÏÑ±': '[https://search.pstatic.net/sunny/?src=https%3A%2F%2Fimg1.daumcdn.net%2Fthumb%2FR1280x0.fwebp%2F%3Ffname%3Dhttp%3A%2F%2Ft1.daumcdn.net%2Fbrunch%2Fservice%2Fuser%2FwlQ%2Fimage%2FvO85k5zfAXrRGA9dRapdflKcTc8&type=a340](https://search.pstatic.net/sunny/?src=https%3A%2F%2Fimg1.daumcdn.net%2Fthumb%2FR1280x0.fwebp%2F%3Ffname%3Dhttp%3A%2F%2Ft1.daumcdn.net%2Fbrunch%2Fservice%2Fuser%2FwlQ%2Fimage%2FvO85k5zfAXrRGA9dRapdflKcTc8&type=a340)',
      'Í≤ΩÎÇ®-ÎÇ®Ìï¥': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNDExMDVfNTUg%2FMDAxNzMwNzY5Mjc3Mzc4.UvfopuyZSkpS8geZ2z0Mp00Rk3J0omIXRfL-jehuC7sg.WsbCqTEQ8wmmuigHJ9zXrVMu_Swk_046JB14PAea0UUg.JPEG%2F1730723049942.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNDExMDVfNTUg%2FMDAxNzMwNzY5Mjc3Mzc4.UvfopuyZSkpS8geZ2z0Mp00Rk3J0omIXRfL-jehuC7sg.WsbCqTEQ8wmmuigHJ9zXrVMu_Swk_046JB14PAea0UUg.JPEG%2F1730723049942.jpg&type=a340)',
      'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAxNzEyMzFfMjIw%2FMDAxNTE0NzA2ODUxNDYw.NFN3QeevzrFFkQADD69H8WfmIjDatgPdZgKF6iaIfTYg.gPpyGtOUU92Vs_lNgch4y8f-DDE7AINop5v8W5hDRbsg.JPEG.bolikeme%2F%25B0%25AD%25B8%25AA%25BF%25A9%25C7%25E0IMG_3456-20171203.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAxNzEyMzFfMjIw%2FMDAxNTE0NzA2ODUxNDYw.NFN3QeevzrFFkQADD69H8WfmIjDatgPdZgKF6iaIfTYg.gPpyGtOUU92Vs_lNgch4y8f-DDE7AINop5v8W5hDRbsg.JPEG.bolikeme%2F%25B0%25AD%25B8%25AA%25BF%25A9%25C7%25E0IMG_3456-20171203.jpg&type=a340)',
      'Í≤ΩÎÇ®-Ï∞ΩÏõê': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNTA3MjNfMjk1%2FMDAxNzUzMjM4MDA5NTU1.FcNZWPDyLX1fDkS-8XcPKTMXn5oSFpihWwSnZLNs5YYg.KV-FxcwmfRSva7_qygX6JZTx1sxDe69jwwZ8d6JoCs4g.JPEG%2F14.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyNTA3MjNfMjk1%2FMDAxNzUzMjM4MDA5NTU1.FcNZWPDyLX1fDkS-8XcPKTMXn5oSFpihWwSnZLNs5YYg.KV-FxcwmfRSva7_qygX6JZTx1sxDe69jwwZ8d6JoCs4g.JPEG%2F14.jpg&type=a340)',
     'Í≤ΩÎÇ®-ÌÜµÏòÅ': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzA0MTNfMTEg%2FMDAxNjgxMzU3NjY3Njk3.eHfMmbpy0RssGWVORuaQvOvk515bhhJ6aMDxiXlv_50g.oc-Lta20lYiA4CMRrx3YEUu6OByKEi83g7CjIsZqwW0g.JPEG.hgkim3%2F25991%25A3%25DF41271%25A3%25DF5233.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzA0MTNfMTEg%2FMDAxNjgxMzU3NjY3Njk3.eHfMmbpy0RssGWVORuaQvOvk515bhhJ6aMDxiXlv_50g.oc-Lta20lYiA4CMRrx3YEUu6OByKEi83g7CjIsZqwW0g.JPEG.hgkim3%2F25991%25A3%25DF41271%25A3%25DF5233.jpg&type=a340)',
      'Í≤ΩÎÇ®-ÌïòÎèô': '[https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzAyMTJfNDAg%2FMDAxNjc2MTk5NjkzNjgz.lsNEBado0DCaXjagjkOrQ_zWvU8JQlxWo7fT_ZFs_gkg.3_nYICUhx2OlbTAtjopaqc9D3rQF9nUod8j2pc1wJqAg.JPEG.jhmspark00%2F20230205-IMGL3595.jpg&type=a340](https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2FMjAyMzAyMTJfNDAg%2FMDAxNjc2MTk5NjkzNjgz.lsNEBado0DCaXjagjkOrQ_zWvU8JQlxWo7fT_ZFs_gkg.3_nYICUhx2OlbTAtjopaqc9D3rQF9nUod8j2pc1wJqAg.JPEG.jhmspark00%2F20230205-IMGL3595.jpg&type=a340)',
      'Í≤ΩÎÇ®': '[https://placehold.co/250x150/0d47a1/ffffff?text=Í≤ΩÎÇ®+ÎåÄÌëú+Ïù¥ÎØ∏ÏßÄ](https://placehold.co/250x150/0d47a1/ffffff?text=Í≤ΩÎÇ®+ÎåÄÌëú+Ïù¥ÎØ∏ÏßÄ)'
    };
    const regionalMarkers = {
        'Î∂ÄÏÇ∞': { lat: 35.18, lon: 129.08, count: 0, regionKey: 'Î∂ÄÏÇ∞' },
        'Ïö∏ÏÇ∞': { lat: 35.53, lon: 129.35, count: 0, regionKey: 'Ïö∏ÏÇ∞' },
        'Í≤ΩÎÇ®-Ï∞ΩÏõê': { lat: 35.1978, lon: 128.5756, count: 0, regionKey: 'Í≤ΩÎÇ®-Ï∞ΩÏõê' },
        'Í≤ΩÎÇ®-ÌÜµÏòÅ': { lat: 34.8442, lon: 128.4331, count: 0, regionKey: 'Í≤ΩÎÇ®-ÌÜµÏòÅ' },
        'Í≤ΩÎÇ®-Í±∞Ï†ú': { lat: 34.8897, lon: 128.6997, count: 0, regionKey: 'Í≤ΩÎÇ®-Í±∞Ï†ú' },
       
        'Í≤ΩÎÇ®-ÎÇ®Ìï¥': { lat: 34.83, lon: 127.89, count: 0, regionKey: 'Í≤ΩÎÇ®-ÎÇ®Ìï¥' },
        'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú': { lat: 34.92, lon: 128.06, count: 0, regionKey: 'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú' },
        'Í≤ΩÎÇ®-ÌïòÎèô': { lat: 34.94, lon: 127.87, count: 0, regionKey: 'Í≤ΩÎÇ®-ÌïòÎèô' },
        'Í≤ΩÎÇ®-Í≥†ÏÑ±': { lat: 34.97, lon: 128.32, count: 0, regionKey: 'Í≤ΩÎÇ®-Í≥†ÏÑ±' }
    };
    const subRegionCenters = {
        'Í≤ΩÎÇ®-Ï∞ΩÏõê': { lat: 35.1978, lon: 128.5756 },
        'Í≤ΩÎÇ®-ÌÜµÏòÅ': { lat: 34.8442, lon: 128.4331 },
        'Í≤ΩÎÇ®-Í±∞Ï†ú': { lat: 34.8897, lon: 128.6997 },
        'Í≤ΩÎÇ®-ÎÇ®Ìï¥': { lat: 34.83, lon: 127.89 },
        'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú': { lat: 34.92, lon: 128.06 },
        'Í≤ΩÎÇ®-ÌïòÎèô': { lat: 34.94, lon: 127.87 },
        'Í≤ΩÎÇ®-Í≥†ÏÑ±': { lat: 34.97, lon: 128.32 }
    };


    const regionCenters = {
      busan: { lat: 35.15, lon: 129.08, zoom: 11 },
      ulsan: { lat: 35.50, lon: 129.38, zoom: 11 },
      changwon: { lat: 35.1978, lon: 128.5756, zoom: 11 },
      tongyeong: { lat: 34.8442, lon: 128.4331, zoom: 11 },
      geoje: { lat: 34.8897, lon: 128.6997, zoom: 11 },
      namhae: { lat: 34.83, lon: 127.89, zoom: 11 },
      sacheon: { lat: 34.92, lon: 128.06, zoom: 11 },
      hadong: { lat: 34.94, lon: 127.87, zoom: 12 },
      goseong: { lat: 34.97, lon: 128.32, zoom: 11 },
      all: { lat: 35.5, lon: 128.8, zoom: 8 }
    };

    function preprocessHarbors() {
        Object.values(regionalMarkers).forEach(marker => marker.count = 0);
        allHarbors.forEach(harbor => {
            if (harbor.region && harbor.region.includes('Î∂ÄÏÇ∞')) {
                regionalMarkers['Î∂ÄÏÇ∞'].count++;
            } else if (harbor.region && harbor.region.includes('Ïö∏ÏÇ∞')) {
                regionalMarkers['Ïö∏ÏÇ∞'].count++;
            } else if (harbor.region && harbor.region.includes('Í≤ΩÎÇ®')) {
              
                const subRegionKey = Object.keys(regionalMarkers).find(key => key.includes('Í≤ΩÎÇ®') && harbor.region.includes(key.replace('Í≤ΩÎÇ®-', '')));
                if (subRegionKey) {
                    regionalMarkers[subRegionKey].count++;
                }
            }
        });
    }


    function showModal(message) {
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <p id="modalMessage">${message.replace(/\n/g, '<br>')}</p>
        <button class="modal-button" id="modalClose">ÌôïÏù∏</button>
      `;
      document.getElementById('modalMessage').style.color = '#333';
      document.getElementById('modalClose').addEventListener('click', hideModal);
      modalOverlay.classList.add('active');
      document.getElementById('regionSelector').classList.remove('active');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.getElementById('regionSelector').classList.remove('active');
      document.getElementById('locationToggle').classList.remove('active'); 
    }

    function copyToClipboard(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'absolute';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand('copy');
        showModal('Ï£ºÏÜåÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
      } catch (err) {
        console.error('Copy failed', err);
        showModal('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
      document.body.removeChild(ta);
    }

    function getRegionImage(regionStr) {
      if (!regionStr) return '[https://placehold.co/250x150/e3f2fd/1565c0?text=No+Image](https://placehold.co/250x150/e3f2fd/1565c0?text=No+Image)';
      if (regionImages[regionStr]) {
        return regionImages[regionStr];
      }
      
      if (regionStr.includes('Í≤ΩÎÇ®')) {
        return regionImages['Í≤ΩÎÇ®'];
      }
      if (regionStr.includes('Î∂ÄÏÇ∞')) {
        return regionImages['Î∂ÄÏÇ∞'];
      }
      if (regionStr.includes('Ïö∏ÏÇ∞')) {
        return regionImages['Ïö∏ÏÇ∞'];
      }
      
      return '[https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image](https://placehold.co/250x150/e3f2fd/1565c0?text=Harbor+Image)';
    }

    function initMap() {
      canvas = document.getElementById('mapCanvas');
      ctx = canvas.getContext('2d');
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('mouseleave', handleMouseUp);
      
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', handleTouchEnd);
      
      canvas.addEventListener('wheel', handleWheel);
    }

    function resizeCanvas() {
      if (!canvas) return;
      const container = canvas.parentElement;
      if (!container) return;
      
      if (container.clientWidth > 0 && container.clientHeight > 0) {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        drawMap();
      }
    }

    function latLonToTile(lat, lon, zoom) {
      const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
      const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
      return { x, y };
    }

    function tileToLatLon(x, y, zoom) {
      const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
      const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
      const lon = x / Math.pow(2, zoom) * 360 - 180;
      return { lat, lon };
    }

    function latLonToPixel(lat, lon) {
      const scale = Math.pow(2, mapZoom);
      const worldX = (lon + 180) / 360 * TILE_SIZE * scale;
      const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
      const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
      const centerWorld = {
        x: centerTile.x * TILE_SIZE + TILE_SIZE / 2,
        y: centerTile.y * TILE_SIZE + TILE_SIZE / 2
      };
      if (!canvas) return { x: 0, y: 0 };
      const x = canvas.width / 2 + (worldX - centerWorld.x);
      const y = canvas.height / 2 + (worldY - centerWorld.y);
      
      return { x, y };
    }

    function loadTile(x, y, z) {
      const key = `${z}/${x}/${y}`;
      if (tileCache[key]) {
        return tileCache[key];
      }
      
      const img = new Image();
      img.crossOrigin = 'anonymous';
      loadingTiles++;
      updateLoadingIndicator();
      
      img.onload = () => {
        loadingTiles--;
        updateLoadingIndicator();
        drawMap();
      };
      img.onerror = () => {
        loadingTiles--;
        updateLoadingIndicator();
      };
      img.src = OSM_TILE_URL.replace('{z}', z).replace('{x}', x).replace('{y}', y);
      tileCache[key] = img;
      
      return img;
    }

    function updateLoadingIndicator() {
      const indicator = document.getElementById('tileLoading');
      if (!indicator) return;
      if (loadingTiles > 0) {
        indicator.style.display = 'flex';
      } else {
        indicator.style.display = 'none';
      }
    }

    function scheduleMapRender() {
      if (pendingMapUpdate) {
        return;
      }
      
      pendingMapUpdate = requestAnimationFrame((timestamp) => {
        if (timestamp - lastRenderTime >= RENDER_THROTTLE) {
          drawMap();
          lastRenderTime = timestamp;
        }
        pendingMapUpdate = null;
      });
    }

    function drawMap() {
      if (!ctx) return;
      if (canvas.width === 0 || canvas.height === 0) return;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = '#aadaff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
      
      const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
      const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
      
      const startX = centerTile.x - Math.floor(tilesX / 2);
      const startY = centerTile.y - Math.floor(tilesY / 2);
      
      for (let i = 0; i < tilesX; i++) {
        for (let j = 0; j < tilesY; j++) {
          const tileX = startX + i;
          const tileY = startY + j;
          
          const maxTile = Math.pow(2, mapZoom);
          if (tileX < 0 || tileX >= maxTile || tileY < 0 || tileY >= maxTile) {
            continue;
          }
          
          const tile = loadTile(tileX, tileY, mapZoom);
          if (tile.complete && tile.naturalWidth > 0) {
            const tileLatLon = tileToLatLon(tileX, tileY, mapZoom);
            const pixelPos = latLonToPixel(tileLatLon.lat, tileLatLon.lon);
            
            ctx.drawImage(tile, pixelPos.x, pixelPos.y, TILE_SIZE, TILE_SIZE);
          }
        }
      }
      
      markers = [];
      let locationsToShow = [];
      
      if (showNearbyOnly) {
        locationsToShow = nearbyBreakwaters;
        isRegionalView = false;
        detailedRegion = null;
      } else if (mapZoom <= 9 && !detailedRegion) {
        isRegionalView = true;
        Object.keys(regionalMarkers).forEach(key => {
            const markerData = regionalMarkers[key];
            if (markerData.count > 0) {
                const pos = latLonToPixel(markerData.lat, markerData.lon);
                markers.push({ 
                    harbor: key, 
        
                    region: key, 
                    address: `${key} ÏßÄÏó≠ ÎåÄÌëú ÎßàÏª§`, 
                    lat: markerData.lat, 
                    lon: markerData.lon, 
                 
                    x: pos.x, 
                    y: pos.y,
                    isRegional: true,
                    count: markerData.count
                });
            }
    
        });
      } else {
        isRegionalView = false;
        let filteredHarbors = allHarbors;
        
        if (detailedRegion) {
            filteredHarbors = filteredHarbors.filter(h => h.region && h.region.includes(detailedRegion));
        } else if (currentRegionFilter !== 'all') {
            const regionKeywords = {
                'busan': 'Î∂ÄÏÇ∞',
                'ulsan': 'Ïö∏ÏÇ∞',
                'changwon': 'Í≤ΩÎÇ®-Ï∞ΩÏõê',
                'tongyeong': 'Í≤ΩÎÇ®-ÌÜµÏòÅ',
           
                'geoje': 'Í≤ΩÎÇ®-Í±∞Ï†ú',
                'namhae': 'Í≤ΩÎÇ®-ÎÇ®Ìï¥',
                'sacheon': 'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú',
                'hadong': 'Í≤ΩÎÇ®-ÌïòÎèô',
                'goseong': 'Í≤ΩÎÇ®-Í≥†ÏÑ±'
            };
            const keyword = regionKeywords[currentRegionFilter];
            filteredHarbors = filteredHarbors.filter(h => h.region && h.region.includes(keyword));
        }

        locationsToShow = filteredHarbors.map(location => {
            if (!location.lat || !location.lon || isNaN(location.lat) || isNaN(location.lon)) {
                return null;
            }
            const pos = latLonToPixel(parseFloat(location.lat), parseFloat(location.lon));
            return { ...location, x: pos.x, y: pos.y };
    
        }).filter(l => l);
        
        markers = locationsToShow;
      }

      markers.forEach(location => {
        if (!location.x || !location.y) return;
        
        const pos = { x: location.x, y: location.y };
        const isSelected = selectedLocation && selectedLocation.harbor === location.harbor;
        const isNearby = location.isNearby;
        let markerSize = location.isRegional ? 18 : 12;
        let fillColor = isSelected ? '#ff5722' : 
        (location.isRegional ? '#388e3c' : (isNearby ? '#42a5f5' : '#1e88e5'));

        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetY = 3;
        
        if (isSelected) {
          ctx.beginPath();
          ctx.arc(pos.x, pos.y - markerSize * 0.8, markerSize * 2.5, 0, Math.PI * 2);
 
          ctx.fillStyle = 'rgba(21, 101, 192, 0.15)';
          ctx.fill();
        }
        
        ctx.beginPath();
        ctx.arc(pos.x, pos.y - markerSize * 1.5, markerSize * 0.8, 0, Math.PI * 2);
        
        ctx.fillStyle = fillColor;
        ctx.fill();
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(pos.x - 1.5, pos.y - markerSize * 0.8);
        ctx.lineTo(pos.x - 1.5, pos.y);
        ctx.lineTo(pos.x + 1.5, pos.y);
        ctx.lineTo(pos.x + 1.5, pos.y - markerSize * 0.8);
        ctx.closePath();
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 2, 0, Math.PI * 2);
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        ctx.shadowBlur = 0;
        ctx.shadowOffsetY = 0;
        
        if (location.isRegional && location.count > 0) {
            ctx.font = 'bold 12px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(location.count, pos.x, pos.y - markerSize * 1.5);
            ctx.font = 'bold 14px "Noto Sans KR", sans-serif';
            ctx.fillStyle = '#1a237e';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(location.harbor.replace('Í≤ΩÎÇ®-', ''), pos.x, pos.y + 5); 
        }

        if (isSelected) {
          ctx.font = 'bold 12px "Noto Sans KR", sans-serif';
          const text = location.harbor + (location.isRegional ? ` (${location.count}Í≥≥)` : '');
          const textWidth = ctx.measureText(text).width;
          const labelPadding = 12;
          const labelHeight = 28;
          const labelY = pos.y - markerSize * 2.5 - 12;
          
          ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
          ctx.shadowBlur = 10;
          ctx.shadowOffsetY = 4;
          
          const labelGradient = ctx.createLinearGradient(
            pos.x - textWidth / 2 - labelPadding, 
            labelY - labelHeight, 
            pos.x - textWidth / 2 - labelPadding, 
            labelY
          );
          labelGradient.addColorStop(0, '#1565c0');
          labelGradient.addColorStop(1, '#1976d2');
          ctx.fillStyle = labelGradient;
          ctx.beginPath();
          ctx.roundRect(pos.x - textWidth / 2 - labelPadding, labelY - labelHeight, textWidth + labelPadding * 2, labelHeight, 8);
          ctx.fill();
          
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          ctx.beginPath();
          ctx.moveTo(pos.x, labelY + 2);
          ctx.lineTo(pos.x - 8, labelY - 8);
          ctx.lineTo(pos.x + 8, labelY - 8);
          ctx.closePath();
          ctx.fillStyle = '#1976d2';
          ctx.fill();
          
          ctx.shadowBlur = 0;
          ctx.shadowOffsetY = 0;
          
          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(text, pos.x, labelY - labelHeight / 2);
        }
      });
      
      if (userLocation) {
        const pos = latLonToPixel(userLocation.lat, userLocation.lon);
        if (pos.x >= -50 && pos.x <= canvas.width + 50 && pos.y >= -50 && pos.y <= canvas.height + 50) {
          const size = 24;
          ctx.shadowColor = 'rgba(76, 175, 80, 0.6)';
          ctx.shadowBlur = 20;
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
          ctx.fill();
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size * 0.6, 0, Math.PI * 2);
          ctx.fillStyle = '#4caf50';
          ctx.fill();
          
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size * 0.25, 0, Math.PI * 2);
          ctx.fillStyle = '#ffffff';
          ctx.fill();
        }
      }
      
      ctx.font = '10px Arial';
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.textAlign = 'right';
      ctx.fillText('¬© OpenStreetMap contributors', canvas.width - 10, canvas.height - 10);
    }
    
    function clampMapCenter(lat, lon) {
      let newLat = Math.max(-85, Math.min(85, lat));
      let newLon = lon;
      
      newLat = Math.max(KOREA_BOUNDS.minLat, Math.min(KOREA_BOUNDS.maxLat, newLat));
      newLon = Math.max(KOREA_BOUNDS.minLon, Math.min(KOREA_BOUNDS.maxLon, newLon));
      return { lat: newLat, lon: newLon };
    }


    function handleMouseDown(e) {
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };
      canvas.style.cursor = 'grabbing';
    }

    function handleMouseMove(e) {
      if (!isDragging) return;
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      
      const scale = Math.pow(2, mapZoom);
      const worldPixelsPerDegree = TILE_SIZE * scale / 360;
      
      let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
      const latRad = mapCenter.lat * Math.PI / 180;
      const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
      let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;

      const clampedCenter = clampMapCenter(nextLat, nextLon);
      mapCenter.lat = clampedCenter.lat;
      mapCenter.lon = clampedCenter.lon;
      
      dragStart = { x: e.clientX, y: e.clientY };
      
      scheduleMapRender();
    }


    function handleMouseUp(e) {
      if (isDragging) {
        const finalDragPos = { x: e.clientX, y: e.clientY };
        const dx = Math.abs(finalDragPos.x - dragStart.x);
        const dy = Math.abs(finalDragPos.y - dragStart.y);

        if (dx < 5 && dy < 5) { 
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          checkMarkerClick(x, y);
        }
      }
      
      isDragging = false;
      canvas.style.cursor = 'grab';
    }

    function handleTouchStart(e) {
      e.preventDefault();
      if (e.touches.length === 1) {
        lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        isDragging = true;
      } 
      else if (e.touches.length === 2) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const distance = Math.sqrt(
              Math.pow(touch2.clientX - touch1.clientX, 2) + 
              Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          lastTouch = { distance: distance, touch1: touch1, touch2: touch2 }; 
          isDragging = false;
      }
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (e.touches.length === 1 && isDragging) {
          const touch = e.touches[0];
          const dx = touch.clientX - lastTouch.x;
          const dy = touch.clientY - lastTouch.y;
          
          const scale = Math.pow(2, mapZoom);
          const worldPixelsPerDegree = TILE_SIZE * scale / 360;
          
          let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
          const latRad = mapCenter.lat * Math.PI / 180;
          const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
          let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;

          const clampedCenter = clampMapCenter(nextLat, nextLon);
          mapCenter.lat = clampedCenter.lat;
          mapCenter.lon = clampedCenter.lon;

          lastTouch = { x: touch.clientX, y: touch.clientY };
          scheduleMapRender();
      } 
      else if (e.touches.length === 2 && lastTouch && lastTouch.distance) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const newDistance = Math.sqrt(
              Math.pow(touch2.clientX - touch1.clientX, 2) + 
              Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          const scaleFactor = newDistance / lastTouch.distance;
          const zoomChange = Math.log2(scaleFactor);
          if (Math.abs(zoomChange) > 0.1) { 
              
              const newZoom = zoomChange > 0 ? mapZoom + 1 : mapZoom - 1;
              if (newZoom >= 5 && newZoom <= 18) {
                mapZoom = newZoom;
                mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);
                
                if (mapZoom >= 10 && isRegionalView) {
                    isRegionalView = false;
                    detailedRegion = currentRegionFilter === 'all' ? null : regionalMarkers[currentRegionFilter].regionKey;
                    if (detailedRegion && !detailedRegion.includes('Í≤ΩÎÇ®')) detailedRegion = null;
                } else if (mapZoom <= 9 && !isRegionalView) {
                    isRegionalView = true;
                    detailedRegion = null;
                }
              }
              lastTouch.distance = newDistance;
          }

          const dx = (touch1.clientX + touch2.clientX) / 2 - (lastTouch.touch1.clientX + lastTouch.touch2.clientX) / 2;
          const dy = (touch1.clientY + touch2.clientY) / 2 - (lastTouch.touch1.clientY + lastTouch.touch2.clientY) / 2;
          
          const scale = Math.pow(2, mapZoom);
          const worldPixelsPerDegree = TILE_SIZE * scale / 360;
          let nextLon = mapCenter.lon - dx / worldPixelsPerDegree;
          const latRad = mapCenter.lat * Math.PI / 180;
          const worldPixelsPerRadianLat = TILE_SIZE * scale / (2 * Math.PI) * Math.cos(latRad);
          let nextLat = mapCenter.lat + dy / worldPixelsPerRadianLat * 180 / Math.PI;
          
          const clampedCenter = clampMapCenter(nextLat, nextLon);
          mapCenter.lat = clampedCenter.lat;
          mapCenter.lon = clampedCenter.lon;

          lastTouch.touch1 = touch1;
          lastTouch.touch2 = touch2;

          scheduleMapRender();
      }
    }

    function handleTouchEnd(e) {
      e.preventDefault();
      if (e.touches.length === 0) {
        if (isDragging && lastTouch) {
          const dx = Math.abs(lastTouch.x - dragStart.x);
          const dy = Math.abs(lastTouch.y - dragStart.y);
          if (dx < 10 && dy < 10) {
            const rect = canvas.getBoundingClientRect();
            const x = dragStart.x - rect.left;
            const y = dragStart.y - rect.top;
            checkMarkerClick(x, y);
          }
        }
        
        isDragging = false;
        lastTouch = null; 
        
      } 
      else if (e.touches.length === 1) {
          lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          isDragging = true;
      }
    }
    function handleWheel(e) {
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }

    function checkMarkerClick(x, y) {
      let closestMarker = null;
      let minDistance = Infinity;
      
      const isSmartphoneView = window.innerWidth <= 768;

      markers.forEach(marker => {
        const markerCenterY = marker.y - (marker.isRegional ? 18 : 12) * 1.5; 
        const markerRadius = (marker.isRegional ? 18 : 12) * 0.8;
        
        const hitRadius = isSmartphoneView ? markerRadius + 30 : markerRadius + 10;
        const distanceToCenter = Math.sqrt(Math.pow(x - marker.x, 2) + Math.pow(y - markerCenterY, 2));

        const isTailHit = x >= marker.x - 5 && x <= marker.x + 5 && y >= markerCenterY && y <= marker.y + 5;

        if ((distanceToCenter < hitRadius || isTailHit) && distanceToCenter < minDistance) {
          minDistance = distanceToCenter;
          closestMarker = marker;
        }
      });

      if (closestMarker) {
        if (closestMarker.isRegional) {
            enterDetailedRegion(closestMarker.region);
            return;
        }
        
        if (selectedLocation && selectedLocation.harbor === closestMarker.harbor) {
             selectedLocation = null;
             updateLocationInfo(null);
             drawMap();
             return;
        }

        selectedLocation = closestMarker;
        updateLocationInfo(selectedLocation); 
        drawMap();
      } else {
        if (selectedLocation) { 
            selectedLocation = null;
            updateLocationInfo(null);
            drawMap();
        }
      }
    }
    function enterDetailedRegion(regionKey) {
        const regionNames = {
            'Î∂ÄÏÇ∞': 'busan',
            'Ïö∏ÏÇ∞': 'ulsan',
            'Í≤ΩÎÇ®-Ï∞ΩÏõê': 'changwon',
            'Í≤ΩÎÇ®-ÌÜµÏòÅ': 'tongyeong',
            'Í≤ΩÎÇ®-Í±∞Ï†ú': 'geoje',
        
            'Í≤ΩÎÇ®-ÎÇ®Ìï¥': 'namhae',
            'Í≤ΩÎÇ®-ÏÇ¨Ï≤ú': 'sacheon',
            'Í≤ΩÎÇ®-ÌïòÎèô': 'hadong',
            'Í≤ΩÎÇ®-Í≥†ÏÑ±': 'goseong'
        };
        const regionCode = regionNames[regionKey];

        if (regionCode) {
            detailedRegion = regionKey;
            showNearbyOnly = false;
            currentRegionFilter = regionCode;

            const centerConfig = regionCenters[regionCode] || regionCenters['all'];
            mapCenter = { lat: centerConfig.lat, lon: centerConfig.lon };
            mapZoom = Math.max(10, centerConfig.zoom);
            
            const regionLabel = regionKey.replace('Í≤ΩÎÇ®-', '');
            document.getElementById('locationLabel').innerHTML = 
              `<strong>üìç ${regionLabel} ÏßÄÏó≠ ÏÉÅÏÑ∏ Î≥¥Í∏∞</strong><br>
              <span style="font-size: 0.85em; color: #888;">ÏßÄÎèÑÎ•º ÏõÄÏßÅÏó¨ Ìï≠Ìè¨Íµ¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</span>`;
              
            selectedLocation = null;
            updateLocationInfo(null);
            drawMap();
        }
    }


// AI Î∂ÑÏÑù ÏöîÏ≤≠ Ìï®ÏàòÎì§ (ÏàòÏ†ïÎê®)
async function getStaticAnalysis(harbor) {
  const prompt = `
ÎãπÏã†ÏùÄ KCA(ÌïúÍµ≠Î∞©ÏÜ°ÌÜµÏã†Ï†ÑÌååÏßÑÌù•Ïõê)Ïùò Î≤†ÌÖåÎûë Î¨¥ÏÑ†Íµ≠ Í≤ÄÏÇ¨Í¥ÄÏùÑ ÎèïÎäî AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.
[Î∂ÑÏÑù ÎåÄÏÉÅ Ìï≠Íµ¨]
- Ïù¥Î¶Ñ: ${harbor.harbor}
- Ï£ºÏÜå: ${harbor.address}
- Í∏∞Ï°¥ Ï°∞Ïñ∏: ${harbor.advice || ''}

[ÏöîÏ≤≠]
ÏúÑ Ï†ïÎ≥¥ÎßåÏùÑ Î∞îÌÉïÏúºÎ°ú, Îã§Ïùå Ìï≠Î™©ÏùÑ JSON ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.
{
  "keyFeatures": "Î¨¥ÏÑ†Íµ≠ Í≤ÄÏÇ¨/ÏÑ†Î∞ï ÏïàÏ†Ñ Í¥ÄÏ†êÏóêÏÑú Ïù¥ Ìï≠¬∑Ìè¨¬∑Íµ¨Ïùò ÌïµÏã¨ ÌäπÏßïÏùÑ 2~3Î¨∏Ïû•ÏúºÎ°ú ÏöîÏïΩ",
  "overallOpinion": "Í≤ÄÏÇ¨Í¥ÄÏùÑ ÏúÑÌïú Ï¢ÖÌï© ÏùòÍ≤¨ÏùÑ 1Î¨∏Ïû•ÏúºÎ°ú ÏöîÏïΩ"
}
`.trim();
  try {
    const text = await callGeminiAPI(prompt);
    // ÏàòÏ†ïÎêú Ï∂îÏ∂ú Î°úÏßÅ ÏÇ¨Ïö©
    const aiData = extractJSON(text);
    return aiData;
  } catch (error) {
    console.error('Gemini (Static) Î∂ÑÏÑù Ï§ë Ïò§Î•ò', error);
    return {
      keyFeatures: `AI ÏöîÏïΩ Ïã§Ìå®: ${error.message}`,
      overallOpinion: 'AI ÏöîÏïΩ Ïã§Ìå®'
    };
  }
}
      
async function getRealtimeAnalysis(harbor, userLat, userLon) {
  let departurePoint = 'ÌïúÍµ≠Î∞©ÏÜ°ÌÜµÏã†Ï†ÑÌååÏßÑÌù•Ïõê Î∂ÄÏÇ∞Î≥∏Î∂Ä (Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú ÎèôÍµ¨ Ï§ëÏïôÎåÄÎ°ú 340)';
  if (userLat && userLon) {
    departurePoint = `ÌòÑÏû¨ GPS ÏúÑÏπò (ÏúÑÎèÑ ${userLat}, Í≤ΩÎèÑ ${userLon})`;
  }

  const prompt = `
ÎãπÏã†ÏùÄ KCA Î∂ÄÏÇ∞Î≥∏Î∂Ä Í≤ÄÏÇ¨Í¥ÄÏùò Ï∂úÏû•ÏùÑ ÎèïÎäî AI Ìï≠Ìï¥ ÌîåÎûòÎÑàÏûÖÎãàÎã§.
[Ï∂úÎ∞úÏßÄ]
- ${departurePoint}

[ÎèÑÏ∞©ÏßÄ]
- Ìï≠ÎßåÎ™Ö: ${harbor.harbor}
- Ï£ºÏÜå: ${harbor.address}

[ÏöîÏ≤≠]
Ï∂úÎ∞úÏßÄÏóêÏÑú ÎèÑÏ∞©ÏßÄÍπåÏßÄ Ïù¥ÎèôÍ≥º ÌòÑÏû• ÏûëÏóÖÏùÑ Í≥†Î†§ÌïòÏó¨,
Îã§Ïùå Ìï≠Î™©ÏùÑ JSON ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.
{
  "travelTime": "Ïòà: ÏïΩ 1ÏãúÍ∞Ñ 20Î∂Ñ",
  "precautions": "Ïòà: Ï∂úÌá¥Í∑º ÏãúÍ∞ÑÎåÄ Î∂ÅÌï≠ÎåÄÍµê Ï†ïÏ≤¥, Ìï≠Îßå ÏßÑÏûÖÎ°ú Í≥µÏÇ¨ Íµ¨Í∞Ñ ÏÑúÌñâ Îì±",
  "wind": "Ïòà: Î∂ÅÎèôÌíç 4m/s",
  "wave": "Ïòà: ÌååÍ≥† 0.5~1.0m",
  "tide": "Ïòà: Ï°∞Î•ò 1~2kn",
  "warning": "Ïòà: ÌäπÎ≥¥ ÏóÜÏùå / ÌíçÎûëÏ£ºÏùòÎ≥¥ Îì±",
  "highTide": "Ïòà: 09:10 / 21:25",
  "lowTide": "Ïòà: 03:40 / 15:50"
}
`.trim();
  try {
    const text = await callGeminiAPI(prompt);
    // ÏàòÏ†ïÎêú Ï∂îÏ∂ú Î°úÏßÅ ÏÇ¨Ïö©
    const aiData = extractJSON(text);
    return aiData;
  } catch (error) {
    console.error('Gemini (Realtime) Î∂ÑÏÑù Ï§ë Ïò§Î•ò', error);
    return {
      travelTime: 'Ïò§Î•ò',
      precautions: 'Ïò§Î•ò',
      wind: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®',
      wave: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®',
      tide: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®',
      warning: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®',
      highTide: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®',
      lowTide: 'Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®'
    };
  }
}

    async function updateLocationInfo(location) {
      const labelWrapper = document.getElementById('locationLabelWrapper');
      const analysisWrapper = document.getElementById('analysisContent');
      const imgPreview = document.getElementById('mapImagePreview');
      const naverBtn = document.getElementById('naverBtn');
      const tmapBtn = document.getElementById('tmapBtn');
      if (location) {
        labelWrapper.style.display = 'none';
        analysisWrapper.style.display = 'block';
        document.getElementById('searchResults').classList.remove('active');
        document.getElementById('selectedHarborName').textContent = `${location.harbor} AI Î∂ÑÏÑù`;
        document.getElementById('harborAddress').textContent = `Ï£ºÏÜå: ${location.address || 'Ï†ïÎ≥¥ ÏóÜÏùå'}`;
        document.getElementById('navButtons').style.display = 'flex';
        const destinationAddress = location.address || location.harbor;
        const encodedDestinationAddress = encodeURIComponent(destinationAddress);
        const encodedDestinationName = encodeURIComponent(location.harbor);

        let startLat = userLocation?.lat || 35.105481;
        let startLon = userLocation?.lon || 129.043394;
        const startName = encodeURIComponent("ÌòÑÏû¨ ÏúÑÏπò");

         // Î™©Ï†ÅÏßÄ ÏúÑÍ≤ΩÎèÑ
        const destLat = location.lat;
        const destLon = location.lon;

        // TMAPÍ≥º ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Î≤ÑÌäºÏùÑ Ï¥àÍ∏∞Ìôî
        tmapBtn.href = '#';
        naverBtn.href = '#';

        if (window.innerWidth <= 1500) { 
            tmapBtn.style.display = 'block';
            naverBtn.style.display = 'block';
            
            const tmapUrl = `tmap://route?goalname=${encodedDestinationName}&goaly=${destLat}&goalx=${destLon}`;
            const URL_NAME = 'kcabusansafecheck.my.canva.site/busanshipsolution';
            const naverUrl = `nmap://route/card?lat=${destLat}&dlng=${destLon}&dname=${encodedDestinationName}&appname=${URL_NAME}`;
            tmapBtn.href = tmapUrl;
            naverBtn.href = naverUrl;

        } else {
            tmapBtn.style.display = 'none';
            naverBtn.style.display = 'block';
            
            const naverWebUrl = `https://map.naver.com/v5/directions/-/${destLat},${destLon},${encodedDestinationName}/-/car?c=15,0,0,0,dh`;
            naverBtn.href = naverWebUrl;
        }
        
        document.getElementById('aiFieldAdvice').textContent = location.advice || 'Îì±Î°ùÎêú ÌòÑÏû• Ï°∞Ïñ∏Ïù¥ ÏóÜÏäµÎãàÎã§.\nÏ∂úÏû• Ïãú Ï£ºÎ≥ÄÏùÑ Ïûò ÏÇ¥ÌîºÏÑ∏Ïöî.';
        
        document.getElementById('editDeleteButtons').innerHTML = '';

        const imgEl = document.getElementById('previewImg');
        const imgTitleEl = document.getElementById('previewImgTitle');
        imgEl.onerror = () => { imgEl.src = '[https://placehold.co/250x150/e3f2fd/1565c0?text=Image+Load+Failed](https://placehold.co/250x150/e3f2fd/1565c0?text=Image+Load+Failed)'; }; 
        imgEl.src = getRegionImage(location.region); 
        imgTitleEl.textContent = location.harbor;
        imgPreview.classList.add('active');
        const staticFields = ['aiKeyFeatures', 'aiOverallOpinion'];
        const realtimeFields = [
          'aiTravelTime', 'aiPrecautions', 'safetyWind', 'safetyWave', 
          'safetyTide', 'safetyWarning', 'tideHighTime', 'tideLowTime'
        ];
        const loadingSpinner = `<span class="spinner"></span> AI Î∂ÑÏÑù Ï§ë...`;
        const smallSpinner = `<span class="spinner"></span> Î°úÎî©...`;
        staticFields.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = loadingSpinner;
          el.classList.add('loading');
        });
        realtimeFields.forEach(id => {
          const el = document.getElementById(id);
          el.innerHTML = smallSpinner;
          el.classList.add('loading');
        });
        const userLat = userLocation ? userLocation.lat : null;
        const userLon = userLocation ? userLocation.lon : null;
        
        const staticPromise = getStaticAnalysis(location);
        const realtimePromise = getRealtimeAnalysis(location, userLat, userLon);

        
        try {
            const staticData = await staticPromise;
            if (staticData.keyFeatures.includes("Ïò§Î•ò")) throw new Error(staticData.keyFeatures);
            document.getElementById('aiKeyFeatures').textContent = staticData.keyFeatures;
            document.getElementById('aiOverallOpinion').textContent = staticData.overallOpinion;
        } catch (error) {
            document.getElementById('aiKeyFeatures').textContent = `AI ÏöîÏïΩ Ïã§Ìå®: ${error.message}`;
            document.getElementById('aiOverallOpinion').textContent = "AI ÏöîÏïΩ Ïã§Ìå®";
        } finally {
            staticFields.forEach(id => document.getElementById(id).classList.remove('loading'));
        }

        try {
            const realtimeData = await realtimePromise;
            if (realtimeData.travelTime.includes("Ïò§Î•ò")) throw new Error("Ïã§ÏãúÍ∞Ñ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®");
            
            document.getElementById('aiTravelTime').textContent = realtimeData.travelTime;
            document.getElementById('aiPrecautions').textContent = realtimeData.precautions;
            document.getElementById('safetyWind').textContent = realtimeData.wind;
            document.getElementById('safetyWave').textContent = realtimeData.wave;
            document.getElementById('safetyTide').textContent = realtimeData.tide;
            document.getElementById('safetyWarning').textContent = realtimeData.warning;
            document.getElementById('tideHighTime').textContent = realtimeData.highTide;
            document.getElementById('tideLowTime').textContent = realtimeData.lowTide;

            const warningEl = document.getElementById('safetyWarning');
            const warningWrapper = document.querySelector('.warning-info');
            if (realtimeData.warning.includes('ÏóÜÏùå') || realtimeData.warning.includes('N/A')) {
                warningEl.style.color = '#388e3c';
                warningWrapper.style.borderColor = '#4caf50';
                warningWrapper.style.background = '#e8f5e9';
            } else {
                warningEl.style.color = '#f57c00';
                warningWrapper.style.borderColor = '#f57c00';
                warningWrapper.style.background = '#fff8e1';
            }
        } catch (error) {
            realtimeFields.forEach(id => {
                document.getElementById(id).textContent = "Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®";
            });
        } finally {
            realtimeFields.forEach(id => document.getElementById(id).classList.remove('loading'));
        }

      } else {
        labelWrapper.style.display = 'block';
        analysisWrapper.style.display = 'none';
        imgPreview.classList.remove('active');
        
        tmapBtn.href = '#';
        naverBtn.href = '#';
        tmapBtn.style.display = 'block';
        naverBtn.style.display = 'block';
      }
    }


    async function onConfigChange(config) {
      const baseFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, sans-serif';
      const customFont = `${baseFont}, ${baseFontStack}`;
      
      document.body.style.fontFamily = customFont;
      
      document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('aiAnalysisTitle').textContent = config.safety_title || defaultConfig.safety_title;
      document.getElementById('locationLabel').innerHTML = `<strong>${config.location_label || defaultConfig.location_label}</strong>`;

      document.body.style.background = config.background_color || defaultConfig.background_color;
      document.body.style.color = config.text_color || defaultConfig.text_color;
      
      document.querySelector('.header').style.background = config.surface_color || defaultConfig.surface_color;
      document.getElementById('info-panel').style.background = config.surface_color || defaultConfig.surface_color;
      
      document.getElementById('appTitle').style.color = config.primary_color || defaultConfig.primary_color;
      document.getElementById('aiAnalysisTitle').style.borderBottomColor = config.primary_color || defaultConfig.primary_color;
      
      document.querySelectorAll('.nav-button, .region-btn, .modal-button').forEach(btn => {
        if (!btn.classList.contains('secondary') && !btn.classList.contains('delete')) {
          btn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
        }
      });
      document.querySelectorAll('.search-btn').forEach(btn => {
         btn.style.background = `linear-gradient(135deg, ${config.primary_color} 0%, ${config.accent_color} 100%)`;
      });
      drawMap();
    }

    function initElementSdk(config) {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: config,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
           
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
      
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
 
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  window.elementSdk.setConfig({ accent_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
            
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['subtitle', config.subtitle || defaultConfig.subtitle],
            ['safety_title', config.safety_title || defaultConfig.safety_title],
            ['location_label', config.location_label || defaultConfig.location_label]
    
          ])
        });
        return true;
      } else {
        return false;
      }
    }

    function zoomIn() {
      if (mapZoom < 18) {
        mapZoom++;
        mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);

        if (mapZoom >= 10 && isRegionalView) {
            isRegionalView = false;
            detailedRegion = currentRegionFilter === 'all' ? null : regionalMarkers[currentRegionFilter].regionKey;
            if (detailedRegion && !detailedRegion.includes('Í≤ΩÎÇ®')) detailedRegion = null;
        }
        drawMap();
      }
    }

    function zoomOut() {
      if (mapZoom > 5) {
        mapZoom--;
        mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);
        
        if (mapZoom <= 9 && !isRegionalView) {
            isRegionalView = true;
            detailedRegion = null;
        }
        drawMap();
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function getUserLocation() {
      const gpsBtn = document.getElementById('gpsBtn');
      if (!navigator.geolocation) {
        showModal('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
        return;
      }

      try {
        const permission = await navigator.permissions.query({ name: 'geolocation' });
        if (permission.state === 'denied') {
          showModal('ÏúÑÏπò Í∂åÌïúÏù¥ Ï∞®Îã®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
          return;
        }
      } catch (e) {
        console.warn('Geolocation permission query failed', e);
      }

      gpsBtn.classList.add('active');
      const originalText = gpsBtn.innerHTML;
      gpsBtn.innerHTML = '‚è≥';
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };

          const allLocations = allHarbors;

          nearbyBreakwaters = allLocations
            .map(harbor => {
   
              if (!harbor.lat || !harbor.lon) return null;
              const distance = calculateDistance(
                userLocation.lat,
                userLocation.lon,
                harbor.lat,
                harbor.lon
   
              );
              return { ...harbor, distance, isNearby: distance <= 50 };
            })
            .filter(h => h && h.isNearby)
            .sort((a, b) => a.distance - b.distance);
            
          
          isRegionalView = false;
          detailedRegion = null;
          currentRegionFilter = 'all';

          if (nearbyBreakwaters.length > 0) {
            showNearbyOnly = true;
            mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
            mapZoom = 11;
            
            const nearest = nearbyBreakwaters[0];
            document.getElementById('locationLabel').innerHTML = 
              `<strong>üìç ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ìï≠Ìè¨Íµ¨</strong><br>
              <span style="color: #1565c0; font-size: 1.1em;">${nearest.harbor}</span><br>
              <span style="color: #666;">Í±∞Î¶¨: ${nearest.distance.toFixed(1)}km</span><br>
              <span style="font-size: 0.85em; color: #888;">Ïù∏Í∑º ${nearbyBreakwaters.length}Í∞ú Ìï≠Ìè¨Íµ¨ ÌëúÏãú Ï§ë</span>`;
            
            selectedLocation = nearest;
            updateLocationInfo(selectedLocation);
        } else {
            showModal('50km Î∞òÍ≤Ω ÎÇ¥Ïóê Ìï≠Ìè¨Íµ¨Í∞Ä ÏóÜÏäµÎãàÎã§.');
            mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
            mapZoom = 11;
            selectedLocation = null;
            updateLocationInfo(null);
        }

          gpsBtn.innerHTML = '‚úì';
          setTimeout(() => {
            gpsBtn.innerHTML = originalText;
            gpsBtn.classList.remove('active');
          }, 2000);
          drawMap();
        },
        (error) => {
          gpsBtn.classList.remove('active');
          gpsBtn.innerHTML = originalText;
          userLocation = null;
          
          let errorMsg = '';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg = 'ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.\n\niframe ÌôòÍ≤ΩÏóêÏÑúÎäî ÏúÑÏπò Í∂åÌïúÏù¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg = 'ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
          } else if (error.code === error.TIMEOUT) {
            errorMsg = 'ÏúÑÏπò ÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.';
          } else {
            errorMsg = 'ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.';
          }
          
          showModal(errorMsg);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 30000
        }
      );
    }

    function toggleRegionSelector() {
      const selector = document.getElementById('regionSelector');
      const toggle = document.getElementById('locationToggle');
      const isSmartphoneView = window.innerWidth <= 768;

      if (isSmartphoneView) {
          if (modalOverlay.classList.contains('active')) {
              hideModal();
              toggle.classList.remove('active');
          } else {
              showRegionModal(selector);
              toggle.classList.add('active');
          }
      } else {
          if (selector.classList.contains('active')) {
              selector.classList.remove('active');
              toggle.classList.remove('active');
          } else {
              selector.classList.add('active');
              toggle.classList.add('active');
          }
      }
    }

    function showRegionModal(selectorElement) {
        const modalOverlay = document.getElementById('modalOverlay');
        const modalContent = document.getElementById('modalContent');
        
        modalContent.innerHTML = ''; 
        
        const title = document.createElement('h3');
        title.textContent = 'ÏßÄÏó≠ ÏÑ†ÌÉù';
        modalContent.appendChild(title);

        const clonedSelector = selectorElement.cloneNode(true);
        clonedSelector.id = 'clonedRegionSelector';
        clonedSelector.classList.add('active');
        clonedSelector.style.position = 'static';
        clonedSelector.style.padding = '0';
        clonedSelector.style.boxShadow = 'none';
        clonedSelector.style.background = 'transparent';
        modalContent.appendChild(clonedSelector);

        clonedSelector.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                selectRegion(e.target.dataset.region);
                hideModal();
            });
        });
        const closeBtn = document.createElement('button');
        closeBtn.className = 'modal-button secondary';
        closeBtn.textContent = 'Îã´Í∏∞';
        closeBtn.style.marginTop = '1rem';
        closeBtn.addEventListener('click', hideModal);
        modalContent.appendChild(closeBtn);

        modalOverlay.classList.add('active');
    }

    function selectRegion(region) {
      showNearbyOnly = false;
      currentRegionFilter = region;
      userLocation = null;
      
      const center = regionCenters[region];
      mapCenter = { lat: center.lat, lon: center.lon };
      mapZoom = center.zoom;
      mapCenter = clampMapCenter(mapCenter.lat, mapCenter.lon);

      document.getElementById('regionSelector').classList.remove('active');
      document.getElementById('locationToggle').classList.remove('active');
      const regionNames = {
        busan: 'Î∂ÄÏÇ∞',
        ulsan: 'Ïö∏ÏÇ∞',
        changwon: 'Ï∞ΩÏõê',
        tongyeong: 'ÌÜµÏòÅ',
        geoje: 'Í±∞Ï†ú',
        namhae: 'ÎÇ®Ìï¥',
        sacheon: 'ÏÇ¨Ï≤ú',
        hadong: 'ÌïòÎèô',
        goseong: 'Í≥†ÏÑ±',
        all: 'Ï†ÑÏ≤¥'
      };
      if (region === 'all' || mapZoom <= 9) {
          isRegionalView = true;
          detailedRegion = null;
          document.getElementById('locationLabel').innerHTML = 
            `<strong>üìç ${regionNames[region]} ÏßÄÏó≠ ÎåÄÌëú ÎßàÏª§ Î≥¥Í∏∞</strong>`;
      } else {
          isRegionalView = false;
          detailedRegion = regionNames[region];
          document.getElementById('locationLabel').innerHTML = 
            `<strong>üìç ${regionNames[region]} ÏßÄÏó≠ ÏÉÅÏÑ∏ Ìï≠Ìè¨Íµ¨</strong>`;
      }
      
      selectedLocation = null;
      updateLocationInfo(null);
      drawMap();
    }

    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      const searchResults = document.getElementById('searchResults');
      if (!searchTerm) {
        searchResults.classList.remove('active');
        return;
      }
      
      const locationsToSearch = allHarbors;
      const results = locationsToSearch.filter(location => {
        const harborMatch = location.harbor && location.harbor.toLowerCase().includes(searchTerm);
        const regionMatch = location.region && location.region.toLowerCase().includes(searchTerm);
        const addressMatch = location.address && location.address.toLowerCase().includes(searchTerm);
        return harborMatch || regionMatch || addressMatch;
      });
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        searchResults.classList.add('active');
        return;
      }
      
      searchResults.innerHTML = results.map(result => `
        <div class="search-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-id="" data-harbor="${result.harbor}">
          <strong>${result.harbor}</strong>
          <span>${result.region} ¬∑ ${result.address}</span>
        </div>
      `).join('');
      searchResults.classList.add('active');
      
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lat = parseFloat(item.dataset.lat);
          const lon = parseFloat(item.dataset.lon);
          const harborName = item.dataset.harbor;
          
          mapCenter = { lat, lon };
          mapZoom = 14;
          
          const location = locationsToSearch.find(l => {
            return l.lat === lat && l.lon === lon && l.harbor === harborName;
          });
          
          if (location) {
            selectedLocation = location;
            updateLocationInfo(selectedLocation);
    
          }
          
          isRegionalView = false;
          detailedRegion = location.region.split('-')[0];
          if (detailedRegion === 'Í≤ΩÎÇ®') {
              detailedRegion = location.region;
          }
          currentRegionFilter = 'all';
        
          
          searchResults.classList.remove('active');
          document.getElementById('searchInput').value = '';
          drawMap();
        });
      });
    }

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    document.getElementById('searchInput').addEventListener('input', () => {
      if (document.getElementById('searchInput').value.trim() === '') {
        document.getElementById('searchResults').classList.remove('active');
      }
    });
    document.getElementById('zoomIn').addEventListener('click', zoomIn);
    document.getElementById('zoomOut').addEventListener('click', zoomOut);
    document.getElementById('locationToggle').addEventListener('click', toggleRegionSelector);
    document.getElementById('gpsBtn').addEventListener('click', getUserLocation);
    
    document.getElementById('copyAddressBtn').addEventListener('click', () => {
      if (selectedLocation && selectedLocation.address) {
        copyToClipboard(selectedLocation.address);
      }
    });
    document.getElementById('closePreviewBtn').addEventListener('click', () => {
      document.getElementById('mapImagePreview').classList.remove('active');
      selectedLocation = null;
      updateLocationInfo(null);
      drawMap();
    });
    if (window.innerWidth <= 768) {
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const region = e.target.dataset.region;
                selectRegion(region);
            });
        });
    }

    function setupScrollInteraction() {
        const infoPanel = document.getElementById('info-panel');
        const mapContainer = document.querySelector('.map-container');
        
        if (!infoPanel || !mapContainer) return;

        if (window.innerWidth <= 768) {
            infoPanel.addEventListener('scroll', () => {
                const scrollPercentage = infoPanel.scrollTop / (infoPanel.scrollHeight - infoPanel.clientHeight);
                
                if (scrollPercentage > 0.5) { 
                    mapContainer.style.height = '0';
                    mapContainer.style.opacity = '0';
                    infoPanel.style.maxHeight = '100%'; 
      
                } else {
                    mapContainer.style.height = '100%';
                    mapContainer.style.opacity = '1';
                    infoPanel.style.maxHeight = '50%';
                }
      
            });
        }
    }


    async function initializeSdkAndMap() {
      return new Promise(async (resolve) => {
          let elementSdkReady = false;
          
          if (window.elementSdk) {
            elementSdkReady = initElementSdk(defaultConfig);
            await onConfigChange(window.elementSdk.config || defaultConfig);
          }
          
          if (!elementSdkReady) {
             await onConfigChange(defaultConfig);
          }

          preprocessHarbors();
          initMap();
          
          setupScrollInteraction();

          resolve(true);
      });
    }


    window.addEventListener('load', () => {
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        
        const splashMinTime = 2000;
        const splashTimer = new Promise(resolve => setTimeout(resolve, splashMinTime));
        
        const appInitPromise = initializeSdkAndMap();

        Promise.all([appInitPromise, splashTimer])
        .then(() => {
            splashScreen.classList.add('hidden');
            appContainer.style.display = 'flex';
            
            resizeCanvas(); 
            
            setTimeout(() => {
                if(splashScreen.parentNode) {
                    splashScreen.parentNode.removeChild(splashScreen);
                }
            }, 500);
        })
        .catch(err => {
            console.error('App initialization failed but forcing display', err);
            splashScreen.classList.add('hidden');
            appContainer.style.display = 'flex';
            resizeCanvas();     
        });
    });

</script>
</body>
</html>
