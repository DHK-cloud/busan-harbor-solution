<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</title>
  
  <style>
    /* --- 1. ê¸°ë³¸ ì„¤ì • --- */
    body {
      box-sizing: border-box; margin: 0; padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121; height: 100%; overflow: hidden;
    }
    * { box-sizing: border-box; }
    html { height: 100%; }

    /* --- 2. ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° --- */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #ffffff; display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }
    .splash-fallback { font-size: 24px; font-weight: bold; color: #1565c0; display: none; text-align: center; }
    #splash-screen.hidden { opacity: 0; pointer-events: none; }

    /* --- 3. ë ˆì´ì•„ì›ƒ --- */
    .container {
      display: none; flex-direction: column; height: 100%; max-width: 100%; margin: 0 auto;
    }
    .header {
      background: #ffffff; padding: 0.8rem 1.5rem; text-align: center;
      border-bottom: 3px solid #1565c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex; align-items: center; justify-content: center; gap: 1.5rem;
      height: 65px; flex-shrink: 0;
    }
    .header-logo { height: 35px; width: auto; object-fit: contain; }
    .header h1 { margin: 0; font-size: 1.3rem; font-weight: 700; color: #1a237e; }
    .header p { margin: 0; font-size: 0.85rem; color: #616161; }
    .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* --- 4. ì§€ë„ ì˜ì—­ --- */
    .map-container {
      flex: 1; position: relative; background: #aadaff; overflow: hidden;
      transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s ease;
    }
    #mapCanvas { width: 100%; height: 100%; cursor: grab; touch-action: none; }
    #mapCanvas:active { cursor: grabbing; }

    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
    .zoom-controls {
      position: absolute; top: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 10px; z-index: 10;
    }
    .map-control-btn {
      width: 44px; height: 44px; background: white;
      border: 1px solid #e0e0e0; border-radius: 8px;
      font-size: 20px; font-weight: 600; color: #424242;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .map-control-btn:hover { background: #f5f5f5; color: #1565c0; }

    /* ì§€ì—­ ì„ íƒê¸° */
    .region-selector {
      position: absolute; top: 20px; right: 74px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px; padding: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 10; display: none; flex-direction: column; gap: 6px; min-width: 110px;
    }
    .region-selector.active { display: flex; }
    .region-btn {
      background: #1565c0; color: white; border: none; padding: 8px;
      border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
    }

    /* ë¡œë”©ë°” */
    .tile-loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(25, 118, 210, 0.9); color: white; padding: 0.8rem 1.2rem;
      border-radius: 50px; font-size: 0.9rem; font-weight: 600; z-index: 5; display: flex; align-items: center;
    }

    /* --- 5. ì •ë³´ íŒ¨ë„ --- */
    .info-panel {
      width: 100%; max-width: 380px; background: #ffffff;
      padding: 1.2rem; overflow-y: auto; border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
      transition: height 0.4s ease;
    }
    .info-panel h2 {
      margin: 0 0 0.8rem 0; font-size: 1.1rem; color: #212121;
      border-bottom: 2px solid #1565c0; padding-bottom: 0.4rem;
    }

    /* í…ìŠ¤íŠ¸ ë§ì¤„ì„ ìŠ¤íƒ€ì¼ */
    .multi-line-truncate {
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
      overflow: hidden; text-overflow: ellipsis; line-height: 1.4;
    }
    .single-truncate {
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;
    }

    .analysis-section {
      margin-bottom: 0.8rem; padding: 0.7rem;
      border: 1px solid #e0e0e0; border-radius: 8px; background: #f9faff;
    }
    .analysis-section h4 {
      font-size: 0.9rem; font-weight: 700; margin: 0 0 0.4rem 0;
      color: #333; border-bottom: 1px solid #eee; padding-bottom: 3px;
    }
    .analysis-section p {
      font-size: 0.9rem; color: #424242; margin: 0;
    }

    .route-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .safety-info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
    
    .info-block { background: #fff; border: 1px solid #e8e8e8; border-radius: 6px; padding: 0.5rem; text-align: center; }
    .info-block h5 { font-size: 0.75rem; color: #1565c0; margin: 0 0 0.3rem 0; font-weight: 700; }
    .info-block p { font-size: 1rem; font-weight: 700; color: #333; margin: 0; }

    .search-container { display: flex; gap: 8px; margin-bottom: 1rem; }
    #searchInput { flex: 1; padding: 10px; border: 2px solid #1a237e; border-radius: 8px; }
    .search-btn { padding: 0 15px; background: #1a237e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .search-results { max-height: 200px; overflow-y: auto; display: none; margin-bottom: 1rem; }
    .search-results.active { display: block; }
    .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .search-result-item:hover { background: #f5f5f5; }

    /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #navButtons a {
        transition: background-color 0.2s;
    }
    #navButtons a:hover {
        opacity: 0.9;
    }

    .spinner {
      width: 1em; height: 1em; border: 2px solid currentColor;
      border-right-color: transparent; border-radius: 50%;
      display: inline-block; animation: spinner-spin 0.75s linear infinite;
      vertical-align: middle; margin-right: 5px;
    }
    @keyframes spinner-spin { to { transform: rotate(360deg); } }
    .loading { color: #9e9e9e; font-style: italic; font-size: 0.85rem !important; font-weight: normal !important;}

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: none;
      align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 350px; width: 90%; text-align: center;}
    .modal-button { background: #1565c0; color: white; border: none; padding: 8px 20px; border-radius: 6px; margin-top: 15px; cursor: pointer; }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .header { padding: 0.5rem; justify-content: flex-start; }
      .header p { display: none; }
      
      .map-container { height: 40vh; flex: none; }
      .info-panel { max-width: 100%; flex: 1; border-top: 2px solid #1565c0; border-left: none; }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" 
         alt="KCA ë¡œê³ " 
         onerror="this.style.display='none'; document.querySelector('.splash-fallback').style.display='block';">
    <div class="splash-fallback">í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì›<br>ë¶€ì‚°ë³¸ë¶€</div>
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" alt="KCA" class="header-logo" onerror="this.style.display='none'">
      <div class="header-content">
        <h1 id="appTitle">í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</h1>
        <p id="subtitle">KCA ë¶€ì‚°ë³¸ë¶€ ë¬´ì„ êµ­ ê²€ì‚¬ ì§€ì› ì‹œìŠ¤í…œ</p>
      </div>
    </div>

    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        
        <div class="zoom-controls">
          <button class="map-control-btn" id="zoomIn">+</button>
          <button class="map-control-btn" id="zoomOut">âˆ’</button>
          <button class="map-control-btn" id="gpsBtn" title="ë‚´ ìœ„ì¹˜">ğŸ›°ï¸</button>
          <button class="map-control-btn" id="locationToggle" title="ì§€ì—­ ì„ íƒ">ğŸ“</button>
        </div>

        <div class="region-selector" id="regionSelector">
          <button class="region-btn" data-region="all">ì „ì²´ë³´ê¸°</button>
          <button class="region-btn" data-region="busan">ë¶€ì‚°</button>
          <button class="region-btn" data-region="ulsan">ìš¸ì‚°</button>
          <button class="region-btn" data-region="geoje">ê±°ì œ</button>
          <button class="region-btn" data-region="tongyeong">í†µì˜</button>
          <button class="region-btn" data-region="changwon">ì°½ì›</button>
          <button class="region-btn" data-region="namhae">ë‚¨í•´</button>
          <button class="region-btn" data-region="sacheon">ì‚¬ì²œ</button>
          <button class="region-btn" data-region="hadong">í•˜ë™</button>
          <button class="region-btn" data-region="goseong">ê³ ì„±</button>
        </div>

        <div class="tile-loading" id="tileLoading" style="display: none;">
            <span class="spinner"></span><span>ì§€ë„ ë¡œë”© ì¤‘...</span>
        </div>
      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">í•­Â·í¬Â·êµ¬ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="í•­í¬êµ¬ ì´ë¦„ ê²€ìƒ‰...">
          <button id="searchBtn" class="search-btn">ğŸ”</button>
        </div>
        <div id="searchResults" class="search-results"></div>

        <div id="locationLabelWrapper" style="text-align:center; color:#666; padding: 20px;">
            <p><strong>ì§€ë„ì—ì„œ ì§€ì—­ ë˜ëŠ” í•­êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</strong></p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName"></h3>
            <p id="harborAddress" style="font-size:0.85rem; color:#666; margin-bottom:10px;"></p>
            
            <div id="navButtons" style="display:flex; gap:8px; margin-bottom:15px;">
                <a id="tmapBtn" href="#" target="_blank" style="flex:1; background:#1565c0; color:white; padding:10px; text-align:center; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:600;">TMAP</a>
                <a id="naverBtn" href="#" target="_blank" style="flex:1; background:#03C75A; color:white; padding:10px; text-align:center; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:600;">ë„¤ì´ë²„ì§€ë„</a>
            </div>

            <div class="analysis-section">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <p id="aiKeyFeatures" class="loading multi-line-truncate"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>
            
            <div class="analysis-section" style="border-left: 3px solid #ff5722;">
                <h4 style="color:#d84315;">ì„ ë°• ë¬´ì„ êµ­ ê²€ì‚¬ ê³ ë ¤ì‚¬í•­</h4>
                <p id="aiInspectionTips" class="loading multi-line-truncate"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>

            <div class="analysis-section">
                <h4>í˜„ì¥ ì¡°ì–¸</h4>
                <p id="aiFieldAdvice" class="multi-line-truncate"></p>
            </div>

            <div class="analysis-section">
                <h4>ì´ë™ ê²½ë¡œ & ì•ˆì „</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ì˜ˆìƒ ì†Œìš”ì‹œê°„</h5>
                        <p id="aiTravelTime" class="loading single-truncate"><span class="spinner"></span>...</p>
                    </div>
                    <div class="info-block">
                        <h5>êµí†µ ì£¼ì˜</h5>
                        <p id="aiPrecautions" class="loading single-truncate"><span class="spinner"></span>...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>ì‹¤ì‹œê°„ í•´ìƒ ë‚ ì”¨ (ìˆ˜ì¹˜)</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                        <h5>í’ì†/í’í–¥</h5>
                        <p id="safetyWind" class="loading single-truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>íŒŒê³ </h5>
                        <p id="safetyWave" class="loading single-truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì¡°ë¥˜</h5>
                        <p id="safetyTide" class="loading single-truncate">...</p>
                    </div>
                </div>
            </div>
            
            <div class="analysis-section">
                <h4>ë¬¼ë•Œ ì‹œê°„</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ë§Œì¡°</h5>
                        <p id="tideHighTime" class="loading single-truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ê°„ì¡°</h5>
                        <p id="tideLowTime" class="loading single-truncate">...</p>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
      <p id="modalMessage"></p>
      <button class="modal-button" id="modalClose">í™•ì¸</button>
    </div>
  </div>

<script>
async function callGeminiAPI(prompt) {
  try {
    const response = await fetch('api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'API Error');
    return data.result;
  } catch (error) {
    console.error('Gemini Error:', error);
    throw error;
  }
}

function extractJSON(text) {
  try {
    const s = text.indexOf('{');
    const e = text.lastIndexOf('}');
    if (s !== -1 && e !== -1) return JSON.parse(text.substring(s, e + 1));
    return JSON.parse(text);
  } catch (e) { return { error: "íŒŒì‹± ì‹¤íŒ¨" }; }
}

const sampleHarbors = [ 
    {harbor: 'í•œí™”ì˜¤ì…˜', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œëŒ€ë¡œ 3370', lat: 34.869797, lon: 128.697627, advice: 'ë³´ì•ˆ êµ¬ì—­ ì§„ì… ì‹œ ì‹ ë¶„ì¦ í•„ìˆ˜ ì§€ì°¸. í†µì‹ ì‹¤ì¥ ì‚¬ì „ ì—°ë½ ìš”ë§.'},
    {harbor: 'ë‚´ê°„í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë‚´ê°„ë¦¬', lat: 34.846273, lon: 128.567096, advice: 'ì–´ì´Œê³„ì¥ë‹˜ í˜‘ì¡°ê°€ ì˜ ë˜ëŠ” í¸ì„.'},
    {harbor: 'ë²•ë™í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë²•ë™ë¦¬', lat: 34.82242, lon: 128.519491, advice: 'ì†Œí˜• ì„ ë°•ì´ ë§ì•„ ì ‘ì•ˆ ì‹œ ì£¼ì˜ í•„ìš”.'},
    {harbor: 'ë¶€ì‚°í•­', region: 'ë¶€ì‚°', address: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬', lat: 35.105, lon: 129.040, advice: 'ëŒ€í˜• ì„ ë°• ì…ì¶œí•­ ì¦ìŒ.'}
];

const regionalMarkers = {
    'ë¶€ì‚°': { lat: 35.18, lon: 129.08, count: 0, regionKey: 'ë¶€ì‚°' },
    'ìš¸ì‚°': { lat: 35.53, lon: 129.35, count: 0, regionKey: 'ìš¸ì‚°' },
    'ì°½ì›': { lat: 35.19, lon: 128.57, count: 0, regionKey: 'ê²½ë‚¨-ì°½ì›' },
    'í†µì˜': { lat: 34.84, lon: 128.43, count: 0, regionKey: 'ê²½ë‚¨-í†µì˜' },
    'ê±°ì œ': { lat: 34.88, lon: 128.69, count: 0, regionKey: 'ê²½ë‚¨-ê±°ì œ' },
    'ë‚¨í•´': { lat: 34.83, lon: 127.89, count: 0, regionKey: 'ê²½ë‚¨-ë‚¨í•´' },
    'ì‚¬ì²œ': { lat: 34.92, lon: 128.06, count: 0, regionKey: 'ê²½ë‚¨-ì‚¬ì²œ' },
    'í•˜ë™': { lat: 34.94, lon: 127.87, count: 0, regionKey: 'ê²½ë‚¨-í•˜ë™' },
    'ê³ ì„±': { lat: 34.97, lon: 128.32, count: 0, regionKey: 'ê²½ë‚¨-ê³ ì„±' }
};

let allHarbors = sampleHarbors;
let mapCenter = { lat: 35.5, lon: 128.8 };
let mapZoom = 8;
let canvas, ctx;
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let markers = []; 
let selectedLocation = null;
let userLocation = null; // ì‚¬ìš©ì ìœ„ì¹˜ ì €ì¥ ë³€ìˆ˜
const TILE_SIZE = 256;
const OSM_TILE_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';

// KCA ë¶€ì‚°ë³¸ë¶€ ì¢Œí‘œ (fallbackìš©)
const KCA_BUSAN_LAT = 35.1194;
const KCA_BUSAN_LON = 129.0447;
const KCA_BUSAN_NAME = "í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì› ë¶€ì‚°ë³¸ë¶€";

function preprocessHarbors() {
    Object.keys(regionalMarkers).forEach(key => regionalMarkers[key].count = 0);
    allHarbors.forEach(h => {
        if(h.region.includes('ë¶€ì‚°')) regionalMarkers['ë¶€ì‚°'].count++;
        else if(h.region.includes('ìš¸ì‚°')) regionalMarkers['ìš¸ì‚°'].count++;
        else {
            Object.keys(regionalMarkers).forEach(key => {
                if(regionalMarkers[key].regionKey === h.region) {
                    regionalMarkers[key].count++;
                }
            });
        }
    });
}

function initMap() {
    canvas = document.getElementById('mapCanvas');
    ctx = canvas.getContext('2d');
    window.addEventListener('resize', resizeCanvas);
    
    canvas.addEventListener('mousedown', e => { isDragging = true; dragStart = {x:e.clientX, y:e.clientY}; });
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('wheel', handleWheel);
    
    canvas.addEventListener('touchstart', e => { 
        isDragging = true; 
        dragStart = {x:e.touches[0].clientX, y:e.touches[0].clientY}; 
    });
    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!isDragging) return;
        const dx = e.touches[0].clientX - dragStart.x;
        const dy = e.touches[0].clientY - dragStart.y;
        mapCenter.lon -= dx * 0.003 * (360 / Math.pow(2, mapZoom));
        mapCenter.lat += dy * 0.003 * (180 / Math.pow(2, mapZoom));
        dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        drawMap();
    });
    canvas.addEventListener('touchend', () => { isDragging = false; });

    preprocessHarbors();
    setupScrollInteraction();
}

function resizeCanvas() {
    const container = canvas.parentElement;
    if (container.clientWidth > 0) {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        drawMap();
    }
}

function latLonToPixel(lat, lon) {
    const scale = Math.pow(2, mapZoom);
    const worldX = (lon + 180) / 360 * TILE_SIZE * scale;
    const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
    const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
    const centerWorld = { x: centerTile.x * TILE_SIZE + TILE_SIZE/2, y: centerTile.y * TILE_SIZE + TILE_SIZE/2 };
    return { x: canvas.width/2 + (worldX - centerWorld.x), y: canvas.height/2 + (worldY - centerWorld.y) };
}
function latLonToTile(lat, lon, zoom) {
    const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
    const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
    return { x, y };
}
function tileToLatLon(x, y, zoom) {
    const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
    const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
    const lon = x / Math.pow(2, zoom) * 360 - 180;
    return { lat, lon };
}

function drawMap() {
    if (!ctx || canvas.width === 0) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#aadaff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
    const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
    const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
    const startX = centerTile.x - Math.floor(tilesX / 2);
    const startY = centerTile.y - Math.floor(tilesY / 2);

    for (let i = 0; i < tilesX; i++) {
        for (let j = 0; j < tilesY; j++) {
            const tx = startX + i, ty = startY + j;
            const max = Math.pow(2, mapZoom);
            if (tx >= 0 && tx < max && ty >= 0 && ty < max) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = OSM_TILE_URL.replace('{z}', mapZoom).replace('{x}', tx).replace('{y}', ty);
                img.onload = () => {
                    const tLatLon = tileToLatLon(tx, ty, mapZoom);
                    const pos = latLonToPixel(tLatLon.lat, tLatLon.lon);
                    ctx.drawImage(img, pos.x, pos.y, TILE_SIZE, TILE_SIZE);
                };
            }
        }
    }

    markers = [];
    
    if (mapZoom < 10) {
        Object.keys(regionalMarkers).forEach(key => {
            const r = regionalMarkers[key];
            if (r.count > 0) {
                const pos = latLonToPixel(r.lat, r.lon);
                markers.push({ type: 'region', name: key, count: r.count, x: pos.x, y: pos.y, lat: r.lat, lon: r.lon });
            }
        });
    } else {
        allHarbors.forEach(h => {
            const pos = latLonToPixel(h.lat, h.lon);
            if (pos.x > -50 && pos.x < canvas.width + 50 && pos.y > -50 && pos.y < canvas.height + 50) {
                markers.push({ type: 'harbor', ...h, x: pos.x, y: pos.y });
            }
        });
    }

    markers.forEach(m => {
        if (m.type === 'region') {
            ctx.beginPath();
            ctx.arc(m.x, m.y, 18, 0, Math.PI * 2);
            ctx.fillStyle = '#1565c0';
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(m.name, m.x, m.y - 5);
            ctx.font = '10px sans-serif';
            ctx.fillText(`(${m.count})`, m.x, m.y + 8);
        } 
        else {
            const isSelected = selectedLocation && selectedLocation.harbor === m.harbor;
            const color = isSelected ? '#ff5722' : '#00897b';
            ctx.beginPath();
            ctx.arc(m.x, m.y - 15, 12, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(m.x - 8, m.y - 10);
            ctx.lineTo(m.x, m.y);
            ctx.lineTo(m.x + 8, m.y - 10);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.beginPath();
            ctx.arc(m.x, m.y - 15, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            if(isSelected) {
                ctx.fillStyle = '#1a237e';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(m.harbor, m.x, m.y + 20);
            }
        }
    });
}

function handleMouseMove(e) {
    if (!isDragging) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    mapCenter.lon -= dx * 0.003 * (360 / Math.pow(2, mapZoom));
    mapCenter.lat += dy * 0.003 * (180 / Math.pow(2, mapZoom));
    dragStart = { x: e.clientX, y: e.clientY };
    drawMap();
}
function handleMouseUp(e) {
    if (isDragging) {
        const dx = Math.abs(e.clientX - dragStart.x);
        const dy = Math.abs(e.clientY - dragStart.y);
        if (dx < 5 && dy < 5) checkClick(e);
    }
    isDragging = false;
}
function handleWheel(e) {
    e.preventDefault();
    if (e.deltaY < 0) mapZoom = Math.min(18, mapZoom + 1);
    else mapZoom = Math.max(5, mapZoom - 1);
    drawMap();
}

function checkClick(e) {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    let clicked = null;
    for (let i = markers.length - 1; i >= 0; i--) {
        const m = markers[i];
        const dist = Math.sqrt(Math.pow(clickX - m.x, 2) + Math.pow(clickY - (m.type==='region'? m.y : m.y-15), 2));
        if (dist < 20) {
            clicked = m;
            break;
        }
    }
    if (clicked) {
        if (clicked.type === 'region') {
            mapCenter = { lat: clicked.lat, lon: clicked.lon };
            mapZoom = 12; 
            drawMap();
        } else {
            selectedLocation = clicked;
            updateLocationInfo(clicked);
            drawMap();
        }
    }
}

async function getAnalysis(harbor) {
    const prompt = `
    ì—­í• : KCA ë¶€ì‚°ë³¸ë¶€ ì„ ë°• ë¬´ì„ êµ­ ê²€ì‚¬ ì§€ì› AI.
    ëŒ€ìƒ í•­êµ¬: ${harbor.harbor} (${harbor.address})
    
    [ì‘ì„± ê·œì¹™]
    1. 'ê´€ê´‘' ì •ë³´ ì œì™¸, 'ì„ ë°• ê²€ì‚¬ ë° ì•ˆì „' ê´€ì ë§Œ ì‘ì„±.
    2. í…ìŠ¤íŠ¸ ì •ë³´ëŠ” 2~3ì¤„ ë‚´ì™¸ë¡œ ìš”ì•½.
    3. í•´ìƒ ì •ë³´(í’ì†, íŒŒê³ , ì¡°ë¥˜)ëŠ” 'ìˆ«ìì™€ ë‹¨ìœ„'ë§Œ ì¶œë ¥ (ì˜ˆ: "4.2m/s").
    4. ì‹œê°„ì€ "ì•½ 00ë¶„" í˜•ì‹.
    
    [JSON í¬ë§·]
    {
        "keyFeatures": "í•­êµ¬ì˜ ë¬¼ë¦¬ì , ì§€ë¦¬ì  í•µì‹¬ íŠ¹ì§• (2~3ì¤„)",
        "inspectionTips": "ë¬´ì„ êµ­ ê²€ì‚¬ê´€ ì„ ë°• ìŠ¹ì„ /ê²€ì‚¬ ì‹œ ì•ˆì „/ìš´ì˜ ê³ ë ¤ì‚¬í•­ (2~3ì¤„)",
        "overallOpinion": "ì¢…í•© ì•ˆì „ ì˜ê²¬ (1ì¤„)",
        "travelTime": "ì•½ OOë¶„",
        "precautions": "êµí†µ ì •ì²´ êµ¬ê°„ ìš”ì•½ (1ì¤„)",
        "wind": "í’ì† ìˆ˜ì¹˜ë§Œ (ì˜ˆ: 5m/s)",
        "wave": "íŒŒê³  ìˆ˜ì¹˜ë§Œ (ì˜ˆ: 0.5m)",
        "tide": "ì¡°ë¥˜ ì†ë„ ìˆ˜ì¹˜ë§Œ (ì˜ˆ: 1.2kn)",
        "highTide": "ë§Œì¡° ì‹œê°„ (ì˜ˆ: 09:00)",
        "lowTide": "ê°„ì¡° ì‹œê°„ (ì˜ˆ: 15:30)"
    }
    `;

    try {
        const text = await callGeminiAPI(prompt);
        const data = extractJSON(text);
        
        document.getElementById('aiKeyFeatures').textContent = data.keyFeatures;
        document.getElementById('aiInspectionTips').textContent = data.inspectionTips;
        document.getElementById('aiFieldAdvice').textContent = harbor.advice || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ';
        document.getElementById('aiTravelTime').textContent = data.travelTime;
        document.getElementById('aiPrecautions').textContent = data.precautions;
        document.getElementById('safetyWind').textContent = data.wind;
        document.getElementById('safetyWave').textContent = data.wave;
        document.getElementById('safetyTide').textContent = data.tide;
        document.getElementById('tideHighTime').textContent = data.highTide;
        document.getElementById('tideLowTime').textContent = data.lowTide;
        
        document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
    } catch (e) {
        document.getElementById('aiKeyFeatures').textContent = "ì •ë³´ ë¡œë“œ ì‹¤íŒ¨";
    }
}

// â˜…â˜…â˜… ì¤‘ìš”: ê¸¸ì°¾ê¸° ë¡œì§ (PC/ëª¨ë°”ì¼ ë¶„ê¸°) â˜…â˜…â˜…
function updateLocationInfo(location) {
    document.getElementById('locationLabelWrapper').style.display = 'none';
    document.getElementById('analysisContent').style.display = 'block';
    
    document.getElementById('selectedHarborName').textContent = location.harbor;
    document.getElementById('harborAddress').textContent = location.address;
    
    // UI ì´ˆê¸°í™” (ë¡œë”© í‘œì‹œ)
    const ids = ['aiKeyFeatures', 'aiInspectionTips', 'aiTravelTime', 'aiPrecautions', 'safetyWind', 'safetyWave', 'safetyTide', 'tideHighTime', 'tideLowTime'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
        el.classList.add('loading');
    });

    const tmapBtn = document.getElementById('tmapBtn');
    const naverBtn = document.getElementById('naverBtn');
    
    // ëª©ì ì§€ ì •ë³´
    const destName = encodeURIComponent(location.harbor);
    const destLat = location.lat;
    const destLon = location.lon;

    // PC/ëª¨ë°”ì¼ êµ¬ë¶„ ë¡œì§ (1024px ê¸°ì¤€)
    if (window.innerWidth > 1024) {
        // --- PC ëª¨ë“œ ---
        tmapBtn.style.display = 'none'; // TMAP ìˆ¨ê¹€
        naverBtn.style.display = 'block';
        naverBtn.textContent = "ë„¤ì´ë²„ ì§€ë„ (ê¸¸ì°¾ê¸°)";

        // ì¶œë°œì§€ ì„¤ì • ë¡œì§ (GPS ë˜ëŠ” KCA ë¶€ì‚°ë³¸ë¶€)
        let startLat, startLon, startName;
        
        if (userLocation) {
            startLat = userLocation.lat;
            startLon = userLocation.lon;
            startName = "í˜„ì¬ìœ„ì¹˜";
        } else {
            // GPS ì—†ì„ ì‹œ ê¸°ë³¸ê°’: KCA ë¶€ì‚°ë³¸ë¶€
            startLat = KCA_BUSAN_LAT;
            startLon = KCA_BUSAN_LON;
            startName = KCA_BUSAN_NAME;
        }

        const sNameEnc = encodeURIComponent(startName);
        // ë„¤ì´ë²„ ì§€ë„ PC ì›¹ ê¸¸ì°¾ê¸° URL í˜•ì‹
        // /p/directions/ì¶œë°œLat,ì¶œë°œLon,ì¶œë°œëª…/ë„ì°©Lat,ë„ì°©Lon,ë„ì°©ëª…/-/car
        const webUrl = `https://map.naver.com/p/directions/${startLat},${startLon},${sNameEnc}/${destLat},${destLon},${destName}/-/car`;
        naverBtn.href = webUrl;

    } else {
        // --- ëª¨ë°”ì¼ ëª¨ë“œ ---
        tmapBtn.style.display = 'block';
        naverBtn.style.display = 'block';
        tmapBtn.textContent = "TMAP";
        naverBtn.textContent = "ë„¤ì´ë²„ì§€ë„";

        // ë”¥ë§í¬ (ì•± ì‹¤í–‰)
        tmapBtn.href = `tmap://route?goalname=${destName}&goaly=${destLat}&goalx=${destLon}`;
        naverBtn.href = `nmap://route/public?dlat=${destLat}&dlng=${destLon}&dname=${destName}&appname=com.kca.busan`;
    }

    getAnalysis(location);
}

function setupScrollInteraction() {
    const infoPanel = document.getElementById('info-panel');
    const mapContainer = document.querySelector('.map-container');
    
    if (!infoPanel || !mapContainer) return;
    
    infoPanel.addEventListener('scroll', () => {
        if (window.innerWidth > 768) return; 
        
        if (infoPanel.scrollTop > 100) {
            mapContainer.style.height = '0';
            mapContainer.style.opacity = '0';
        } else {
            mapContainer.style.height = '40vh';
            mapContainer.style.opacity = '1';
        }
    });
}

// GPS ìœ„ì¹˜ ìš”ì²­
function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                // ìœ„ì¹˜ë¥¼ ì°¾ìœ¼ë©´ ì§€ë„ ì¤‘ì‹¬ ì´ë™
                mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
                mapZoom = 12;
                drawMap();
            },
            (error) => { console.warn("GPS Error:", error); }
        );
    }
}

window.addEventListener('load', () => {
    const splash = document.getElementById('splash-screen');
    const app = document.getElementById('app-container');
    
    setTimeout(() => {
        splash.classList.add('hidden');
        app.style.display = 'flex';
        requestAnimationFrame(() => {
            initMap();
            resizeCanvas();
            setTimeout(() => { if(splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
        });
    }, 2000);
});

document.getElementById('zoomIn').addEventListener('click', () => { mapZoom = Math.min(18, mapZoom + 1); drawMap(); });
document.getElementById('zoomOut').addEventListener('click', () => { mapZoom = Math.max(5, mapZoom - 1); drawMap(); });
document.getElementById('gpsBtn').addEventListener('click', getUserLocation); // GPS ë²„íŠ¼ ì—°ê²°

document.querySelectorAll('.region-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const r = e.target.dataset.region;
        if (r === 'all') { mapZoom = 8; mapCenter = {lat: 35.5, lon: 128.8}; }
        else if (regionalMarkers[r]) { mapZoom = 12; mapCenter = {lat: regionalMarkers[r].lat, lon: regionalMarkers[r].lon}; }
        else if (r === 'changwon') { mapZoom = 12; mapCenter = {lat: 35.19, lon: 128.57}; }
        drawMap();
    });
});
document.getElementById('searchBtn').addEventListener('click', () => {
    const val = document.getElementById('searchInput').value;
    const found = allHarbors.find(h => h.harbor.includes(val));
    if(found) {
        mapCenter = { lat: found.lat, lon: found.lon };
        mapZoom = 14;
        drawMap();
        setTimeout(() => { selectedLocation = found; updateLocationInfo(found); drawMap(); }, 100);
    } else { alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); }
});
</script>
</body>
</html>
