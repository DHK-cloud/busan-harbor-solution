<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</title>
  
  <style>
    /* --- ê¸°ë³¸ ì„¤ì • --- */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121;
      height: 100%;
      overflow: hidden;
    }

    * { box-sizing: border-box; }
    html { height: 100%; }
    
    /* --- ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° --- */
    #splash-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    #splash-screen img {
      height: 80px;
      width: auto;
    }
    #splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* --- ë ˆì´ì•„ì›ƒ --- */
    .container {
      display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
      flex-direction: column;
      height: 100%;
      max-width: 100%;
      margin: 0 auto;
    }

    /* --- í—¤ë” --- */
    .header {
      background: #ffffff;
      padding: 1rem 1.5rem;
      text-align: center;
      border-bottom: 3px solid #1565c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      height: 70px; /* í—¤ë” ë†’ì´ ê³ ì • */
    }
    .header-logo {
      height: 40px;
      width: auto;
      object-fit: contain;
    }
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      color: #1a237e;
      line-height: 1.2;
    }
    .header p {
      margin: 0;
      font-size: 0.8rem;
      color: #616161;
    }

    /* --- ë©”ì¸ ì»¨í…ì¸  (ì§€ë„ + íŒ¨ë„) --- */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* --- ì§€ë„ ì˜ì—­ --- */
    .map-container {
      flex: 1;
      position: relative;
      background: #aadaff;
      overflow: hidden;
    }
    #mapCanvas {
      width: 100%;
      height: 100%;
      cursor: grab;
      touch-action: none;
      display: block; /* ìº”ë²„ìŠ¤ í‘œì‹œ ê°•ì œ */
    }
    #mapCanvas:active { cursor: grabbing; }

    /* ì§€ë„ ì»¨íŠ¸ë¡¤ */
    .zoom-controls {
      position: absolute; top: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 10px; z-index: 10;
    }
    .map-control-btn {
      width: 40px; height: 40px;
      background: white; border: 1px solid #e0e0e0;
      border-radius: 8px; font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .map-control-btn.active { background: #1565c0; color: white; }

    /* ì§€ì—­ ì„ íƒê¸° */
    .region-selector {
      position: absolute; top: 20px; right: 70px;
      background: rgba(255,255,255,0.95);
      border-radius: 12px; padding: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 10; display: none; flex-direction: column; gap: 6px;
    }
    .region-selector.active { display: flex; }
    .region-btn {
      background: #1565c0; color: white; border: none;
      padding: 8px 12px; border-radius: 6px; font-size: 13px;
      cursor: pointer;
    }

    /* --- ì˜¤ë¥¸ìª½ ì •ë³´ íŒ¨ë„ (ìˆ˜ì •ë¨: 1ì¤„ ì••ì¶• ìŠ¤íƒ€ì¼ ì ìš©) --- */
    .info-panel {
      width: 100%;
      max-width: 360px;
      background: #ffffff;
      padding: 1rem;
      overflow-y: auto;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
    }

    /* íŒ¨ë„ ë‚´ í…ìŠ¤íŠ¸ 1ì¤„ ë§ì¤„ì„ ê³µí†µ í´ë˜ìŠ¤ */
    .truncate-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      max-width: 100%;
    }

    .info-panel h2 {
      margin: 0 0 0.8rem 0;
      font-size: 1.1rem;
      color: #212121;
      border-bottom: 2px solid #1565c0;
      padding-bottom: 0.4rem;
    }

    /* ê²€ìƒ‰ì°½ */
    .search-container {
      display: flex; gap: 5px; margin-bottom: 0.8rem;
    }
    #searchInput {
      flex: 1; padding: 8px 12px;
      border: 2px solid #1a237e; border-radius: 8px;
      font-size: 0.9rem;
    }
    .search-btn {
      padding: 0 15px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      color: white; border: none; border-radius: 8px; cursor: pointer;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ */
    .search-results { display: none; max-height: 200px; overflow-y: auto; margin-bottom: 1rem; }
    .search-results.active { display: block; }
    .search-result-item {
      padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
    }
    .search-result-item:hover { background: #f5f5f5; }

    /* ë¶„ì„ ì»¨í…ì¸  ì„¹ì…˜ (ì••ì¶•í˜•) */
    #analysisContent { padding-top: 0.5rem; }
    #selectedHarborName {
      font-size: 1.1rem; color: #1a237e; margin: 0 0 0.3rem 0;
      font-weight: 700;
    }
    .address-container { margin-bottom: 0.5rem; }
    #harborAddress { font-size: 0.8rem; color: #666; }

    /* ì„¹ì…˜ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ì—¬ë°± ì¶•ì†Œ) */
    .analysis-section {
      margin-bottom: 0.6rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.6rem;
      background: #f9faff;
    }
    .analysis-section h4 {
      font-size: 0.9rem; margin: 0 0 0.3rem 0;
      color: #333; border-bottom: 1px solid #eee; padding-bottom: 2px;
    }
    .analysis-section p {
      font-size: 0.85rem; color: #424242; margin: 0;
      /* 1ì¤„ ì••ì¶• í•µì‹¬ ìŠ¤íƒ€ì¼ */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ì •ë³´ ë¸”ë¡) */
    .route-info-grid, .safety-info-grid {
      display: grid; gap: 0.4rem;
    }
    .route-info-grid { grid-template-columns: 1fr 1fr; }
    .safety-info-grid { grid-template-columns: 1fr 1fr 1fr; }

    .info-block {
      background: #ffffff; border: 1px solid #e8e8e8;
      border-radius: 6px; padding: 0.4rem;
    }
    .info-block h5 {
      font-size: 0.7rem; color: #1565c0; margin: 0 0 0.2rem 0;
    }
    .info-block p {
      font-size: 0.85rem; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .spinner {
      width: 0.8em; height: 0.8em;
      border: 2px solid currentColor; border-right-color: transparent;
      border-radius: 50%; display: inline-block;
      animation: spinner-spin 0.75s linear infinite; vertical-align: middle;
    }
    @keyframes spinner-spin { to { transform: rotate(360deg); } }

    /* ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
    .nav-buttons { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .nav-button {
      flex: 1; padding: 0.5rem; background: #1565c0; color: white;
      border-radius: 6px; font-size: 0.85rem; text-align: center; text-decoration: none;
    }

    /* --- ëª¨ë°”ì¼ ë°˜ì‘í˜• --- */
    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .info-panel {
        max-width: 100%; max-height: 45%;
        border-top: 2px solid #1565c0;
      }
      .header { padding: 0.5rem 1rem; height: 50px; justify-content: flex-start;}
      .header h1 { font-size: 1rem; }
      .header p { display: none; }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <div style="text-align: center;">
        <img src="https://via.placeholder.com/150x60/1565c0/ffffff?text=KCA+Busan" alt="KCA ë¡œê³ " onerror="this.style.display='none'; document.getElementById('splash-text').style.display='block';">
        <h2 id="splash-text" style="display:none; color: #1565c0; margin-top: 10px;">KCA ë¶€ì‚°ë³¸ë¶€</h2>
    </div>
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="https://via.placeholder.com/100x40/1565c0/ffffff?text=KCA" alt="ë¡œê³ " class="header-logo">
      <div class="header-content">
        <h1 id="appTitle">í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</h1>
        <p id="subtitle">KCA ë¶€ì‚°ë³¸ë¶€ ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
      </div>
    </div>

    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        
        <div class="zoom-controls">
          <button class="map-control-btn" id="zoomIn">+</button>
          <button class="map-control-btn" id="zoomOut">âˆ’</button>
          <button class="map-control-btn" id="gpsBtn">ğŸ›°ï¸</button>
          <button class="map-control-btn" id="locationToggle">ğŸ“</button>
        </div>

        <div id="tileLoading" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.6); color:white; padding:10px 20px; border-radius:20px; display:none; z-index:5;">
            <span class="spinner"></span> ì§€ë„ ë¡œë”©...
        </div>

        <div class="region-selector" id="regionSelector">
            <button class="region-btn" data-region="busan">ë¶€ì‚°</button>
            <button class="region-btn" data-region="ulsan">ìš¸ì‚°</button>
            <button class="region-btn" data-region="changwon">ì°½ì›</button>
            <button class="region-btn" data-region="tongyeong">í†µì˜</button>
            <button class="region-btn" data-region="geoje">ê±°ì œ</button>
            <button class="region-btn" data-region="namhae">ë‚¨í•´</button>
            <button class="region-btn" data-region="sacheon">ì‚¬ì²œ</button>
            <button class="region-btn" data-region="hadong">í•˜ë™</button>
            <button class="region-btn" data-region="goseong">ê³ ì„±</button>
            <button class="region-btn" data-region="all">ì „ì²´</button>
        </div>
      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">AI ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="í•­í¬êµ¬ ê²€ìƒ‰...">
          <button id="searchBtn" class="search-btn">ğŸ”</button>
        </div>
        <div id="searchResults" class="search-results"></div>

        <div id="locationLabelWrapper" style="text-align: center; padding: 20px; color: #666;">
            <p>ì§€ë„ì—ì„œ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName">í•­êµ¬ ì´ë¦„</h3>
            <div class="address-container">
              <p id="harborAddress" class="truncate-text">ì£¼ì†Œ ì •ë³´</p>
            </div>
            
            <div id="navButtons" class="nav-buttons">
                <a class="nav-button" id="tmapBtn" href="#">TMAP</a>
                <a class="nav-button" id="naverBtn" href="#">ë„¤ì´ë²„</a>
            </div>

            <div class="analysis-section">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <p id="aiKeyFeatures" class="loading truncate-text"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>
            <div class="analysis-section">
                <h4>ì¢…í•© ì˜ê²¬</h4>
                <p id="aiOverallOpinion" class="loading truncate-text"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>
            <div class="analysis-section">
                <h4>í˜„ì¥ ì¡°ì–¸</h4>
                <p id="aiFieldAdvice" class="truncate-text">-</p>
            </div>

            <div class="analysis-section">
                <h4>ì´ë™ ê²½ë¡œ & ì•ˆì „</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ì†Œìš”ì‹œê°„</h5>
                        <p id="aiTravelTime" class="loading"><span class="spinner"></span>...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì£¼ì˜ì‚¬í•­</h5>
                        <p id="aiPrecautions" class="loading"><span class="spinner"></span>...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>í•´ìƒ ë‚ ì”¨</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                        <h5>í’ì†/í’í–¥</h5>
                        <p id="safetyWind" class="loading">...</p>
                    </div>
                    <div class="info-block">
                        <h5>íŒŒê³ </h5>
                        <p id="safetyWave" class="loading">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì¡°ë¥˜</h5>
                        <p id="safetyTide" class="loading">...</p>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

<script>
    // API í˜¸ì¶œ í•¨ìˆ˜ (JSON ì¶”ì¶œ ê¸°ëŠ¥ í¬í•¨)
    async function callGeminiAPI(prompt) {
      try {
        const response = await fetch('api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'API Error');
        return data.result;
      } catch (error) {
        console.error('API Fail:', error);
        throw error;
      }
    }

    function extractJSON(text) {
      try {
        const s = text.indexOf('{');
        const e = text.lastIndexOf('}');
        if (s !== -1 && e !== -1) return JSON.parse(text.substring(s, e + 1));
        return JSON.parse(text);
      } catch (e) {
        console.error("JSON Parse Error", e);
        throw new Error("JSON ë³€í™˜ ì‹¤íŒ¨");
      }
    }

    // ì§€ë„ ë° ë°ì´í„° ë³€ìˆ˜
    const sampleHarbors = [ 
        {harbor: 'í•œí™”ì˜¤ì…˜', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê±°ì œëŒ€ë¡œ 3370', lat: 34.869797, lon: 128.697627, advice: 'ì¶œì…ì‹ ì²­ í•„ìˆ˜'},
        {harbor: 'ë‚´ê°„í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê±°ì œë©´ ë‚´ê°„ë¦¬', lat: 34.846273, lon: 128.567096, advice: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'},
        {harbor: 'ë²•ë™í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê±°ì œë©´ ë²•ë™ë¦¬', lat: 34.82242, lon: 128.519491, advice: 'ì†Œí˜•ì„ ë°• ì£¼ì˜'}
    ];
    let allHarbors = sampleHarbors;
    let mapCenter = { lat: 35.5, lon: 128.8 };
    let mapZoom = 8;
    let canvas, ctx;
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    const TILE_SIZE = 256;
    // íƒ€ì¼ ì„œë²„ (OpenStreetMap)
    const OSM_TILE_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';

    // ì§€ë„ ì´ˆê¸°í™” ë° ê·¸ë¦¬ê¸°
    function initMap() {
        canvas = document.getElementById('mapCanvas');
        ctx = canvas.getContext('2d');
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousedown', (e) => { isDragging = true; dragStart = {x:e.clientX, y:e.clientY}; });
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', () => { isDragging = false; });
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            if(e.deltaY < 0) mapZoom = Math.min(18, mapZoom + 1);
            else mapZoom = Math.max(5, mapZoom - 1);
            drawMap();
        });
    }

    function resizeCanvas() {
        const container = canvas.parentElement;
        if (container.clientWidth > 0) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawMap();
        }
    }

    function drawMap() {
        if (!ctx || canvas.width === 0) return;
        
        // ë°°ê²½
        ctx.fillStyle = '#aadaff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // íƒ€ì¼ ê³„ì‚°
        const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
        const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
        const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
        const startX = centerTile.x - Math.floor(tilesX / 2);
        const startY = centerTile.y - Math.floor(tilesY / 2);

        for (let i = 0; i < tilesX; i++) {
            for (let j = 0; j < tilesY; j++) {
                const tx = startX + i;
                const ty = startY + j;
                const max = Math.pow(2, mapZoom);
                if (tx >= 0 && tx < max && ty >= 0 && ty < max) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.src = OSM_TILE_URL.replace('{z}', mapZoom).replace('{x}', tx).replace('{y}', ty);
                    img.onload = () => {
                        const tLatLon = tileToLatLon(tx, ty, mapZoom);
                        const pos = latLonToPixel(tLatLon.lat, tLatLon.lon);
                        ctx.drawImage(img, pos.x, pos.y, TILE_SIZE, TILE_SIZE);
                        // íƒ€ì¼ ë¡œë“œ í›„ ë§ˆì»¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ê°„ë‹¨ êµ¬í˜„)
                        drawMarkers();
                    };
                }
            }
        }
        drawMarkers();
    }

    function drawMarkers() {
        allHarbors.forEach(h => {
            const pos = latLonToPixel(h.lat, h.lon);
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 6, 0, Math.PI*2);
            ctx.fillStyle = 'red';
            ctx.fill();
            ctx.stroke();
        });
    }

    // ì¢Œí‘œ ë³€í™˜ ìœ í‹¸
    function latLonToTile(lat, lon, zoom) {
        const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
        const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
        return { x, y };
    }
    function tileToLatLon(x, y, zoom) {
        const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
        const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
        const lon = x / Math.pow(2, zoom) * 360 - 180;
        return { lat, lon };
    }
    function latLonToPixel(lat, lon) {
        const scale = Math.pow(2, mapZoom);
        const wx = (lon + 180) / 360 * TILE_SIZE * scale;
        const wy = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
        const cTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
        const cx = cTile.x * TILE_SIZE + TILE_SIZE/2;
        const cy = cTile.y * TILE_SIZE + TILE_SIZE/2;
        return {
            x: canvas.width/2 + (wx - cx),
            y: canvas.height/2 + (wy - cy)
        };
    }
    
    function handleMouseMove(e) {
        if(!isDragging) return;
        const dx = e.clientX - dragStart.x;
        const dy = e.clientY - dragStart.y;
        // ê°„ë‹¨ ì´ë™ ë¡œì§ (ì •í™•ë„ëŠ” ë‚®ìœ¼ë‚˜ ì‘ë™ í™•ì¸ìš©)
        mapCenter.lon -= dx * 0.01; 
        mapCenter.lat += dy * 0.01;
        dragStart = {x:e.clientX, y:e.clientY};
        drawMap();
    }

    // AI ìš”ì²­ í•¨ìˆ˜ (1ì¤„ ìš”ì•½ ìš”ì²­)
    async function getAnalysis(harbor) {
        // UI ì´ˆê¸°í™”
        ['aiKeyFeatures', 'aiOverallOpinion', 'aiTravelTime', 'aiPrecautions'].forEach(id => {
            document.getElementById(id).innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
        });

        const prompt = `
        í•­êµ¬: ${harbor.harbor} (${harbor.address})
        ëª©í‘œ: ì´ í•­êµ¬ì— ëŒ€í•œ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ì œê³µí•˜ë˜, ëª¨ë“  í•„ë“œì˜ ê°’ì€ 'ë°˜ë“œì‹œ 20ì ì´ë‚´ì˜ 1ê°œ ë¬¸ì¥'ìœ¼ë¡œ ì•„ì£¼ ì§§ê²Œ ìš”ì•½í•´ì•¼ í•¨.
        JSON í¬ë§·:
        {
            "keyFeatures": "í•µì‹¬ íŠ¹ì§• 1ì¤„ ìš”ì•½",
            "overallOpinion": "ì¢…í•© ì˜ê²¬ 1ì¤„ ìš”ì•½",
            "travelTime": "ì•½ 00ë¶„",
            "precautions": "ì£¼ìš” ì£¼ì˜ì‚¬í•­ 1ì¤„",
            "wind": "í’ì† 1ì¤„",
            "wave": "íŒŒê³  1ì¤„",
            "tide": "ì¡°ë¥˜ 1ì¤„"
        }
        `;
        
        try {
            const text = await callGeminiAPI(prompt);
            const data = extractJSON(text);
            
            document.getElementById('aiKeyFeatures').textContent = data.keyFeatures;
            document.getElementById('aiOverallOpinion').textContent = data.overallOpinion;
            document.getElementById('aiTravelTime').textContent = data.travelTime;
            document.getElementById('aiPrecautions').textContent = data.precautions;
            document.getElementById('safetyWind').textContent = data.wind;
            document.getElementById('safetyWave').textContent = data.wave;
            document.getElementById('safetyTide').textContent = data.tide;
        } catch (e) {
            console.error(e);
            document.getElementById('aiKeyFeatures').textContent = "ì •ë³´ ì—†ìŒ";
        }
    }

    // ë§ˆì»¤ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ (canvas í´ë¦­ ì´ë²¤íŠ¸ì— í†µí•© í•„ìš”)
    // ì˜ˆì œì—ì„œëŠ” ê°„ë‹¨íˆ ê²€ìƒ‰ ì‹œ í˜¸ì¶œë˜ë„ë¡ ì²˜ë¦¬

    document.getElementById('searchBtn').addEventListener('click', () => {
        const val = document.getElementById('searchInput').value;
        const found = allHarbors.find(h => h.harbor.includes(val));
        if(found) {
            mapCenter = {lat: found.lat, lon: found.lon};
            drawMap();
            document.getElementById('locationLabelWrapper').style.display = 'none';
            document.getElementById('analysisContent').style.display = 'block';
            document.getElementById('selectedHarborName').textContent = found.harbor;
            document.getElementById('harborAddress').textContent = found.address;
            document.getElementById('aiFieldAdvice').textContent = found.advice;
            
            getAnalysis(found);
        } else {
            alert('í•­êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜ˆ: í•œí™”ì˜¤ì…˜, ë‚´ê°„í•­)');
        }
    });

    // --- ì´ˆê¸°í™” ë¡œì§ ---
    window.addEventListener('load', () => {
        const splash = document.getElementById('splash-screen');
        const app = document.getElementById('app-container');

        // 2ì´ˆ í›„ ì‹¤í–‰
        setTimeout(() => {
            splash.classList.add('hidden'); // ìŠ¤í”Œë˜ì‹œ ìˆ¨ê¹€
            app.style.display = 'flex';     // ì•± í‘œì‹œ
            
            // [ì¤‘ìš”] ì§€ë„ê°€ í‘œì‹œëœ(flex) ì§í›„ì— ì‚¬ì´ì¦ˆë¥¼ ê³„ì‚°í•´ì•¼ í•¨
            // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € ë Œë”ë§ ì§í›„ ì‹¤í–‰ ë³´ì¥
            requestAnimationFrame(() => {
                initMap();      // ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ë° ì´ë²¤íŠ¸ ì—°ê²°
                resizeCanvas(); // í¬ê¸° ë§ì¶¤ ë° ê·¸ë¦¬ê¸°
                
                // ìŠ¤í”Œë˜ì‹œ DOM ì œê±°
                setTimeout(() => { if(splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
            });
            
        }, 2000);
    });

</script>
</body>
</html>
