<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</title>
  
  <style>
    /* --- 1. ê¸°ë³¸ ì„¤ì • --- */
    body {
      box-sizing: border-box; margin: 0; padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121; height: 100%; overflow: hidden;
    }
    * { box-sizing: border-box; }
    html { height: 100%; }

    /* ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #ffffff; display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }
    .splash-fallback { font-size: 24px; font-weight: bold; color: #1565c0; display: none; text-align: center; }
    #splash-screen.hidden { opacity: 0; pointer-events: none; }

    /* ë ˆì´ì•„ì›ƒ */
    .container { display: none; flex-direction: column; height: 100%; max-width: 100%; margin: 0 auto; }
    
    .header {
      background: #ffffff; padding: 0.8rem 2rem; text-align: left;
      border-bottom: 3px solid #1565c0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex; flex-direction: row; align-items: center; justify-content: center; 
      gap: 1.5rem; height: 90px; flex-shrink: 0;
    }
    .header-logo { height: 60px; width: auto; object-fit: contain; }
    .header-content { display: flex; flex-direction: column; justify-content: center; }
    .header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #1a237e; }
    .header p { margin: 0; font-size: 0.95rem; color: #616161; }

    .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* ì§€ë„ ì˜ì—­ */
    .map-container { flex: 1; position: relative; background: #aadaff; overflow: hidden; }
    #mapCanvas { width: 100%; height: 100%; cursor: grab; touch-action: none; display: block; }
    #mapCanvas:active { cursor: grabbing; }

    .zoom-controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
    .map-control-btn {
      width: 44px; height: 44px; background: white; border: 1px solid #e0e0e0;
      border-radius: 8px; font-size: 20px; font-weight: 600; color: #424242;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .map-control-btn:hover { background: #f5f5f5; color: #1565c0; }

    .region-selector {
      position: absolute; top: 20px; right: 74px;
      background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); z-index: 10;
      display: none; flex-direction: column; gap: 6px; min-width: 110px;
    }
    .region-selector.active { display: flex; }
    .region-btn {
      background: #1565c0; color: white; border: none; padding: 8px;
      border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
    }

    /* ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ */
    .map-image-preview {
      position: absolute; bottom: 30px; right: 30px; width: 300px; 
      background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 20; overflow: hidden; display: none;
    }
    .map-image-preview.active { display: block; }
    .map-image-preview img { width: 100%; height: 180px; object-fit: cover; display: block; }
    .preview-title {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.7); color: white; padding: 8px 12px;
      font-size: 1rem; font-weight: 600;
    }
    .preview-close {
      position: absolute; top: 5px; right: 10px; color: white;
      font-size: 28px; font-weight: bold; cursor: pointer; text-shadow: 0 0 3px rgba(0,0,0,0.8);
    }

    /* ì •ë³´ íŒ¨ë„ */
    .info-panel {
      width: 100%; max-width: 380px; background: #ffffff;
      padding: 1.2rem; overflow-y: auto; border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
    }
    .info-panel h2 {
      margin: 0 0 0.8rem 0; font-size: 1.1rem; color: #212121;
      border-bottom: 2px solid #1565c0; padding-bottom: 0.4rem;
    }

    /* â˜… í•­êµ¬ ì´ë¦„ ë° êµ¬ë¶„ì„  ë””ìì¸ ìˆ˜ì • â˜… */
    #selectedHarborName {
        color: #1565c0; /* íŒŒë€ìƒ‰ ê°•ì¡° */
        font-size: 1.4rem;
        font-weight: 800;
        margin: 0 0 10px 0;
        padding-bottom: 10px;
        border-bottom: 3px solid #1565c0; /* íŒŒë€ìƒ‰ êµ¬ë¶„ì„  */
    }

    /* â˜… ì£¼ì†Œ ë° ë³µì‚¬ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ â˜… */
    .address-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f5f5f5;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    #harborAddress {
        font-size: 0.9rem; color: #424242; margin: 0; flex: 1;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .copy-btn {
        background: #e0e0e0; color: #333; border: 1px solid #ccc;
        padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;
        cursor: pointer; margin-left: 8px; flex-shrink: 0;
    }
    .copy-btn:hover { background: #d5d5d5; }


    /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .line-break-text { white-space: pre-line; word-break: keep-all; line-height: 1.5; display: block; }
    .adaptive-font { font-size: 0.9rem; }
    .adaptive-font.small { font-size: 0.8rem; line-height: 1.3; }

    .analysis-section {
      margin-bottom: 0.8rem; padding: 0.7rem;
      border: 1px solid #e0e0e0; border-radius: 8px; background: #f9faff;
      height: auto; 
    }
    .analysis-section h4 {
      font-size: 0.9rem; font-weight: 700; margin: 0 0 0.5rem 0;
      color: #333; border-bottom: 1px solid #eee; padding-bottom: 4px;
    }
    .analysis-section p { font-size: 0.9rem; color: #424242; margin: 0; }

    .route-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .safety-info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
    
    .info-block { 
      background: #fff; border: 1px solid #e8e8e8; border-radius: 6px; padding: 0.5rem; 
      text-align: center; display: flex; flex-direction: column; justify-content: center;
      min-height: 60px;
    }
    .info-block h5 { font-size: 0.75rem; color: #1565c0; margin: 0 0 0.3rem 0; font-weight: 700; }
    .info-block p { font-weight: 600; color: #333; margin: 0; word-break: keep-all; white-space: pre-line; }

    .search-container { display: flex; gap: 8px; margin-bottom: 1rem; }
    #searchInput { flex: 1; padding: 10px; border: 2px solid #1a237e; border-radius: 8px; }
    .search-btn { padding: 0 15px; background: #1a237e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .search-results { max-height: 200px; overflow-y: auto; display: none; margin-bottom: 1rem; }
    .search-results.active { display: block; }
    .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .search-result-item:hover { background: #f5f5f5; }

    #navButtons a { transition: background-color 0.2s; }
    #navButtons a:hover { opacity: 0.9; }
    .tile-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(25, 118, 210, 0.9); color: white; padding: 0.8rem 1.2rem; border-radius: 50px; font-size: 0.9rem; font-weight: 600; z-index: 5; display: flex; align-items: center; }
    .spinner { width: 1em; height: 1em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; display: inline-block; animation: spinner-spin 0.75s linear infinite; vertical-align: middle; margin-right: 5px; }
    @keyframes spinner-spin { to { transform: rotate(360deg); } }
    .loading { color: #9e9e9e; font-style: italic; font-size: 0.85rem !important; font-weight: normal !important;}
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 350px; width: 90%; text-align: center;}
    .modal-button { background: #1565c0; color: white; border: none; padding: 8px 20px; border-radius: 6px; margin-top: 15px; cursor: pointer; }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .header { padding: 0.5rem 1rem; justify-content: flex-start; height: 60px; gap: 0.8rem; }
      .header-logo { height: 35px; } 
      .header h1 { font-size: 1.1rem; }
      .header p { display: none; }
      .map-container { height: 40vh; flex: none; transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s ease; }
      .info-panel { max-width: 100%; flex: 1; border-top: 2px solid #1565c0; border-left: none; }
      .map-image-preview { display: none !important; }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" 
         alt="KCA ë¡œê³ " 
         onerror="this.style.display='none'; document.querySelector('.splash-fallback').style.display='block';">
    <div class="splash-fallback">í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì›<br>ë¶€ì‚°ë³¸ë¶€</div>
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" alt="KCA" class="header-logo" onerror="this.style.display='none'">
      <div class="header-content">
        <h1 id="appTitle">í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</h1>
        <p id="subtitle">KCA ë¶€ì‚°ë³¸ë¶€ ë¬´ì„ êµ­ ê²€ì‚¬ ì§€ì› ì‹œìŠ¤í…œ</p>
      </div>
    </div>

    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        
        <div class="zoom-controls">
          <button class="map-control-btn" id="zoomIn">+</button>
          <button class="map-control-btn" id="zoomOut">âˆ’</button>
          <button class="map-control-btn" id="gpsBtn" title="ë‚´ ìœ„ì¹˜">ğŸ›°ï¸</button>
          <button class="map-control-btn" id="locationToggle" title="ì§€ì—­ ì„ íƒ">ğŸ“</button>
        </div>

        <div class="region-selector" id="regionSelector">
          <button class="region-btn" data-region="all">ì „ì²´ë³´ê¸°</button>
          <button class="region-btn" data-region="busan">ë¶€ì‚°</button>
          <button class="region-btn" data-region="ulsan">ìš¸ì‚°</button>
          <button class="region-btn" data-region="geoje">ê±°ì œ</button>
          <button class="region-btn" data-region="tongyeong">í†µì˜</button>
          <button class="region-btn" data-region="changwon">ì°½ì›</button>
          <button class="region-btn" data-region="namhae">ë‚¨í•´</button>
          <button class="region-btn" data-region="sacheon">ì‚¬ì²œ</button>
          <button class="region-btn" data-region="hadong">í•˜ë™</button>
          <button class="region-btn" data-region="goseong">ê³ ì„±</button>
        </div>

        <div class="tile-loading" id="tileLoading" style="display: none;">
            <span class="spinner"></span><span>ì§€ë„ ë¡œë”© ì¤‘...</span>
        </div>

        <div class="map-image-preview" id="mapImagePreview">
            <span class="preview-close" id="closePreviewBtn">&times;</span>
            <img id="previewImg" src="" alt="í•­êµ¬ ì´ë¯¸ì§€">
            <div class="preview-title" id="previewTitle">í•­êµ¬ëª…</div>
        </div>

      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">í•­Â·í¬Â·êµ¬ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="í•­í¬êµ¬ ì´ë¦„ ê²€ìƒ‰...">
          <button id="searchBtn" class="search-btn">ğŸ”</button>
        </div>
        <div id="searchResults" class="search-results"></div>

        <div id="locationLabelWrapper" style="text-align:center; color:#666; padding: 20px;">
            <p><strong>ì§€ë„ì—ì„œ ì§€ì—­ ë˜ëŠ” í•­êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</strong></p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName"></h3>
            <div class="address-row">
                <p id="harborAddress"></p>
                <button class="copy-btn" onclick="copyAddress()">ì£¼ì†Œë³µì‚¬</button>
            </div>
            
            <div id="navButtons" style="display:flex; gap:8px; margin-bottom:15px;">
                <a id="tmapBtn" href="#" target="_blank" style="flex:1; background:#1565c0; color:white; padding:10px; text-align:center; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:600;">TMAP</a>
                <a id="naverBtn" href="#" target="_blank" style="flex:1; background:#03C75A; color:white; padding:10px; text-align:center; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:600;">ë„¤ì´ë²„ì§€ë„</a>
            </div>

            <div class="analysis-section">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <p id="aiKeyFeatures" class="loading line-break-text"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>
            
            <div class="analysis-section" style="border-left: 3px solid #ff5722;">
                <h4 style="color:#d84315;">ì„ ë°• ë¬´ì„ êµ­ ê²€ì‚¬ ê³ ë ¤ì‚¬í•­</h4>
                <p id="aiInspectionTips" class="loading line-break-text"><span class="spinner"></span> ë¶„ì„ ì¤‘...</p>
            </div>

            <div class="analysis-section">
                <h4>í˜„ì¥ ì¡°ì–¸</h4>
                <p id="aiFieldAdvice" class="line-break-text"></p>
            </div>

            <div class="analysis-section">
                <h4>ì´ë™ ê²½ë¡œ & ì•ˆì „ (ìµœì†Œ ì‹œê°„)</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ì˜ˆìƒ ì†Œìš”ì‹œê°„</h5>
                        <p id="aiTravelTime" class="loading adaptive-font"><span class="spinner"></span>...</p>
                    </div>
                    <div class="info-block">
                        <h5>êµí†µ ì£¼ì˜</h5>
                        <p id="aiPrecautions" class="loading line-break-text adaptive-font"><span class="spinner"></span>...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>ì‹¤ì‹œê°„ í•´ìƒ ë‚ ì”¨ (ìˆ˜ì¹˜)</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                        <h5>í’ì†/í’í–¥</h5>
                        <p id="safetyWind" class="loading">...</p>
                    </div>
                    <div class="info-block">
                        <h5>íŒŒê³ </h5>
                        <p id="safetyWave" class="loading">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì¡°ë¥˜</h5>
                        <p id="safetyTide" class="loading">...</p>
                    </div>
                </div>
            </div>
            
            <div class="analysis-section">
                <h4>ë¬¼ë•Œ ì‹œê°„</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ë§Œì¡°</h5>
                        <p id="tideHighTime" class="loading">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ê°„ì¡°</h5>
                        <p id="tideLowTime" class="loading">...</p>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
      <p id="modalMessage"></p>
      <button class="modal-button" id="modalClose">í™•ì¸</button>
    </div>
  </div>

<script>
async function callGeminiAPI(prompt) {
  try {
    const response = await fetch('api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'API Error');
    return data.result;
  } catch (error) {
    console.error('Gemini Error:', error);
    throw error;
  }
}

function extractJSON(text) {
  try {
    const s = text.indexOf('{');
    const e = text.lastIndexOf('}');
    if (s !== -1 && e !== -1) return JSON.parse(text.substring(s, e + 1));
    return JSON.parse(text);
  } catch (e) { return { error: "íŒŒì‹± ì‹¤íŒ¨" }; }
}

const regionImages = {
    'ë¶€ì‚°': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR4bFpReu_rQ98w_C1XFq3_k5L4h6P5f5_c5A&s',
    'ìš¸ì‚°': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Ulsan_Bridge.jpg/250px-Ulsan_Bridge.jpg',
    'ê²½ë‚¨-ì°½ì›': 'https://www.changwon.go.kr/cwportal/10310/10429/10433.web?gcode=1011&idx=167', 
    'ê²½ë‚¨-í†µì˜': 'https://www.tongyeong.go.kr/images/tour/contents/P0400000/img_01.jpg',
    'ê²½ë‚¨-ê±°ì œ': 'https://tour.geoje.go.kr/images/tour/main/img_visual01.jpg',
    'ê²½ë‚¨-ë‚¨í•´': 'https://www.namhae.go.kr/res/tour/img/main/visual_01.jpg',
    'ê²½ë‚¨-ì‚¬ì²œ': 'https://www.sacheon.go.kr/res/tour/img/main/visual_img01.jpg',
    'ê²½ë‚¨-í•˜ë™': 'https://www.hadong.go.kr/images/tour/sub/sub01_01_01_img01.jpg',
    'ê²½ë‚¨-ê³ ì„±': 'https://www.goseong.go.kr/res/tour/img/main/visual_01.jpg'
};

const sampleHarbors = [ 
    {harbor: 'í•œí™”ì˜¤ì…˜', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œëŒ€ë¡œ 3370', lat: 34.869797, lon: 128.697627, advice: 'ë³´ì•ˆ êµ¬ì—­ ì§„ì… ì‹œ ì‹ ë¶„ì¦ í•„ìˆ˜ ì§€ì°¸. í†µì‹ ì‹¤ì¥ ì‚¬ì „ ì—°ë½ ìš”ë§.'},
    {harbor: 'ë‚´ê°„í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë‚´ê°„ë¦¬', lat: 34.846273, lon: 128.567096, advice: 'ì–´ì´Œê³„ì¥ë‹˜ í˜‘ì¡°ê°€ ì˜ ë˜ëŠ” í¸ì„.'},
    {harbor: 'ë²•ë™í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë²•ë™ë¦¬', lat: 34.82242, lon: 128.519491, advice: 'ì†Œí˜• ì„ ë°•ì´ ë§ì•„ ì ‘ì•ˆ ì‹œ ì£¼ì˜ í•„ìš”.'},
    {harbor: 'ë¶€ì‚°í•­', region: 'ë¶€ì‚°', address: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬', lat: 35.105, lon: 129.040, advice: 'ëŒ€í˜• ì„ ë°• ì…ì¶œí•­ ì¦ìŒ.'}
];

const regionalMarkers = {
    'ë¶€ì‚°': { lat: 35.18, lon: 129.08, count: 0, regionKey: 'ë¶€ì‚°' },
    'ìš¸ì‚°': { lat: 35.53, lon: 129.35, count: 0, regionKey: 'ìš¸ì‚°' },
    'ê²½ë‚¨-ì°½ì›': { lat: 35.19, lon: 128.57, count: 0, regionKey: 'ê²½ë‚¨-ì°½ì›' },
    'ê²½ë‚¨-í†µì˜': { lat: 34.84, lon: 128.43, count: 0, regionKey: 'ê²½ë‚¨-í†µì˜' },
    'ê²½ë‚¨-ê±°ì œ': { lat: 34.88, lon: 128.69, count: 0, regionKey: 'ê²½ë‚¨-ê±°ì œ' },
    'ê²½ë‚¨-ë‚¨í•´': { lat: 34.83, lon: 127.89, count: 0, regionKey: 'ê²½ë‚¨-ë‚¨í•´' },
    'ê²½ë‚¨-ì‚¬ì²œ': { lat: 34.92, lon: 128.06, count: 0, regionKey: 'ê²½ë‚¨-ì‚¬ì²œ' },
    'ê²½ë‚¨-í•˜ë™': { lat: 34.94, lon: 127.87, count: 0, regionKey: 'ê²½ë‚¨-í•˜ë™' },
    'ê²½ë‚¨-ê³ ì„±': { lat: 34.97, lon: 128.32, count: 0, regionKey: 'ê²½ë‚¨-ê³ ì„±' }
};

// ì •í™•í•œ ì¢Œí‘œ ë§¤í•‘ì„ ìœ„í•œ ê°ì²´
const regionCoordinates = {
    'all': { lat: 35.1194, lon: 129.0447, zoom: 9 },
    'busan': { lat: 35.18, lon: 129.08, zoom: 11 },
    'ulsan': { lat: 35.53, lon: 129.35, zoom: 11 },
    'changwon': { lat: 35.19, lon: 128.57, zoom: 11 },
    'tongyeong': { lat: 34.84, lon: 128.43, zoom: 11 },
    'geoje': { lat: 34.88, lon: 128.69, zoom: 11 },
    'namhae': { lat: 34.83, lon: 127.89, zoom: 11 },
    'sacheon': { lat: 34.92, lon: 128.06, zoom: 11 },
    'hadong': { lat: 34.94, lon: 127.87, zoom: 11 },
    'goseong': { lat: 34.97, lon: 128.32, zoom: 11 }
};

let allHarbors = sampleHarbors;
let mapCenter = { lat: 35.1194, lon: 129.0447 };
let mapZoom = 9; 
let canvas, ctx;
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let markers = []; 
let selectedLocation = null;
let userLocation = null;
let resizeTimeout;
const TILE_SIZE = 256;
const OSM_TILE_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
const KCA_BUSAN_LAT = 35.1194;
const KCA_BUSAN_LON = 129.0447;
const KCA_BUSAN_NAME = "í•œêµ­ë°©ì†¡í†µì‹ ì „íŒŒì§„í¥ì› ë¶€ì‚°ë³¸ë¶€";

function preprocessHarbors() {
    Object.keys(regionalMarkers).forEach(key => regionalMarkers[key].count = 0);
    allHarbors.forEach(h => {
        if(h.region.includes('ë¶€ì‚°')) regionalMarkers['ë¶€ì‚°'].count++;
        else if(h.region.includes('ìš¸ì‚°')) regionalMarkers['ìš¸ì‚°'].count++;
        else {
            Object.keys(regionalMarkers).forEach(key => {
                if(regionalMarkers[key].regionKey === h.region) {
                    regionalMarkers[key].count++;
                }
            });
        }
    });
}

function initMap() {
    canvas = document.getElementById('mapCanvas');
    ctx = canvas.getContext('2d');
    
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(resizeCanvas, 100); 
    });
    
    canvas.addEventListener('mousedown', e => { isDragging = true; dragStart = {x:e.clientX, y:e.clientY}; });
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('wheel', handleWheel);
    
    canvas.addEventListener('touchstart', e => { 
        isDragging = true; 
        dragStart = {x:e.touches[0].clientX, y:e.touches[0].clientY}; 
    });
    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!isDragging) return;
        const dx = e.touches[0].clientX - dragStart.x;
        const dy = e.touches[0].clientY - dragStart.y;
        mapCenter.lon -= dx * 0.003 * (360 / Math.pow(2, mapZoom));
        mapCenter.lat += dy * 0.003 * (180 / Math.pow(2, mapZoom));
        dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        drawMap();
    });
    canvas.addEventListener('touchend', () => { isDragging = false; });

    preprocessHarbors();
    setupScrollInteraction();
}

function resizeCanvas() {
    const container = canvas.parentElement;
    if (container.clientWidth > 0) {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        drawMap();
    }
}

function latLonToPixel(lat, lon) {
    const scale = Math.pow(2, mapZoom);
    const worldX = (lon + 180) / 360 * TILE_SIZE * scale;
    const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
    const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
    const centerWorld = { x: centerTile.x * TILE_SIZE + TILE_SIZE/2, y: centerTile.y * TILE_SIZE + TILE_SIZE/2 };
    return { x: canvas.width/2 + (worldX - centerWorld.x), y: canvas.height/2 + (worldY - centerWorld.y) };
}
function latLonToTile(lat, lon, zoom) {
    const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
    const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
    return { x, y };
}
function tileToLatLon(x, y, zoom) {
    const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
    const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
    const lon = x / Math.pow(2, zoom) * 360 - 180;
    return { lat, lon };
}

function drawMap() {
    if (!ctx || canvas.width === 0) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#aadaff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
    const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
    const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
    const startX = centerTile.x - Math.floor(tilesX / 2);
    const startY = centerTile.y - Math.floor(tilesY / 2);

    for (let i = 0; i < tilesX; i++) {
        for (let j = 0; j < tilesY; j++) {
            const tx = startX + i, ty = startY + j;
            const max = Math.pow(2, mapZoom);
            if (tx >= 0 && tx < max && ty >= 0 && ty < max) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = OSM_TILE_URL.replace('{z}', mapZoom).replace('{x}', tx).replace('{y}', ty);
                if (img.complete) {
                     const tLatLon = tileToLatLon(tx, ty, mapZoom);
                     const pos = latLonToPixel(tLatLon.lat, tLatLon.lon);
                     ctx.drawImage(img, pos.x, pos.y, TILE_SIZE, TILE_SIZE);
                } else {
                    img.onload = () => { drawMap(); };
                }
            }
        }
    }
    drawMarkers();
}

function drawMarkers() {
    markers = [];
    if (mapZoom < 10) {
        Object.keys(regionalMarkers).forEach(key => {
            const r = regionalMarkers[key];
            if (r.count > 0) {
                const pos = latLonToPixel(r.lat, r.lon);
                markers.push({ type: 'region', name: key, count: r.count, x: pos.x, y: pos.y, lat: r.lat, lon: r.lon });
            }
        });
    } else {
        allHarbors.forEach(h => {
            const pos = latLonToPixel(h.lat, h.lon);
            if (pos.x > -50 && pos.x < canvas.width + 50 && pos.y > -50 && pos.y < canvas.height + 50) {
                markers.push({ type: 'harbor', ...h, x: pos.x, y: pos.y });
            }
        });
    }

    markers.forEach(m => {
        if (m.type === 'region') {
            ctx.beginPath();
            ctx.arc(m.x, m.y, 22, 0, Math.PI * 2);
            ctx.fillStyle = '#1565c0';
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ffffff';
            ctx.stroke();
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(m.name, m.x, m.y - 6);
            ctx.font = '11px sans-serif';
            ctx.fillText(`${m.count}ê³³`, m.x, m.y + 8);
        } 
        else {
            const isSelected = selectedLocation && selectedLocation.harbor === m.harbor;
            const color = isSelected ? '#ff5722' : '#1976d2';
            
            ctx.beginPath();
            ctx.arc(m.x, m.y, 12, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(m.x, m.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(m.x, m.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff';
            ctx.fill();

            if (isSelected || mapZoom > 11) {
                ctx.font = 'bold 13px sans-serif';
                ctx.textAlign = 'center';
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#ffffff';
                ctx.strokeText(m.harbor, m.x, m.y + 24);
                ctx.fillStyle = '#0d47a1';
                ctx.fillText(m.harbor, m.x, m.y + 24);
            }
        }
    });
    
    if (userLocation) {
        const uPos = latLonToPixel(userLocation.lat, userLocation.lon);
        ctx.beginPath();
        ctx.arc(uPos.x, uPos.y, 8, 0, Math.PI*2);
        ctx.fillStyle = '#4caf50';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#fff';
        ctx.stroke();
    }
}

function handleMouseMove(e) {
    if (!isDragging) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    mapCenter.lon -= dx * 0.003 * (360 / Math.pow(2, mapZoom));
    mapCenter.lat += dy * 0.003 * (180 / Math.pow(2, mapZoom));
    dragStart = { x: e.clientX, y: e.clientY };
    drawMap();
}
function handleMouseUp(e) {
    if (isDragging) {
        const dx = Math.abs(e.clientX - dragStart.x);
        const dy = Math.abs(e.clientY - dragStart.y);
        if (dx < 5 && dy < 5) checkClick(e);
    }
    isDragging = false;
}
function handleWheel(e) {
    e.preventDefault();
    if (e.deltaY < 0) mapZoom = Math.min(18, mapZoom + 1);
    else mapZoom = Math.max(5, mapZoom - 1);
    drawMap();
}

function checkClick(e) {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    let clicked = null;
    
    for (let i = markers.length - 1; i >= 0; i--) {
        const m = markers[i];
        const yOffset = (m.type === 'region') ? 0 : 0;
        const radius = (m.type === 'region') ? 22 : 15;
        const dist = Math.sqrt(Math.pow(clickX - m.x, 2) + Math.pow(clickY - (m.y + yOffset), 2));
        if (dist < radius) {
            clicked = m;
            break;
        }
    }
    
    if (clicked) {
        if (clicked.type === 'region') {
            mapCenter = { lat: clicked.lat, lon: clicked.lon };
            mapZoom = 11; 
            drawMap();
        } else {
            selectedLocation = clicked;
            updateLocationInfo(clicked);
            drawMap();
        }
    }
}

async function getAnalysis(harbor) {
    const textPrompt = `
    ì—­í• : KCA ë¶€ì‚°ë³¸ë¶€ ì„ ë°• ë¬´ì„ êµ­ ê²€ì‚¬ ì§€ì› AI.
    ëŒ€ìƒ: ${harbor.harbor} (${harbor.address})
    ì°¸ê³ : "${harbor.advice || 'ì—†ìŒ'}"
    ìš”ì²­: 'í•µì‹¬ íŠ¹ì§•'ê³¼ 'ê²€ì‚¬ ê³ ë ¤ì‚¬í•­'ë§Œ ì‘ì„±.
    ê·œì¹™: 2~3ì¤„ ë‚´ì™¸ë¡œ ì¤„ë°”ê¿ˆí•˜ì—¬ ì‘ì„±.
    JSON: { "keyFeatures": "- íŠ¹ì§•1\\n- íŠ¹ì§•2", "inspectionTips": "- íŒ1\\n- íŒ2" }
    `;
    
    const dataPrompt = `
    ì—­í• : í•´ì–‘ ë°ì´í„° AI.
    ëŒ€ìƒ: ${harbor.harbor}
    ìš”ì²­: ì‹œê°„, êµí†µ, í•´ìƒë‚ ì”¨ ìˆ˜ì¹˜ë§Œ.
    ê·œì¹™: ì‹œê°„ "ì•½ 00ë¶„", êµí†µì€ í•µì‹¬ë§Œ ì¤„ë°”ê¿ˆ(20ì ë‚´ì™¸), ë‚ ì”¨ëŠ” ìˆ˜ì¹˜ë§Œ.
    JSON: { "travelTime": "ì•½ 45ë¶„", "precautions": "ê³µì‚¬êµ¬ê°„\\nì§„ì…ë¡œ ì£¼ì˜", "wind": "4m/s", "wave": "0.5m", "tide": "0.5kn", "highTide": "09:00", "lowTide": "15:00" }
    `;

    callGeminiAPI(textPrompt).then(text => {
        const data = extractJSON(text);
        document.getElementById('aiKeyFeatures').innerText = data.keyFeatures;
        document.getElementById('aiInspectionTips').innerText = data.inspectionTips;
        document.getElementById('aiKeyFeatures').classList.remove('loading');
        document.getElementById('aiInspectionTips').classList.remove('loading');
    }).catch(e => console.error(e));

    callGeminiAPI(dataPrompt).then(text => {
        const data = extractJSON(text);
        document.getElementById('aiTravelTime').innerText = data.travelTime;
        document.getElementById('aiPrecautions').innerText = data.precautions;
        
        if (data.precautions.length > 15) {
            document.getElementById('aiPrecautions').classList.add('small');
        }

        document.getElementById('safetyWind').innerText = data.wind;
        document.getElementById('safetyWave').innerText = data.wave;
        document.getElementById('safetyTide').innerText = data.tide;
        document.getElementById('tideHighTime').innerText = data.highTide;
        document.getElementById('tideLowTime').innerText = data.lowTide;
        
        document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
    }).catch(e => console.error(e));
}

function updateLocationInfo(location) {
    document.getElementById('locationLabelWrapper').style.display = 'none';
    document.getElementById('analysisContent').style.display = 'block';
    
    document.getElementById('selectedHarborName').textContent = location.harbor;
    document.getElementById('harborAddress').textContent = location.address;
    
    const previewBox = document.getElementById('mapImagePreview');
    const previewImg = document.getElementById('previewImg');
    const regionKey = Object.keys(regionImages).find(key => location.region.includes(key)) || 'ë¶€ì‚°';
    previewImg.src = regionImages[regionKey] || 'https://via.placeholder.com/240x140?text=No+Image';
    document.getElementById('previewTitle').textContent = location.harbor;
    previewBox.classList.add('active');

    const ids = ['aiKeyFeatures', 'aiInspectionTips', 'aiTravelTime', 'aiPrecautions', 'safetyWind', 'safetyWave', 'safetyTide', 'tideHighTime', 'tideLowTime'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
        el.classList.add('loading');
        el.classList.remove('small');
    });
    document.getElementById('aiFieldAdvice').innerText = location.advice || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ';

    const tmapBtn = document.getElementById('tmapBtn');
    const naverBtn = document.getElementById('naverBtn');
    const destName = encodeURIComponent(location.harbor);
    
    if (window.innerWidth > 1500) { 
        tmapBtn.style.display = 'none';
        naverBtn.textContent = "ë„¤ì´ë²„ ì§€ë„ (ê¸¸ì°¾ê¸°)";
        let sLat = userLocation ? userLocation.lat : KCA_BUSAN_LAT;
        let sLon = userLocation ? userLocation.lon : KCA_BUSAN_LON;
        let sName = userLocation ? "í˜„ì¬ìœ„ì¹˜" : KCA_BUSAN_NAME;
        const sNameEnc = encodeURIComponent(sName);
        naverBtn.href = `https://map.naver.com/p/directions/${sLat},${sLon},${sNameEnc}/${location.lat},${location.lon},${destName}/-/car`;
    } else { 
        tmapBtn.style.display = 'block';
        naverBtn.textContent = "ë„¤ì´ë²„ì§€ë„";
        tmapBtn.href = `tmap://route?goalname=${destName}&goaly=${location.lat}&goalx=${location.lon}`;
        naverBtn.href = `nmap://route/public?dlat=${location.lat}&dlng=${location.lon}&dname=${destName}&appname=com.kca.busan`;
    }

    getAnalysis(location);
}

function copyAddress() {
    const address = document.getElementById('harborAddress').innerText;
    if (!address) return;
    
    const tempInput = document.createElement("textarea");
    tempInput.value = address;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    
    alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + address);
}

function setupScrollInteraction() {
    const infoPanel = document.getElementById('info-panel');
    const mapContainer = document.querySelector('.map-container');
    if (!infoPanel || !mapContainer) return;
    
    infoPanel.addEventListener('scroll', () => {
        if (window.innerWidth > 768) return; 
        if (infoPanel.scrollTop > 100) {
            mapContainer.style.height = '0';
            mapContainer.style.opacity = '0';
        } else {
            mapContainer.style.height = '40vh';
            mapContainer.style.opacity = '1';
        }
    });
}

function getUserLocation() {
    if (navigator.geolocation) {
        const btn = document.getElementById('gpsBtn');
        btn.innerHTML = 'â³';
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                mapCenter = { lat: userLocation.lat, lon: userLocation.lon };
                mapZoom = 12;
                drawMap();
                btn.innerHTML = 'ğŸ›°ï¸';
            },
            (error) => { 
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                mapCenter = { lat: KCA_BUSAN_LAT, lon: KCA_BUSAN_LON };
                mapZoom = 12;
                drawMap();
                btn.innerHTML = 'ğŸ›°ï¸';
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    } else {
        alert("ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

function performSearch() {
    const val = document.getElementById('searchInput').value;
    const found = allHarbors.find(h => h.harbor.includes(val));
    if(found) {
        mapCenter = { lat: found.lat, lon: found.lon };
        mapZoom = 14;
        drawMap();
        setTimeout(() => { selectedLocation = found; updateLocationInfo(found); drawMap(); }, 100);
    } else { alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); }
}

window.addEventListener('load', () => {
    const splash = document.getElementById('splash-screen');
    const app = document.getElementById('app-container');
    
    setTimeout(() => {
        splash.classList.add('hidden');
        app.style.display = 'flex';
        requestAnimationFrame(() => {
            initMap();
            resizeCanvas();
            setTimeout(() => { if(splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
        });
    }, 2000);

    document.getElementById('zoomIn').addEventListener('click', () => { mapZoom = Math.min(18, mapZoom + 1); drawMap(); });
    document.getElementById('zoomOut').addEventListener('click', () => { mapZoom = Math.max(5, mapZoom - 1); drawMap(); });
    document.getElementById('gpsBtn').addEventListener('click', getUserLocation);
    
    document.getElementById('locationToggle').addEventListener('click', () => {
        const selector = document.getElementById('regionSelector');
        selector.classList.toggle('active');
    });

    document.querySelectorAll('.region-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const r = e.target.dataset.region;
            if (regionCoordinates[r]) {
                mapCenter = { lat: regionCoordinates[r].lat, lon: regionCoordinates[r].lon };
                mapZoom = regionCoordinates[r].zoom;
            }
            document.getElementById('regionSelector').classList.remove('active');
            drawMap();
        });
    });

    document.getElementById('closePreviewBtn').addEventListener('click', () => {
        document.getElementById('mapImagePreview').classList.remove('active');
    });

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });
});
</script>
</body>
</html>
