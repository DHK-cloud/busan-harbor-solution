<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</title>
  
  <style>
    /* --- 1. ê¸°ë³¸ ì„¤ì • ë° ë ˆì´ì•„ì›ƒ --- */
    body {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      color: #212121;
      height: 100%; overflow: hidden;
    }
    * { box-sizing: border-box; }
    html { height: 100%; }

    /* --- 2. ìŠ¤í”Œë˜ì‹œ ìŠ¤í¬ë¦° (ë¡œê³  ê¹¨ì§ ë°©ì§€ ìˆ˜ì •) --- */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #ffffff;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.5s ease;
    }
    /* ë¡œê³ ê°€ ì—†ì„ ë•Œ í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´í•˜ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ */
    .splash-fallback { font-size: 24px; font-weight: bold; color: #1565c0; display: none; }
    #splash-screen.hidden { opacity: 0; pointer-events: none; }

    /* --- 3. ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
    .container {
      display: none; /* ë¡œë”© í›„ flexë¡œ ë³€ê²½ */
      flex-direction: column; height: 100%; max-width: 100%; margin: 0 auto;
    }

    .header {
      background: #ffffff; padding: 1rem 1.5rem; text-align: center;
      border-bottom: 3px solid #1565c0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex; align-items: center; justify-content: center; gap: 1.5rem;
      height: 70px; flex-shrink: 0;
    }
    .header-logo { height: 40px; width: auto; object-fit: contain; }
    .header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; color: #1a237e; }
    .header p { margin: 0; font-size: 0.9rem; color: #616161; }

    .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* --- 4. ì§€ë„ ìŠ¤íƒ€ì¼ --- */
    .map-container {
      flex: 1; position: relative; background: #aadaff; overflow: hidden;
      transition: height 0.4s ease-out, opacity 0.4s ease-out;
    }
    #mapCanvas { width: 100%; height: 100%; cursor: grab; touch-action: none; }
    #mapCanvas:active { cursor: grabbing; }

    .zoom-controls {
      position: absolute; top: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 10px; z-index: 10;
    }
    .map-control-btn {
      width: 44px; height: 44px; background: white;
      border: 1px solid #e0e0e0; border-radius: 8px;
      font-size: 20px; font-weight: 600; color: #424242;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .map-control-btn:hover { background: #f5f5f5; color: #1565c0; }
    .map-control-btn.active { background: #1565c0; color: white; border-color: #1565c0; }

    /* ì§€ì—­ ì„ íƒê¸° */
    .region-selector {
      position: absolute; top: 20px; right: 74px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px; padding: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 10; display: none; flex-direction: column; gap: 8px; min-width: 120px;
    }
    .region-selector.active { display: flex; }
    .region-btn {
      background: #1565c0; color: white; border: none; padding: 10px;
      border-radius: 6px; font-weight: 600; cursor: pointer;
    }

    /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .tile-loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(25, 118, 210, 0.9); color: white; padding: 1rem 1.5rem;
      border-radius: 50px; font-weight: 600; z-index: 5; display: flex; align-items: center;
    }

    /* --- 5. ì •ë³´ íŒ¨ë„ (1ì¤„ ì••ì¶• ìŠ¤íƒ€ì¼ ì ìš©) --- */
    .info-panel {
      width: 100%; max-width: 380px; background: #ffffff;
      padding: 1.25rem; overflow-y: auto; border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
    }
    .info-panel h2 {
      margin: 0 0 1rem 0; font-size: 1.1rem; color: #212121;
      border-bottom: 2px solid #1565c0; padding-bottom: 0.5rem;
    }

    /* 1ì¤„ ë§ì¤„ì„ ì²˜ë¦¬ (í•µì‹¬ CSS) */
    .truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }
    
    /* ì •ë³´ ë¸”ë¡ ìŠ¤íƒ€ì¼ ì••ì¶• */
    .analysis-section {
      margin-bottom: 0.8rem; padding: 0.6rem;
      border: 1px solid #e0e0e0; border-radius: 8px; background: #f9faff;
    }
    .analysis-section h4 {
      font-size: 0.9rem; font-weight: 700; margin: 0 0 0.3rem 0;
      border-bottom: 1px solid #eee; padding-bottom: 2px;
    }
    .analysis-section p {
      font-size: 0.85rem; line-height: 1.4; margin: 0; color: #424242;
    }
    
    /* ê·¸ë¦¬ë“œ */
    .route-info-grid, .safety-info-grid { display: grid; gap: 0.5rem; }
    .route-info-grid { grid-template-columns: 1fr 1fr; }
    .safety-info-grid { grid-template-columns: 1fr 1fr 1fr; }
    
    .info-block { background: #fff; border: 1px solid #e8e8e8; border-radius: 6px; padding: 0.5rem; }
    .info-block h5 { font-size: 0.75rem; color: #1565c0; margin: 0 0 0.2rem 0; }
    .info-block p { font-size: 0.9rem; font-weight: 600; }

    /* ê²€ìƒ‰ì°½ ë“± ê¸°íƒ€ UI */
    .search-container { display: flex; gap: 8px; margin-bottom: 1rem; }
    #searchInput { flex: 1; padding: 10px; border: 2px solid #1a237e; border-radius: 8px; }
    .search-btn { padding: 10px 15px; background: #1a237e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .search-results { max-height: 200px; overflow-y: auto; display: none; margin-bottom: 1rem; }
    .search-results.active { display: block; }
    .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .search-result-item:hover { background: #f5f5f5; }

    /* ìŠ¤í”¼ë„ˆ */
    .spinner {
      width: 1em; height: 1em; border: 2px solid currentColor;
      border-right-color: transparent; border-radius: 50%;
      display: inline-block; animation: spinner-spin 0.75s linear infinite;
      vertical-align: middle; margin-right: 5px;
    }
    @keyframes spinner-spin { to { transform: rotate(360deg); } }
    .loading { color: #9e9e9e; font-style: italic; }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: none;
      align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center;}
    .modal-button { background: #1565c0; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-top: 15px; cursor: pointer; }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .header { padding: 0.5rem; justify-content: flex-start; }
      .header p { display: none; }
      .info-panel { max-width: 100%; max-height: 45%; border-top: 2px solid #1565c0; }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" 
         alt="KCA ë¡œê³ " 
         onerror="this.style.display='none'; document.querySelector('.splash-fallback').style.display='block';">
    <div class="splash-fallback">KCA ë¶€ì‚°ë³¸ë¶€<br>í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</div>
  </div>

  <div class="container" id="app-container">
    <div class="header">
      <img src="https://www.kca.kr/home/www/images/main_2020/ft_logo.png" alt="KCA" class="header-logo" onerror="this.style.display='none'">
      <div class="header-content">
        <h1 id="appTitle">í•´ì–‘ ìŠ¤ë§ˆíŠ¸ ì¶œì¥ ì†”ë£¨ì…˜</h1>
        <p id="subtitle">KCA ë¶€ì‚°ë³¸ë¶€ í•­, í¬, êµ¬ ì¶œì¥ ì†”ë£¨ì…˜</p>
      </div>
    </div>

    <div class="main-content">
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>
        
        <div class="zoom-controls">
          <button class="map-control-btn" id="zoomIn">+</button>
          <button class="map-control-btn" id="zoomOut">âˆ’</button>
          <button class="map-control-btn" id="gpsBtn" title="ë‚´ ìœ„ì¹˜">ğŸ›°ï¸</button>
          <button class="map-control-btn" id="locationToggle" title="ì§€ì—­ ì„ íƒ">ğŸ“</button>
        </div>

        <div class="region-selector" id="regionSelector">
          <button class="region-btn" data-region="busan">ë¶€ì‚°</button>
          <button class="region-btn" data-region="ulsan">ìš¸ì‚°</button>
          <button class="region-btn" data-region="changwon">ì°½ì›</button>
          <button class="region-btn" data-region="tongyeong">í†µì˜</button>
          <button class="region-btn" data-region="geoje">ê±°ì œ</button>
          <button class="region-btn" data-region="namhae">ë‚¨í•´</button>
          <button class="region-btn" data-region="sacheon">ì‚¬ì²œ</button>
          <button class="region-btn" data-region="hadong">í•˜ë™</button>
          <button class="region-btn" data-region="goseong">ê³ ì„±</button>
          <button class="region-btn" data-region="all">ì „ì²´ë³´ê¸°</button>
        </div>

        <div class="tile-loading" id="tileLoading" style="display: none;">
            <span class="spinner"></span><span>ì§€ë„ ë¡œë”© ì¤‘...</span>
        </div>
      </div>
      
      <div class="info-panel" id="info-panel">
        <h2 id="aiAnalysisTitle">AI í•­, í¬, êµ¬ ë¶„ì„</h2>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="í•­í¬êµ¬ ê²€ìƒ‰...">
          <button id="searchBtn" class="search-btn">ğŸ”</button>
        </div>
        <div id="searchResults" class="search-results"></div>

        <div class="location-info" id="locationLabelWrapper">
            <p id="locationLabel" style="text-align:center; color:#666;"><strong>ì§€ë„ì—ì„œ ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</strong></p>
        </div>

        <div id="analysisContent" style="display: none;">
            <h3 id="selectedHarborName"></h3>
            <p id="harborAddress" style="font-size:0.85rem; color:#666; margin-bottom:10px;"></p>
            
            <div id="navButtons" style="display:flex; gap:10px; margin-bottom:15px;">
                <a id="tmapBtn" href="#" target="_blank" style="flex:1; background:#1565c0; color:white; padding:8px; text-align:center; border-radius:5px; text-decoration:none; font-size:0.9rem;">TMAP</a>
                <a id="naverBtn" href="#" target="_blank" style="flex:1; background:#03C75A; color:white; padding:8px; text-align:center; border-radius:5px; text-decoration:none; font-size:0.9rem;">ë„¤ì´ë²„</a>
            </div>

            <div class="analysis-section">
                <h4>í•µì‹¬ íŠ¹ì§•</h4>
                <p id="aiKeyFeatures" class="loading truncate"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
            </div>
            <div class="analysis-section">
                <h4>ì¢…í•© ì˜ê²¬</h4>
                <p id="aiOverallOpinion" class="loading truncate"><span class="spinner"></span> AI ë¶„ì„ ì¤‘...</p>
            </div>
            <div class="analysis-section">
                <h4>í˜„ì¥ ì¡°ì–¸</h4>
                <p id="aiFieldAdvice" class="truncate"></p>
            </div>

            <div class="analysis-section">
                <h4>AI ë§ì¶¤ ê²½ë¡œ & ì•ˆì „</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ì˜ˆìƒ ì‹œê°„</h5>
                        <p id="aiTravelTime" class="loading truncate"><span class="spinner"></span>...</p>
                    </div>
                    <div class="info-block">
                        <h5>êµí†µ ì£¼ì˜</h5>
                        <p id="aiPrecautions" class="loading truncate"><span class="spinner"></span>...</p>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h4>ì‹¤ì‹œê°„ í•´ìƒ ì •ë³´</h4>
                <div class="safety-info-grid">
                    <div class="info-block">
                        <h5>í’ì†/í’í–¥</h5>
                        <p id="safetyWind" class="loading truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>íŒŒê³ </h5>
                        <p id="safetyWave" class="loading truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ì¡°ë¥˜</h5>
                        <p id="safetyTide" class="loading truncate">...</p>
                    </div>
                </div>
            </div>
            
            <div class="analysis-section">
                <h4>ë¬¼ë•Œ</h4>
                <div class="route-info-grid">
                    <div class="info-block">
                        <h5>ë§Œì¡°</h5>
                        <p id="tideHighTime" class="loading truncate">...</p>
                    </div>
                    <div class="info-block">
                        <h5>ê°„ì¡°</h5>
                        <p id="tideLowTime" class="loading truncate">...</p>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
      <p id="modalMessage"></p>
      <button class="modal-button" id="modalClose">í™•ì¸</button>
    </div>
  </div>

<script>
// --- 1. API & ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
async function callGeminiAPI(prompt) {
  try {
    const response = await fetch('api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Gemini API failed');
    return data.result;
  } catch (error) {
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨', error);
    throw error;
  }
}

function extractJSON(text) {
  try {
    const s = text.indexOf('{');
    const e = text.lastIndexOf('}');
    if (s !== -1 && e !== -1) return JSON.parse(text.substring(s, e + 1));
    return JSON.parse(text);
  } catch (e) {
    throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨");
  }
}

// --- 2. ë°ì´í„° ë° ìƒíƒœ ë³€ìˆ˜ (ì›ë³¸ ë°ì´í„° ìœ ì§€) ---
const sampleHarbors = [ 
    {harbor: 'í•œí™”ì˜¤ì…˜', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œëŒ€ë¡œ 3370', lat: 34.869797, lon: 128.697627, advice: 'í†µì‹ ì‹¤ì¥ì—ê²Œ ë‚´ë°©ì¸ ì¶œì…ì‹ ì²­ í•„ìš”'},
    {harbor: 'ë‚´ê°„í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë‚´ê°„ë¦¬ 50-17', lat: 34.846273, lon: 128.567096, advice: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'},
    {harbor: 'ë²•ë™í•­', region: 'ê²½ë‚¨-ê±°ì œ', address: 'ê²½ìƒë‚¨ë„ ê±°ì œ ê±°ì œë©´ ë²•ë™ë¦¬ 1056-4', lat: 34.82242, lon: 128.519491, advice: 'ì†Œí˜•ì„ ë°• ì£¼ì˜'}
];
let allHarbors = sampleHarbors;
let selectedLocation = null;
let canvas, ctx;
let mapCenter = { lat: 35.5, lon: 128.8 };
let mapZoom = 8;
let markers = []; // ì¤‘ìš”: ë Œë”ë§ëœ ë§ˆì»¤ ì €ì¥ìš©
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let tileCache = {};
let loadingTiles = 0;
let userLocation = null;
let currentRegionFilter = 'all';
let pendingMapUpdate = null;
const TILE_SIZE = 256;
const OSM_TILE_URL = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';

const regionalMarkers = {
    'ë¶€ì‚°': { lat: 35.18, lon: 129.08, count: 0, regionKey: 'ë¶€ì‚°' },
    'ìš¸ì‚°': { lat: 35.53, lon: 129.35, count: 0, regionKey: 'ìš¸ì‚°' },
    'ê²½ë‚¨-ì°½ì›': { lat: 35.1978, lon: 128.5756, count: 0, regionKey: 'ê²½ë‚¨-ì°½ì›' },
    'ê²½ë‚¨-í†µì˜': { lat: 34.8442, lon: 128.4331, count: 0, regionKey: 'ê²½ë‚¨-í†µì˜' },
    'ê²½ë‚¨-ê±°ì œ': { lat: 34.8897, lon: 128.6997, count: 0, regionKey: 'ê²½ë‚¨-ê±°ì œ' },
    'ê²½ë‚¨-ë‚¨í•´': { lat: 34.83, lon: 127.89, count: 0, regionKey: 'ê²½ë‚¨-ë‚¨í•´' },
    'ê²½ë‚¨-ì‚¬ì²œ': { lat: 34.92, lon: 128.06, count: 0, regionKey: 'ê²½ë‚¨-ì‚¬ì²œ' },
    'ê²½ë‚¨-í•˜ë™': { lat: 34.94, lon: 127.87, count: 0, regionKey: 'ê²½ë‚¨-í•˜ë™' },
    'ê²½ë‚¨-ê³ ì„±': { lat: 34.97, lon: 128.32, count: 0, regionKey: 'ê²½ë‚¨-ê³ ì„±' }
};

// --- 3. ì§€ë„ í•µì‹¬ ë¡œì§ (ì¢Œí‘œë³€í™˜ ë° ê·¸ë¦¬ê¸°) ---
function initMap() {
  canvas = document.getElementById('mapCanvas');
  ctx = canvas.getContext('2d');
  window.addEventListener('resize', resizeCanvas);
  
  // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ (ì›ë³¸ ë¡œì§ ë³µêµ¬)
  canvas.addEventListener('mousedown', handleMouseDown);
  canvas.addEventListener('mousemove', handleMouseMove);
  canvas.addEventListener('mouseup', handleMouseUp);
  canvas.addEventListener('wheel', handleWheel);
  // (ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” ê°„ì†Œí™”ë¥¼ ìœ„í•´ ìƒëµí–ˆìœ¼ë‚˜ í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥)
}

function resizeCanvas() {
  const container = canvas.parentElement;
  if (container.clientWidth > 0) {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    drawMap();
  }
}

// ì¢Œí‘œ ë³€í™˜
function latLonToTile(lat, lon, zoom) {
  const x = Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
  const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
  return { x, y };
}
function tileToLatLon(x, y, zoom) {
  const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom);
  const lat = 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
  const lon = x / Math.pow(2, zoom) * 360 - 180;
  return { lat, lon };
}
function latLonToPixel(lat, lon) {
  const scale = Math.pow(2, mapZoom);
  const worldX = (lon + 180) / 360 * TILE_SIZE * scale;
  const worldY = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * TILE_SIZE * scale;
  const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
  const centerWorld = { x: centerTile.x * TILE_SIZE + TILE_SIZE / 2, y: centerTile.y * TILE_SIZE + TILE_SIZE / 2 };
  return { x: canvas.width / 2 + (worldX - centerWorld.x), y: canvas.height / 2 + (worldY - centerWorld.y) };
}

function loadTile(x, y, z) {
  const key = `${z}/${x}/${y}`;
  if (tileCache[key]) return tileCache[key];
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => { updateLoadingIndicator(); drawMap(); };
  img.src = OSM_TILE_URL.replace('{z}', z).replace('{x}', x).replace('{y}', y);
  tileCache[key] = img;
  return img;
}
function updateLoadingIndicator() { /* ìƒëµ ê°€ëŠ¥ */ }

// â˜…â˜…â˜… ì¤‘ìš”: ì§€ë„ ê·¸ë¦¬ê¸° (ë§ˆì»¤ ëª¨ì–‘ ë° í´ë¦­ ì˜ì—­ ë³µêµ¬) â˜…â˜…â˜…
function drawMap() {
  if (!ctx || canvas.width === 0) return;
  
  // 1. ë°°ê²½ ë° íƒ€ì¼ ê·¸ë¦¬ê¸°
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#aadaff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  const centerTile = latLonToTile(mapCenter.lat, mapCenter.lon, mapZoom);
  const tilesX = Math.ceil(canvas.width / TILE_SIZE) + 2;
  const tilesY = Math.ceil(canvas.height / TILE_SIZE) + 2;
  const startX = centerTile.x - Math.floor(tilesX / 2);
  const startY = centerTile.y - Math.floor(tilesY / 2);

  for (let i = 0; i < tilesX; i++) {
    for (let j = 0; j < tilesY; j++) {
      const tx = startX + i, ty = startY + j;
      const max = Math.pow(2, mapZoom);
      if (tx >= 0 && tx < max && ty >= 0 && ty < max) {
        const tile = loadTile(tx, ty, mapZoom);
        if (tile.complete && tile.naturalWidth > 0) {
          const tLatLon = tileToLatLon(tx, ty, mapZoom);
          const pos = latLonToPixel(tLatLon.lat, tLatLon.lon);
          ctx.drawImage(tile, pos.x, pos.y, TILE_SIZE, TILE_SIZE);
        }
      }
    }
  }

  // 2. ë§ˆì»¤ ë°ì´í„° ì¤€ë¹„
  markers = [];
  let locationsToShow = allHarbors; 
  // (í•„í„°ë§ ë¡œì§ì€ ê°„ì†Œí™”: ì¤Œ ë ˆë²¨ì´ ë‚®ìœ¼ë©´ ì§€ì—­ ë§ˆì»¤, ë†’ìœ¼ë©´ ê°œë³„ ë§ˆì»¤)
  
  locationsToShow.forEach(loc => {
      const pos = latLonToPixel(loc.lat, loc.lon);
      // í™”ë©´ ë°– ë§ˆì»¤ëŠ” ê·¸ë¦¬ì§€ ì•ŠìŒ
      if (pos.x > -50 && pos.x < canvas.width + 50 && pos.y > -50 && pos.y < canvas.height + 50) {
          markers.push({ ...loc, x: pos.x, y: pos.y });
      }
  });

  // 3. ë§ˆì»¤ ê·¸ë¦¬ê¸° (ë¬¼ë°©ìš¸ ëª¨ì–‘ ë³µêµ¬)
  markers.forEach(marker => {
      const pos = { x: marker.x, y: marker.y };
      const isSelected = selectedLocation && selectedLocation.harbor === marker.harbor;
      const markerSize = 14; // ê¸°ë³¸ í¬ê¸°
      const fillColor = isSelected ? '#ff5722' : '#1565c0'; // ì„ íƒë¨: ì£¼í™©, ê¸°ë³¸: íŒŒë‘

      // ê·¸ë¦¼ì
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 6;
      ctx.shadowOffsetY = 3;

      // í•€ ëª¨ì–‘ (ì› + ì‚¼ê°í˜•)
      ctx.beginPath();
      ctx.arc(pos.x, pos.y - markerSize * 1.2, markerSize, 0, Math.PI * 2); // ë¨¸ë¦¬
      ctx.fillStyle = fillColor;
      ctx.fill();
      
      ctx.beginPath();
      ctx.moveTo(pos.x - markerSize * 0.8, pos.y - markerSize * 0.9);
      ctx.lineTo(pos.x, pos.y); // ë¾°ì¡±í•œ ë
      ctx.lineTo(pos.x + markerSize * 0.8, pos.y - markerSize * 0.9);
      ctx.fillStyle = fillColor;
      ctx.fill();

      // ë‚´ë¶€ í° ì 
      ctx.shadowColor = 'transparent';
      ctx.beginPath();
      ctx.arc(pos.x, pos.y - markerSize * 1.2, markerSize * 0.4, 0, Math.PI * 2);
      ctx.fillStyle = '#ffffff';
      ctx.fill();

      // í…ìŠ¤íŠ¸ (ì„ íƒë˜ì—ˆê±°ë‚˜ ì¤Œì´ í´ ë•Œ)
      if (isSelected || mapZoom > 12) {
          ctx.font = 'bold 12px sans-serif';
          ctx.fillStyle = '#1a237e';
          ctx.textAlign = 'center';
          ctx.fillText(marker.harbor, pos.x, pos.y + 15);
      }
  });
}

// --- 4. ì¸í„°ë™ì…˜ í•¸ë“¤ëŸ¬ ---
function handleMouseDown(e) { isDragging = true; dragStart = { x: e.clientX, y: e.clientY }; }
function handleMouseMove(e) {
  if (!isDragging) return;
  const dx = e.clientX - dragStart.x;
  const dy = e.clientY - dragStart.y;
  // ê°„ë‹¨ ì´ë™ (ì •ë°€ë„ëŠ” ë–¨ì–´ì§€ì§€ë§Œ ê°€ë²¼ì›€)
  mapCenter.lon -= dx * 0.003 * (360 / Math.pow(2, mapZoom));
  mapCenter.lat += dy * 0.003 * (180 / Math.pow(2, mapZoom));
  dragStart = { x: e.clientX, y: e.clientY };
  drawMap();
}
function handleMouseUp(e) {
  if (isDragging) {
      const dx = Math.abs(e.clientX - dragStart.x);
      const dy = Math.abs(e.clientY - dragStart.y);
      if (dx < 5 && dy < 5) { // í´ë¦­ìœ¼ë¡œ ê°„ì£¼
          checkMarkerClick(e);
      }
  }
  isDragging = false;
}
function handleWheel(e) {
    e.preventDefault();
    if(e.deltaY < 0) mapZoom = Math.min(18, mapZoom + 1);
    else mapZoom = Math.max(5, mapZoom - 1);
    drawMap();
}

// â˜…â˜…â˜… ì¤‘ìš”: í´ë¦­ ê°ì§€ (íˆíŠ¸ë°•ìŠ¤) ë³µêµ¬ â˜…â˜…â˜…
function checkMarkerClick(e) {
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    let clickedMarker = null;

    // ì—­ìˆœìœ¼ë¡œ íƒìƒ‰ (ìœ„ì— ê·¸ë ¤ì§„ ë§ˆì»¤ë¶€í„°)
    for (let i = markers.length - 1; i >= 0; i--) {
        const m = markers[i];
        // ë§ˆì»¤ ì¤‘ì‹¬ë¶€ ëŒ€ëµì ì¸ ì˜ì—­ í™•ì¸
        const dist = Math.sqrt(Math.pow(clickX - m.x, 2) + Math.pow(clickY - (m.y - 15), 2));
        if (dist < 20) { // íˆíŠ¸ ë°˜ê²½ 20px
            clickedMarker = m;
            break;
        }
    }

    if (clickedMarker) {
        selectedLocation = clickedMarker;
        updateLocationInfo(clickedMarker);
        drawMap(); // ì„ íƒ ìƒíƒœ ë°˜ì˜ì„ ìœ„í•´ ë‹¤ì‹œ ê·¸ë¦¼
    }
}

// --- 5. AI ë¶„ì„ ë° UI ì—…ë°ì´íŠ¸ (1ì¤„ ìš”ì•½ ì ìš©) ---
async function getAnalysis(harbor) {
    // 1ì¤„ ìš”ì•½ ìš”ì²­ í”„ë¡¬í”„íŠ¸
    const prompt = `
    í•­êµ¬: ${harbor.harbor} (${harbor.address})
    ì—­í• : í•´ì–‘ ì•ˆì „ ì „ë¬¸ê°€.
    ìš”ì²­: ìœ„ í•­êµ¬ì— ëŒ€í•œ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ì‘ì„±í•˜ë˜, ëª¨ë“  ê°’ì€ 'ë°˜ë“œì‹œ 20ì ì´ë‚´ì˜ í•œ ë¬¸ì¥'ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš”.
    JSON í•„ë“œ:
    {
        "keyFeatures": "í•µì‹¬ íŠ¹ì§•(1ì¤„)",
        "overallOpinion": "ì¢…í•© ì˜ê²¬(1ì¤„)",
        "travelTime": "ì†Œìš”ì‹œê°„(ì˜ˆ: ì•½ 40ë¶„)",
        "precautions": "êµí†µ ì£¼ì˜ì‚¬í•­(1ì¤„)",
        "wind": "í’ì†(ê°„ë‹¨íˆ)",
        "wave": "íŒŒê³ (ê°„ë‹¨íˆ)",
        "tide": "ì¡°ë¥˜(ê°„ë‹¨íˆ)",
        "highTide": "ë§Œì¡°ì‹œê°„",
        "lowTide": "ê°„ì¡°ì‹œê°„"
    }`;

    try {
        const text = await callGeminiAPI(prompt);
        const data = extractJSON(text);
        
        // ë°ì´í„° ì ìš©
        document.getElementById('aiKeyFeatures').textContent = data.keyFeatures;
        document.getElementById('aiOverallOpinion').textContent = data.overallOpinion;
        document.getElementById('aiTravelTime').textContent = data.travelTime;
        document.getElementById('aiPrecautions').textContent = data.precautions;
        document.getElementById('safetyWind').textContent = data.wind;
        document.getElementById('safetyWave').textContent = data.wave;
        document.getElementById('safetyTide').textContent = data.tide;
        document.getElementById('tideHighTime').textContent = data.highTide || '-';
        document.getElementById('tideLowTime').textContent = data.lowTide || '-';
        
        // ë¡œë”© í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
        
    } catch (e) {
        console.error(e);
        document.getElementById('aiKeyFeatures').textContent = "ì •ë³´ ë¡œë“œ ì‹¤íŒ¨";
    }
}

function updateLocationInfo(location) {
    document.getElementById('locationLabelWrapper').style.display = 'none';
    document.getElementById('analysisContent').style.display = 'block';
    
    document.getElementById('selectedHarborName').textContent = location.harbor;
    document.getElementById('harborAddress').textContent = location.address;
    document.getElementById('aiFieldAdvice').textContent = location.advice || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ';

    // TMAP/ë„¤ì´ë²„ ë§í¬ ì—…ë°ì´íŠ¸
    const eName = encodeURIComponent(location.harbor);
    document.getElementById('tmapBtn').href = `tmap://route?goalname=${eName}&goaly=${location.lat}&goalx=${location.lon}`;
    document.getElementById('naverBtn').href = `nmap://route/public?dlat=${location.lat}&dlng=${location.lon}&dname=${eName}&appname=com.example.myapp`;

    // ë¡œë”© ìƒíƒœ ë¦¬ì…‹
    ['aiKeyFeatures', 'aiOverallOpinion', 'aiTravelTime', 'aiPrecautions', 'safetyWind', 'safetyWave', 'safetyTide'].forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
        el.classList.add('loading');
    });

    getAnalysis(location);
}

// --- 6. ì´ˆê¸°í™” ---
window.addEventListener('load', () => {
    const splash = document.getElementById('splash-screen');
    const app = document.getElementById('app-container');

    setTimeout(() => {
        splash.classList.add('hidden');
        app.style.display = 'flex';
        
        // ì§€ë„ê°€ í‘œì‹œëœ ì§í›„ ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆë¥¼ ì¡ì•„ì•¼ í•¨
        requestAnimationFrame(() => {
            initMap();
            resizeCanvas();
            // ìŠ¤í”Œë˜ì‹œ DOM ì œê±°
            setTimeout(() => { if(splash.parentNode) splash.parentNode.removeChild(splash); }, 500);
        });
    }, 2000);
});

// ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
document.getElementById('zoomIn').addEventListener('click', () => { mapZoom++; drawMap(); });
document.getElementById('zoomOut').addEventListener('click', () => { mapZoom--; drawMap(); });
document.getElementById('searchBtn').addEventListener('click', () => {
    const val = document.getElementById('searchInput').value;
    const found = allHarbors.find(h => h.harbor.includes(val));
    if(found) {
        mapCenter = { lat: found.lat, lon: found.lon };
        mapZoom = 14;
        drawMap();
        // ì•½ê°„ì˜ ì§€ì—° í›„ ë§ˆì»¤ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜
        setTimeout(() => { selectedLocation = found; updateLocationInfo(found); drawMap(); }, 100);
    } else {
        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
});

</script>
</body>
</html>
